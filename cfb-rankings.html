<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Football Top 25 Rankings</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .header h1 {
            color: #1a237e;
            margin-bottom: 10px;
        }
        .last-updated {
            color: #666;
            font-style: italic;
        }
        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .rankings-table th, 
        .rankings-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .rankings-table th {
            background-color: #1a237e;
            color: white;
        }
        .rankings-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .rankings-table tr:hover {
            background-color: #e8eaf6;
        }
        .rank {
            font-weight: bold;
            color: #1a237e;
            width: 60px;
        }
        .team {
            font-weight: 500;
        }
        .points {
            width: 100px;
            text-align: center;
        }
        .record {
            width: 100px;
            text-align: center;
        }
        .conference {
            width: 120px;
            text-align: center;
            color: #555;
        }
        .quality-wins {
            font-size: 0.9em;
            color: #666;
        }
        .movement {
            width: 80px;
            text-align: center;
        }
        .up {
            color: #4caf50;
        }
        .down {
            color: #f44336;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .legend h3, .legend h4 {
            margin-top: 0;
            color: #1a237e;
        }
        .legend h4 {
            margin-top: 20px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        .point-criteria ul {
            list-style-type: none;
            padding-left: 0;
        }
        .point-criteria li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        .point-criteria li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #1a237e;
        }
        .point-criteria .example {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8eaf6;
            border-radius: 4px;
            border-left: 4px solid #1a237e;
        }
        .refresh-time {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>College Football Top 25 Rankings</h1>
            <p class="last-updated">Last Updated: <span id="update-time"></span></p>
        </div>

        <table class="rankings-table" id="rankings">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Team</th>
                    <th>Record</th>
                    <th>Points</th>
                    <th>Movement</th>
                </tr>
            </thead>
            <tbody id="rankings-body">
                <!-- Rankings will be populated here by JavaScript -->
            </tbody>
        </table>

        <div class="legend">
            <h3>Point System</h3>
            <p>Our rankings are calculated using the following criteria:</p>
            <div class="point-criteria">
                <h4>Base Points for Wins</h4>
                <ul>
                    <li><strong>12 points:</strong> Win over Power 4 team (Big 10, Big 12, SEC, ACC)</li>
                    <li><strong>6 points:</strong> Win over Group of 5 team (Other FBS teams)</li>
                    <li><strong>3 points:</strong> Win over FCS team</li>
                </ul>
                
                <h4>Bonus Points</h4>
                <ul>
                    <li><strong>+1 point:</strong> For each win by defeated opponents</li>
                    <li><strong>+1 point:</strong> For defeating a team ranked in the Top 25</li>
                    <li><strong>+1 point:</strong> For winning an away game</li>
                    <li><strong>+1 point:</strong> For scoring 50+ points in a game</li>
                    <li><strong>+1 point:</strong> For a shutout (0 points allowed)</li>
                </ul>
                
                <p class="example">
                    <strong>Example:</strong> Defeating a ranked Power 4 team with 6 wins in an away game while scoring 50 points and getting a shutout would earn:
                    12 (Power 4) + 6 (opponent wins) + 1 (ranked) + 1 (away) + 1 (50+ points) + 1 (shutout) = 22 points
                </p>
            </div>
        </div>

        <p class="refresh-time">Rankings automatically update every 60 minutes</p>
    </div>

    <script>
        // Store previous rankings to calculate movement
        let previousRankings = new Map();
        let updateInProgress = false;

        // Function to show loading state
        function showLoading() {
            const tbody = document.getElementById('rankings-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        Loading rankings... This may take a few minutes for the first load.
                    </td>
                </tr>
            `;
        }

        // Helper function to get conference display name
        function getConferenceDisplay(conference) {
            const conferenceNames = {
                'ACC': 'ACC',
                'SEC': 'SEC',
                'Big Ten': 'Big Ten',
                'Big 12': 'Big 12',
                'American': 'American',
                'Conference USA': 'C-USA',
                'MAC': 'MAC',
                'Mountain West': 'MWC',
                'Sun Belt': 'Sun Belt',
                'Independents': 'Independent'
            };
            return conferenceNames[conference] || conference;
        }

        // Function to format the team name and details
        function formatTeamDisplay(team) {
            const rankStr = team.rank ? `#${team.rank}` : '';
            const confStr = getConferenceDisplay(team.conference);
            const record = team.wins + '-' + team.losses;
            const points = team.points.toLocaleString();
            const qualityWins = team.qualityWins || [];
            
            return `
                <tr>
                    <td class="rank">${rankStr}</td>
                    <td class="team">${team.name}</td>
                    <td class="conference">${confStr}</td>
                    <td class="record">${record}</td>
                    <td class="points">${points}</td>
                    <td class="quality-wins">${qualityWins.join(', ')}</td>
                </tr>
            `;
        }

        // Function to show error state
        function showError(error) {
            const tbody = document.getElementById('rankings-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #f44336;">
                        Error loading rankings: ${error}
                        <br><br>
                        <button onclick="updateRankings(true)">Try Again</button>
                    </td>
                </tr>
            `;
        }

        // Function to update rankings
        async function updateRankings(force = false) {
            if (updateInProgress && !force) {
                console.log('Update already in progress, skipping...');
                return;
            }

            updateInProgress = true;
            showLoading();

            try {
                // First try to update the rankings from CBS
                await fetch('/api/update-rankings').catch(error => {
                    console.log('Update failed, using cached data:', error);
                });

                // Then fetch the latest rankings
                const response = await fetch('/api/rankings', {
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Sort teams by points
                const sortedTeams = data.teams.sort((a, b) => b.points - a.points);
                
                // Update table
                const tbody = document.getElementById('rankings-body');
                tbody.innerHTML = '';
                
                sortedTeams.slice(0, 25).forEach((team, index) => {
                    const row = document.createElement('tr');
                    const previousRank = previousRankings.get(team.name) || index + 1;
                    const movement = previousRank - (index + 1);
                    
                    row.innerHTML = `
                        <td class="rank">${index + 1}</td>
                        <td class="team">${team.name} (${team.conference || 'Unknown'})</td>
                        <td class="record">${team.record}</td>
                        <td class="points">${team.points}
                            ${team.awayWins ? `<br><small>Away Wins: ${team.awayWins}</small>` : ''}
                            ${team.shutouts ? `<br><small>Shutouts: ${team.shutouts}</small>` : ''}
                            ${team['50+PointWins'] ? `<br><small>50+ Point Wins: ${team['50+PointWins']}</small>` : ''}
                        </td>
                        <td class="movement ${movement > 0 ? 'up' : movement < 0 ? 'down' : ''}">
                            ${movement > 0 ? 'â–²' + movement : movement < 0 ? 'â–¼' + Math.abs(movement) : '-'}
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // Store current ranking for next update
                    previousRankings.set(team.name, index + 1);
                });
                
                // Update last updated time
                const lastUpdated = new Date(data.lastUpdated || Date.now());
                document.getElementById('update-time').textContent = lastUpdated.toLocaleString();
            } catch (error) {
                console.error('Error updating rankings:', error);
                showError(error.message);
            } finally {
                updateInProgress = false;
            }
        }

        // Update rankings initially and then every 60 minutes
        updateRankings();
        setInterval(() => updateRankings(), 60 * 60 * 1000);
    </script>
</body>
</html>