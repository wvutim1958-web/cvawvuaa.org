class NewsletterGenerator{constructor(){this.newsletters=this.loadNewsletters(),this.templates=this.getTemplates(),this.init()}async init(){await this.loadContentData(),this.setupEventListeners()}async loadContentData(){this.contentData={events:[],news:[],boardMembers:[],newsletters:[]};try{const e=await fetch("/events/events.json",{cache:"no-store"});e.ok&&(this.contentData.events=await e.json());const t=await fetch("/news/posts.json",{cache:"no-store"});t.ok&&(this.contentData.news=await t.json());const n=await fetch("/content/board-members.json",{cache:"no-store"});n.ok&&(this.contentData.boardMembers=await n.json());const a=await fetch("/newsletters/posts.json",{cache:"no-store"});a.ok&&(this.contentData.newsletters=await a.json())}catch(e){console.warn("Error loading content data:",e)}}loadNewsletters(){const e=localStorage.getItem("cvcwvuaa-newsletters");return e?JSON.parse(e):[]}saveNewsletters(){localStorage.setItem("cvcwvuaa-newsletters",JSON.stringify(this.newsletters))}getTemplates(){return{monthly:{name:"Monthly Newsletter",sections:["greeting","upcoming-events","recent-events","news","spotlight","footer"]},events:{name:"Event Announcement",sections:["greeting","featured-event","upcoming-events","rsvp-call","footer"]},news:{name:"News Update",sections:["greeting","news","upcoming-events","footer"]},quarterly:{name:"Quarterly Report",sections:["greeting","quarter-summary","events-recap","financials","spotlight","upcoming","footer"]}}}generateNewsletter(e,t={}){const n=this.templates[e];if(!n)throw new Error("Invalid template type");const a={id:this.generateNewsletterID(),title:t.title||`CVCWVUAA Newsletter - ${(new Date).toLocaleDateString("en-US",{month:"long",year:"numeric"})}`,type:e,date:(new Date).toISOString(),sections:{},htmlContent:"",emailContent:"",settings:{includeImages:!1!==t.includeImages,includeSocialLinks:!1!==t.includeSocialLinks,maxEventCount:t.maxEventCount||5,maxNewsCount:t.maxNewsCount||3}};return n.sections.forEach(e=>{a.sections[e]=this.generateSection(e,t)}),a.htmlContent=this.compileHTML(a),a.emailContent=this.compileEmailHTML(a),a}generateSection(e,t={}){const n=new Date,a=new Date(n.getTime()-2592e6),o=new Date(n.getTime()+2592e6);switch(e){case"greeting":return{type:"greeting",content:"\n            <h2>Mountaineer Greetings!</h2>\n            <p>Welcome to the latest news from the Central Virginia Chapter of the WVU Alumni Association. We're excited to share updates on our recent activities and upcoming events.</p>\n          "};case"upcoming-events":const i=this.contentData.events.filter(e=>{const t=new Date(e.date);return t>=n&&t<=o}).sort((e,t)=>new Date(e.date)-new Date(t.date)).slice(0,t.maxEventCount||5);return{type:"upcoming-events",title:"Upcoming Events",events:i,content:this.renderEventsSection(i,"upcoming")};case"recent-events":const r=this.contentData.events.filter(e=>{const t=new Date(e.date);return t<=n&&t>=a}).sort((e,t)=>new Date(t.date)-new Date(e.date)).slice(0,3);return{type:"recent-events",title:"Recent Events Recap",events:r,content:this.renderEventsSection(r,"recent")};case"news":const s=this.contentData.news.filter(e=>new Date(e.date)>=a).sort((e,t)=>new Date(t.date)-new Date(e.date)).slice(0,t.maxNewsCount||3);return{type:"news",title:"Chapter News & Updates",posts:s,content:this.renderNewsSection(s)};case"spotlight":const c=this.getRandomBoardMember();return{type:"spotlight",title:"Board Member Spotlight",member:c,content:this.renderSpotlightSection(c)};case"featured-event":const l=this.contentData.events.filter(e=>new Date(e.date)>=n).sort((e,t)=>new Date(e.date)-new Date(t.date))[0];return{type:"featured-event",title:"Featured Event",event:l,content:this.renderFeaturedEventSection(l)};case"rsvp-call":return{type:"rsvp-call",content:'\n            <div style="background: #003366; color: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">\n              <h3>Don\'t Miss Out!</h3>\n              <p>RSVP for our upcoming events to secure your spot and help us plan accordingly.</p>\n              <a href="https://cvawvuaa.org/events.html" style="background: #FFD700; color: #003366; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">View All Events</a>\n            </div>\n          '};case"footer":return{type:"footer",content:`\n            <hr style="margin: 30px 0; border: none; border-top: 2px solid #FFD700;">\n            <div style="text-align: center; color: #666; font-size: 14px;">\n              <p><strong>Central Virginia Chapter of WVU Alumni Association</strong></p>\n              <p>Stay connected to Mountaineer Nation in Central Virginia</p>\n              <p>\n                <a href="https://cvawvuaa.org">Visit Our Website</a> | \n                <a href="https://cvawvuaa.org/contact.html">Contact Us</a> | \n                <a href="https://cvawvuaa.org/pay.html">Become a Member</a>\n              </p>\n              <p style="font-size: 12px; margin-top: 20px;">\n                This newsletter was automatically generated on ${(new Date).toLocaleDateString()}\n              </p>\n            </div>\n          `};default:return{type:e,content:""}}}renderEventsSection(e,t){if(!e||0===e.length)return`<p><em>No ${t} events to display.</em></p>`;return`<div>${e.map(e=>{const n=new Date(e.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),a=e.time?` at ${e.time}`:"";return`\n        <div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid #FFD700; background: #f8f9fa;">\n          <h4 style="margin: 0 0 8px 0; color: #003366;">${e.title}</h4>\n          <p style="margin: 0 0 8px 0; font-weight: bold;">${n}${a}</p>\n          ${e.location?`<p style="margin: 0 0 8px 0;"><strong>Location:</strong> ${e.location}</p>`:""}\n          ${e.description?`<p style="margin: 0;">${e.description}</p>`:""}\n          ${"upcoming"===t?`<p style="margin: 8px 0 0 0;"><a href="https://cvawvuaa.org/events/rsvp.html?event=${e.slug}">RSVP Here</a></p>`:""}\n        </div>\n      `}).join("")}</div>`}renderNewsSection(e){if(!e||0===e.length)return"<p><em>No recent news to display.</em></p>";return`<div>${e.map(e=>`\n      <div style="margin-bottom: 15px;">\n        <h4 style="margin: 0 0 5px 0;"><a href="https://cvawvuaa.org/news/posts/${e.slug}.html">${e.title}</a></h4>\n        <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${new Date(e.date).toLocaleDateString()}</p>\n        <p style="margin: 0;">${e.excerpt||e.summary||"Read more on our website."}</p>\n      </div>\n    `).join("")}</div>`}renderSpotlightSection(e){return e?`\n      <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">\n        <h4 style="margin: 0 0 10px 0; color: #003366;">Spotlight: ${e.name}</h4>\n        <p style="margin: 0 0 8px 0;"><strong>Position:</strong> ${e.position}</p>\n        ${e.degree?`<p style="margin: 0 0 8px 0;"><strong>Degree:</strong> ${e.degree}</p>`:""}\n        <p style="margin: 0;">Thank you to ${e.name} for their dedicated service to our chapter!</p>\n      </div>\n    `:"<p><em>No board member information available.</em></p>"}renderFeaturedEventSection(e){if(!e)return"<p><em>No featured event available.</em></p>";const t=new Date(e.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});return`\n      <div style="background: linear-gradient(135deg, #003366, #0066cc); color: white; padding: 25px; border-radius: 12px; text-align: center;">\n        <h3 style="margin: 0 0 15px 0; font-size: 24px;">${e.title}</h3>\n        <p style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold;">${t}</p>\n        ${e.time?`<p style="margin: 0 0 10px 0;">‚è∞ ${e.time}</p>`:""}\n        ${e.location?`<p style="margin: 0 0 15px 0;">üìç ${e.location}</p>`:""}\n        ${e.description?`<p style="margin: 0 0 20px 0;">${e.description}</p>`:""}\n        <a href="https://cvawvuaa.org/events/rsvp.html?event=${e.slug}" style="background: #FFD700; color: #003366; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;">RSVP Now</a>\n      </div>\n    `}getRandomBoardMember(){if(!this.contentData.boardMembers||0===this.contentData.boardMembers.length)return null;const e=Math.floor(Math.random()*this.contentData.boardMembers.length);return this.contentData.boardMembers[e]}compileHTML(e){const t=e.sections;let n=`\n      <!DOCTYPE html>\n      <html lang="en">\n      <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>${e.title}</title>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }\n          h1, h2, h3, h4 { color: #003366; }\n          a { color: #0066cc; }\n          .header { background: #003366; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 30px; }\n          .section { margin-bottom: 30px; }\n        </style>\n      </head>\n      <body>\n        <div class="header">\n          <h1 style="margin: 0; color: white;">${e.title}</h1>\n          <p style="margin: 10px 0 0 0; color: #FFD700;">${new Date(e.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p>\n        </div>\n    `;return Object.values(t).forEach(e=>{e.content&&(n+=`\n          <div class="section">\n            ${e.title?`<h3>${e.title}</h3>`:""}\n            ${e.content}\n          </div>\n        `)}),n+="\n      </body>\n      </html>\n    ",n}compileEmailHTML(e){const t=e.sections;let n=`\n      <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto;">\n        <div style="background: #003366; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 30px;">\n          <h1 style="margin: 0; color: white; font-size: 24px;">${e.title}</h1>\n          <p style="margin: 10px 0 0 0; color: #FFD700;">${new Date(e.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p>\n        </div>\n    `;return Object.values(t).forEach(e=>{e.content&&(n+=`\n          <div style="margin-bottom: 30px;">\n            ${e.title?`<h3 style="color: #003366; margin-bottom: 15px;">${e.title}</h3>`:""}\n            ${e.content}\n          </div>\n        `)}),n+="</div>",n}generateNewsletterID(){return"newsletter_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}saveNewsletter(e){return this.newsletters.unshift(e),this.saveNewsletters(),e.id}getNewsletters(){return this.newsletters}deleteNewsletter(e){this.newsletters=this.newsletters.filter(t=>t.id!==e),this.saveNewsletters()}exportNewsletterHTML(e){const t=new Blob([e.htmlContent],{type:"text/html"}),n=window.URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`newsletter_${e.id.slice(-8)}_${new Date(e.date).toISOString().split("T")[0]}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(n)}copyEmailHTML(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e.emailContent).then(()=>{this.showNotification("üìß Email HTML copied to clipboard!","success")}).catch(t=>{console.error("Clipboard error:",t),this.fallbackCopyToClipboard(e.emailContent)}):this.fallbackCopyToClipboard(e.emailContent)}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showNotification("üìß Email HTML copied to clipboard!","success")}catch(e){this.showNotification("‚ùå Could not copy to clipboard","error")}document.body.removeChild(t)}setupEventListeners(){}async sendToMailchimp(e,t={}){if(!window.mailchimpIntegration)throw new Error("Mailchimp integration not configured");try{const n={subject:e.subject,html:e.html,autoSend:t.autoSend||!1},a=await window.mailchimpIntegration.sendNewsletterViMailchimp(n);return e.mailchimpCampaignId=a.id,this.saveNewsletters(),this.showNotification(`Newsletter sent to Mailchimp: ${e.subject}`,"success"),a}catch(e){throw this.showNotification(`Failed to send to Mailchimp: ${e.message}`,"error"),e}}async createMailchimpCampaign(e){if(!window.mailchimpIntegration)throw new Error("Mailchimp integration not configured");try{const t=await window.mailchimpIntegration.createCampaign(e.subject,e.html,{title:`CVCWVUAA Newsletter - ${new Date(e.date).toLocaleDateString()}`,fromName:"CVCWVUAA Newsletter",replyTo:"newsletter@cvawvuaa.org"});return e.mailchimpCampaignId=t.id,e.mailchimpStatus="draft",this.saveNewsletters(),this.showNotification(`Mailchimp campaign created: ${e.subject}`,"success"),t}catch(e){throw this.showNotification(`Failed to create Mailchimp campaign: ${e.message}`,"error"),e}}async sendMailchimpCampaign(e){if(!e.mailchimpCampaignId)throw new Error("No Mailchimp campaign associated with this newsletter");try{await window.mailchimpIntegration.sendCampaign(e.mailchimpCampaignId),e.mailchimpStatus="sent",e.sentDate=(new Date).toISOString(),this.saveNewsletters(),this.showNotification(`Newsletter sent via Mailchimp: ${e.subject}`,"success")}catch(e){throw this.showNotification(`Failed to send via Mailchimp: ${e.message}`,"error"),e}}showNotification(e,t="info"){const n=document.createElement("div");n.style.cssText=`\n      position: fixed; top: 20px; right: 20px; z-index: 1000;\n      padding: 12px 20px; border-radius: 8px; color: white;\n      background: ${"success"===t?"#28a745":"error"===t?"#dc3545":"#007bff"};\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      max-width: 300px; animation: slideInRight 0.3s ease;\n    `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{n.parentNode&&document.body.removeChild(n)},300)},4e3)}}const newsletterGenerator=new NewsletterGenerator;window.newsletterGenerator=newsletterGenerator;