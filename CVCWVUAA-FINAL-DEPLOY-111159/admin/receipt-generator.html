<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVCWVUAA Receipt Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #003366;
            margin-bottom: 30px;
            border-bottom: 3px solid #FFD700;
            padding-bottom: 20px;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .payment-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #FFD700;
        }
        
        .payment-section h3 {
            color: #003366;
            margin-top: 0;
        }
        
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .total-display {
            background: #003366;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .btn {
            background: #003366;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #004080;
        }
        
        .btn-secondary {
            background: #FFD700;
            color: #003366;
        }
        
        .btn-secondary:hover {
            background: #FFC107;
        }
        
        .member-search {
            margin-bottom: 20px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-result-item:hover {
            background-color: #f0f8ff;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #FFD700;
        }
        
        .preview-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CVCWVUAA Receipt Generator</h1>
            <p>Generate professional receipts for member payments</p>
        </div>
        
        <div class="member-search">
            <h3>Find Member</h3>
            <div class="form-group">
                <label for="memberSearch">Search by name, email, or phone:</label>
                <input type="text" id="memberSearch" placeholder="Start typing to search members..." oninput="searchMembers()">
            </div>
            <div class="search-results" id="searchResults" style="display: none;"></div>
            <button class="btn btn-secondary" onclick="clearMemberSearch()">Clear Search</button>
            <button class="btn btn-secondary" onclick="debugMembers()">Debug Members</button>
        </div>
        
        <div class="form-section">
            <div>
                <h3 style="color: #003366;">Member Information</h3>
                <div class="form-group">
                    <label for="memberName">Full Name *</label>
                    <input type="text" id="memberName" required>
                </div>
                <div class="form-group">
                    <label for="memberEmail">Email Address</label>
                    <input type="email" id="memberEmail">
                </div>
                <div class="form-group">
                    <label for="memberPhone">Phone Number</label>
                    <input type="tel" id="memberPhone">
                </div>
                <div class="form-group">
                    <label for="memberAddress">Mailing Address</label>
                    <textarea id="memberAddress" placeholder="Street Address, City, State, ZIP"></textarea>
                </div>
                <div class="form-group">
                    <label for="memberSince">Member Since</label>
                    <input type="text" id="memberSince" placeholder="e.g., January 2024">
                </div>
            </div>
            
            <div>
                <h3 style="color: #003366;">Receipt Details</h3>
                <div class="form-group">
                    <label for="paymentDate">Payment Date *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod">
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Check">Check</option>
                        <option value="Cash">Cash</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionId">Transaction/Check Number</label>
                    <input type="text" id="transactionId" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="processedBy">Processed By</label>
                    <input type="text" id="processedBy" value="CVCWVUAA Admin">
                </div>
            </div>
        </div>
        
        <div class="payment-section">
            <h3>Payment Breakdown</h3>
            <div class="payment-grid">
                <div class="form-group">
                    <label for="membershipAmount">Annual Membership ($)</label>
                    <input type="number" id="membershipAmount" step="0.01" min="0" value="0.00" oninput="calculateTotal()">
                </div>
                <div class="form-group">
                    <label for="eventAmount">Event Registration ($)</label>
                    <input type="number" id="eventAmount" step="0.01" min="0" value="0.00" oninput="calculateTotal()">
                </div>
                <div class="form-group">
                    <label for="donationAmount">Additional Donation ($)</label>
                    <input type="number" id="donationAmount" step="0.01" min="0" value="0.00" oninput="calculateTotal()">
                </div>
                <div class="form-group">
                    <label for="otherAmount">Other Fees ($)</label>
                    <input type="number" id="otherAmount" step="0.01" min="0" value="0.00" oninput="calculateTotal()">
                </div>
            </div>
            
            <div class="total-display" id="totalDisplay">
                Total: $0.00
            </div>
        </div>
        
        <div class="preview-notice">
            <strong>Note:</strong> Click "Generate Receipt" to create a receipt that you can print or email to the member.
        </div>
        
        <div class="actions">
            <button class="btn" onclick="generateReceipt()">üìÑ Generate Receipt</button>
            <button class="btn btn-secondary" onclick="saveToMembers()">üíæ Save to Member Records</button>
            <button class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
        </div>
    </div>

    <script>
        // Initialize
        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        
        // Load members from localStorage
        function getMembers() {
            console.log('Searching for members in localStorage...');
            const memberKeys = ['cvcwvuaa-members', 'cvcwvuaa_members', 'members', 'memberData'];
            
            for (const key of memberKeys) {
                const data = localStorage.getItem(key);
                console.log(`Checking key '${key}':`, data ? 'Found data' : 'No data');
                
                if (data) {
                    try {
                        const members = JSON.parse(data);
                        if (Array.isArray(members) && members.length > 0) {
                            console.log(`‚úÖ Found ${members.length} members in localStorage key: ${key}`);
                            console.log('Sample member:', members[0]);
                            return members;
                        }
                    } catch (e) {
                        console.error(`Error parsing data from key ${key}:`, e);
                    }
                }
            }
            console.log('‚ùå No members found in localStorage');
            console.log('Available localStorage keys:', Object.keys(localStorage));
            return [];
        }
        
        function searchMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const members = getMembers();
            const filtered = members.filter(member => {
                const name = (member.name || member.firstName + ' ' + member.lastName || '').toLowerCase();
                const email = (member.email || '').toLowerCase();
                const phone = (member.phone || '').toLowerCase();
                
                return name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm);
            });
            
            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map((member, index) => {
                    const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim();
                    const email = member.email || 'No email';
                    const phone = member.phone || 'No phone';
                    
                    // Use email as unique identifier, or create one if needed
                    const memberId = member.email || `member_${index}_${Date.now()}`;
                    
                    return `
                        <div class="search-result-item" onclick="selectMember('${memberId}')" style="cursor: pointer; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; background: #f9f9f9;">
                            <strong style="color: #003366;">${name}</strong><br>
                            Email: ${email}<br>
                            Phone: ${phone}
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Click to select this member</div>
                        </div>
                    `;
                }).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="search-result-item">No members found</div>';
                resultsDiv.style.display = 'block';
            }
        }
        
        function selectMember(memberId) {
            console.log('Selecting member with ID:', memberId);
            const members = getMembers();
            console.log('Available members:', members);
            
            // Try multiple ways to find the member
            let member = members.find(m => 
                m.id == memberId || 
                m.email === memberId || 
                m.firstName + ' ' + m.lastName === memberId ||
                (m.firstName + ' ' + m.lastName).toLowerCase() === memberId.toLowerCase()
            );
            
            console.log('Found member:', member);
            
            if (member) {
                const memberName = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim();
                document.getElementById('memberName').value = memberName;
                document.getElementById('memberEmail').value = member.email || '';
                document.getElementById('memberPhone').value = member.phone || '';
                
                // Build address from components, filtering out empty values
                const addressComponents = [
                    member.address, 
                    member.streetAddress, 
                    member.city, 
                    member.state, 
                    member.zip
                ].filter(x => x && x.trim() && x !== member.lastName);
                
                const address = addressComponents.join(', ');
                document.getElementById('memberAddress').value = address || '';
                
                document.getElementById('memberSince').value = member.memberSince || member.joinDate || 'Not available';
                
                // Clear search and show success
                clearMemberSearch();
                
                // Visual feedback
                const nameField = document.getElementById('memberName');
                nameField.style.backgroundColor = '#e6ffe6';
                setTimeout(() => nameField.style.backgroundColor = '', 1000);
                
                console.log('Member selected successfully:', memberName);
            } else {
                console.error('Member not found with ID:', memberId);
                alert('Member not found. Please try searching again.');
            }
        }
        
        function clearMemberSearch() {
            document.getElementById('memberSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }
        
        function debugMembers() {
            const members = getMembers();
            console.log('=== MEMBER DEBUG INFO ===');
            console.log('Total members found:', members.length);
            
            if (members.length > 0) {
                console.log('First 3 members:', members.slice(0, 3));
                alert(`Found ${members.length} members in database. Check console for details.`);
            } else {
                console.log('Available localStorage keys:', Object.keys(localStorage));
                alert('No members found! Check console for localStorage debug info.');
            }
        }
        
        function calculateTotal() {
            const membership = parseFloat(document.getElementById('membershipAmount').value) || 0;
            const event = parseFloat(document.getElementById('eventAmount').value) || 0;
            const donation = parseFloat(document.getElementById('donationAmount').value) || 0;
            const other = parseFloat(document.getElementById('otherAmount').value) || 0;
            
            const total = membership + event + donation + other;
            document.getElementById('totalDisplay').textContent = `Total: $${total.toFixed(2)}`;
        }
        
        function generateReceiptNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const timestamp = Date.now().toString().slice(-6);
            return `CVCWV-${year}-${timestamp}`;
        }
        
        function generateReceipt() {
            // Validate required fields
            const memberName = document.getElementById('memberName').value.trim();
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (!memberName) {
                alert('Please enter the member name');
                return;
            }
            
            if (!paymentDate) {
                alert('Please select the payment date');
                return;
            }
            
            // Calculate total
            calculateTotal();
            const totalText = document.getElementById('totalDisplay').textContent;
            const totalAmount = parseFloat(totalText.replace('Total: $', ''));
            
            if (totalAmount <= 0) {
                alert('Please enter payment amounts greater than $0.00');
                return;
            }
            
            // Prepare receipt data
            const memberData = {
                name: memberName,
                email: document.getElementById('memberEmail').value,
                phone: document.getElementById('memberPhone').value,
                address: document.getElementById('memberAddress').value,
                memberSince: document.getElementById('memberSince').value
            };
            
            const paymentData = {
                receiptNumber: generateReceiptNumber(),
                date: new Date(paymentDate).toLocaleDateString(),
                method: document.getElementById('paymentMethod').value,
                transactionId: document.getElementById('transactionId').value || 'N/A',
                processedBy: document.getElementById('processedBy').value,
                membershipAmount: document.getElementById('membershipAmount').value,
                eventAmount: document.getElementById('eventAmount').value,
                donationAmount: document.getElementById('donationAmount').value,
                otherAmount: document.getElementById('otherAmount').value
            };
            
            // Store receipt data in localStorage for the receipt template to pick up
            localStorage.setItem('currentReceiptData', JSON.stringify({
                member: memberData,
                payment: paymentData
            }));
            
            console.log('Receipt data prepared:', { member: memberData, payment: paymentData });
            
            // Open receipt in new window
            const receiptWindow = window.open('receipt-template.html', '_blank');
            
            // Also try the old method as backup
            if (receiptWindow) {
                receiptWindow.onload = function() {
                    try {
                        receiptWindow.receiptData = { member: memberData, payment: paymentData };
                        if (receiptWindow.populateReceipt) {
                            receiptWindow.populateReceipt(memberData, paymentData);
                        }
                    } catch (e) {
                        console.log('Backup method failed, using localStorage method');
                    }
                };
            }
        }
        
        function saveToMembers() {
            const memberName = document.getElementById('memberName').value.trim();
            const memberEmail = document.getElementById('memberEmail').value.trim();
            
            if (!memberName) {
                alert('Please enter the member name');
                return;
            }
            
            // Calculate total
            calculateTotal();
            const totalText = document.getElementById('totalDisplay').textContent;
            const totalAmount = parseFloat(totalText.replace('Total: $', ''));
            
            if (totalAmount <= 0) {
                alert('Please enter payment amounts greater than $0.00');
                return;
            }
            
            // Create payment record
            const paymentRecord = {
                date: document.getElementById('paymentDate').value,
                amount: totalAmount,
                method: document.getElementById('paymentMethod').value,
                transactionId: document.getElementById('transactionId').value,
                breakdown: {
                    membership: parseFloat(document.getElementById('membershipAmount').value) || 0,
                    event: parseFloat(document.getElementById('eventAmount').value) || 0,
                    donation: parseFloat(document.getElementById('donationAmount').value) || 0,
                    other: parseFloat(document.getElementById('otherAmount').value) || 0
                },
                receiptNumber: generateReceiptNumber()
            };
            
            // Update member records
            const members = getMembers();
            let memberFound = false;
            
            for (let member of members) {
                const memberEmailMatch = member.email === memberEmail;
                const memberNameMatch = (member.name || `${member.firstName} ${member.lastName}`).toLowerCase() === memberName.toLowerCase();
                
                if (memberEmailMatch || memberNameMatch) {
                    // Initialize payments array if it doesn't exist
                    if (!member.payments) {
                        member.payments = [];
                    }
                    
                    // Add new payment
                    member.payments.push(paymentRecord);
                    
                    // Update total paid
                    member.totalPaid = (member.totalPaid || 0) + totalAmount;
                    member.lastPaymentDate = paymentRecord.date;
                    member.lastPaymentAmount = totalAmount;
                    
                    memberFound = true;
                    break;
                }
            }
            
            if (memberFound) {
                // Save back to localStorage using the correct key
                localStorage.setItem('cvcwvuaa-members', JSON.stringify(members));
                alert('Payment record saved to member database successfully!');
                
                // Ask if they want to generate receipt
                if (confirm('Payment saved! Would you like to generate a receipt now?')) {
                    generateReceipt();
                }
            } else {
                alert('Member not found in database. Please check the name/email or add the member first.');
            }
        }
        
        function clearForm() {
            if (confirm('Clear all form data?')) {
                document.querySelectorAll('input, select, textarea').forEach(field => {
                    if (field.type === 'date') {
                        field.value = new Date().toISOString().split('T')[0];
                    } else if (field.type === 'number') {
                        field.value = '0.00';
                    } else if (field.id === 'processedBy') {
                        field.value = 'CVCWVUAA Admin';
                    } else {
                        field.value = '';
                    }
                });
                calculateTotal();
            }
        }
        
        // Initialize total calculation
        calculateTotal();
    </script>
</body>
</html>