<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/css/wvu-components.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt - CVCWVUAA</title>
    <style>
        @media print {
            * {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body {
                margin: 0.25in !important;
                padding: 0 !important;
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .receipt-container {
                box-shadow: none;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100%;
            }
            
            .receipt-header {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .receipt-header h1 {
                font-size: 1.3rem !important;
            }
            
            .receipt-header p {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            .receipt-info,
            .payment-details,
            .receipt-footer {
                font-size: 0.85rem !important;
                line-height: 1.3 !important;
                margin: 0.5rem 0 !important;
                padding: 0.5rem !important;
            }
            
            table {
                font-size: 0.85rem !important;
            }
            
            td, th {
                padding: 0.2rem !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .controls {
            max-width: 800px;
            margin: 0 auto 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-print {
            background: #2e7d32;
            color: white;
        }

        .btn-print:hover {
            background: #1b5e20;
        }

        .btn-back {
            background: #666;
            color: white;
        }

        .btn-back:hover {
            background: #444;
        }

        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 3px solid #2e7d32;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #2e7d32;
        }

        .receipt-stamp {
            display: inline-block;
            background: #2e7d32;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 3px;
            margin-bottom: 20px;
            transform: rotate(-5deg);
        }

        .org-info h1 {
            color: #002855;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .org-info p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .receipt-number {
            font-size: 18px;
            color: #666;
            margin-top: 15px;
        }

        .receipt-details {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .detail-value {
            color: #333;
            font-size: 16px;
            text-align: right;
        }

        .payment-breakdown {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 30px 0;
        }

        .payment-breakdown table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-breakdown th {
            background: #002855;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .payment-breakdown td {
            padding: 20px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .payment-breakdown .amount {
            text-align: right;
            font-weight: 600;
            font-size: 16px;
        }

        .total-paid {
            background: #2e7d32;
            color: white;
            padding: 25px 30px;
            border-radius: 8px;
            margin: 30px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-paid .label {
            font-size: 18px;
            font-weight: 600;
        }

        .total-paid .amount {
            font-size: 32px;
            font-weight: 700;
        }

        .thank-you {
            text-align: center;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 30px 0;
        }

        .thank-you h2 {
            color: #2e7d32;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .thank-you p {
            color: #666;
            line-height: 1.8;
            font-size: 15px;
        }

        .footer-note {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- WVU Masthead Component -->
    <div id="wvu-masthead"></div>

    <!-- WVU Primary Navigation Component -->
    <div id="wvu-navigation"></div>

    <!-- Back to Dashboard Button -->
    <div class="back-to-dashboard" style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
        <a href="/admin/dashboard.html" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #002855, #1e40af); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <span style="font-size: 1.2rem;">‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>

    <div class="controls no-print">
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print Receipt</button>
        <button class="btn btn-primary" onclick="emailReceipt()" style="background: #10b981;">üìß Email Receipt (HTML)</button>
        <button class="btn btn-back" onclick="window.close()">‚Üê Close</button>
    </div>
    
    <!-- Delivery Status Tracking -->
    <div class="delivery-status no-print" id="deliveryStatus" style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
        <h3 style="color: #003366; margin-top: 0; font-size: 1.1rem;">üì¨ Receipt Delivery Tracking</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Mark how this receipt was delivered:</p>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" id="status-print" onchange="updateDeliveryStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600; color: #003366;">üñ®Ô∏è Printed/Mailed</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" id="status-email-link" onchange="updateDeliveryStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600; color: #003366;">üìß Emailed (with Link)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" id="status-email-html" onchange="updateDeliveryStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600; color: #003366;">üìß Emailed (HTML)</span>
            </label>
        </div>
        <div id="statusMessage" style="margin-top: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724; display: none; text-align: center;">
            ‚úÖ Delivery status saved successfully!
        </div>
    </div>
    
    <!-- HTML Email Code Modal -->
    <div id="htmlEmailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0;">HTML Email Code</h2>
                <p style="margin: 0.5rem 0 0; opacity: 0.9;">Copy this HTML code to paste into your email client</p>
            </div>
            
            <div style="padding: 2rem;">
                <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0 0 0.5rem; font-weight: 600; color: #003057;">Instructions:</p>
                    <ol style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li>Click the "Copy HTML Code" button below</li>
                        <li>Open your email client (Gmail, Outlook, etc.)</li>
                        <li>Compose a new email to the member</li>
                        <li>Switch to HTML mode (in Gmail: ‚ãÆ menu ‚Üí "Show original" or use an HTML editor)</li>
                        <li>Paste the HTML code</li>
                        <li>Send from cvcwvuaa@gmail.com</li>
                    </ol>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #003057;">HTML Code:</label>
                    <textarea id="htmlCodeTextarea" readonly style="width: 100%; height: 400px; font-family: 'Courier New', monospace; font-size: 12px; padding: 1rem; border: 2px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                </div>
                
                <div style="text-align: center; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="copyHTMLCode()" style="padding: 0.75rem 2rem;">üìã Copy HTML Code</button>
                    <button class="btn btn-secondary" onclick="closeHTMLModal()" style="padding: 0.75rem 2rem;">‚úñÔ∏è Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        Loading receipt...
    </div>

    <div id="receipt" class="receipt-container" style="display: none;">
        <div class="receipt-header">
            <div class="receipt-stamp">PAID</div>
            <div class="org-info">
                <h1>Central Virginia Chapter<br>West Virginia University Alumni Association</h1>
                <p>
                    4701 Stoney Creek Pkwy, Chester, VA 23831<br>
                    Email: info@cvawvuaa.org | Website: www.cvawvuaa.org
                </p>
                <p class="receipt-number">Receipt #<span id="receiptNumber"></span></p>
            </div>
        </div>

        <div class="receipt-details">
            <div class="detail-row">
                <span class="detail-label">Received From:</span>
                <span class="detail-value" id="memberName"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Member ID:</span>
                <span class="detail-value" id="memberId"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Date:</span>
                <span class="detail-value" id="paymentDate"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Method:</span>
                <span class="detail-value" id="paymentMethod"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Membership Type:</span>
                <span class="detail-value" id="membershipType"></span>
            </div>
        </div>

        <div class="payment-breakdown">
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Amount</th>
                        <th class="amount">Received</th>
                    </tr>
                </thead>
                <tbody id="paymentItems">
                    <!-- Payment items will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="total-paid">
            <span class="label">TOTAL AMOUNT RECEIVED:</span>
            <span class="amount" id="totalReceived"></span>
        </div>

        <div id="notesSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
            <strong>Notes:</strong> <span id="paymentNotes"></span>
        </div>

        <div class="thank-you">
            <h2>Thank You!</h2>
            <p>
                Your payment has been received and recorded.<br>
                Your continued support helps the Central Virginia Chapter thrive!<br>
                <strong><span id="membershipPeriodText"></span></strong>
            </p>
        </div>

        <div class="footer-note">
            <p>This is an official receipt for tax purposes. Please retain for your records.</p>
            <p>Questions? Contact us at info@cvawvuaa.org</p>
            <p>Generated: <span id="generatedDate"></span></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="/admin/js/firebase-config.js?v=20251020-1538"></script>
    <script>
        let receiptDb = null;

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('memberId');
        const paymentTimestamp = urlParams.get('timestamp');

        if (!memberId) {
            document.getElementById('loading').innerHTML = 
                '<p style="color: #c62828;">‚ùå No member ID provided</p>';
        }

        // Initialize and load receipt
        window.addEventListener('load', async () => {
            setTimeout(async () => {
                receiptDb = firebase.firestore();
                await loadReceipt();
            }, 500);
        });

        /**
         * Email receipt to member
         */
        async function emailReceipt() {
            if (!memberId) {
                alert('Member ID not found');
                return;
            }

            try {
                // Get member info
                const memberDoc = await receiptDb.collection('members').doc(memberId).get();
                
                if (!memberDoc.exists) {
                    alert('Member not found');
                    return;
                }
                
                const member = memberDoc.data();
                const memberEmail = member.email || '';
                const memberName = member.name || 'Member';
                
                if (!memberEmail || memberEmail.trim() === '') {
                    alert('No email address available for this member. Please add an email address first.');
                    return;
                }
                
                if (!confirm(`Send receipt to ${memberEmail}?`)) {
                    return;
                }
                
                // Get current receipt URL
                const receiptURL = window.location.href;
                const firstName = memberName.split(' ')[0];
                
                // Get receipt details from page
                const receiptNumber = document.getElementById('receiptNumber')?.textContent || 'N/A';
                const totalAmount = document.getElementById('totalAmount')?.textContent || '$0.00';
                const paymentDate = document.getElementById('paymentDate')?.textContent || 'N/A';
                const paymentMethod = document.getElementById('paymentMethod')?.textContent || 'N/A';
                
                // Create HTML email
                const htmlEmail = createHTMLEmailReceipt();
                
                // Create plain text version
                const textEmail = `Dear ${firstName},

Thank you for your payment to the Central Virginia Chapter of the WVU Alumni Association!

RECEIPT DETAILS:
Receipt Number: ${receiptNumber}
Payment Date: ${paymentDate}
Total Amount: ${totalAmount}
Payment Method: ${paymentMethod}

VIEW RECEIPT ONLINE:
${receiptURL}

You can print or save this receipt for your records.

If you have any questions about this payment, please don't hesitate to contact us.

Let's Go! Mountaineers!!!!

Central Virginia Chapter WVU Alumni Association
Email: cvcwvuaa@gmail.com
Website: https://cvawvuaa.org
Phone: (804) 566-8058`;

                // Send email via Firebase
                await receiptDb.collection('mail').add({
                    to: memberEmail,
                    bcc: 'cvcwvuaa@gmail.com', // BCC to admin for tracking
                    message: {
                        subject: `Your CVCWVUAA Payment Receipt - ${receiptNumber}`,
                        text: textEmail,
                        html: htmlEmail
                    }
                });
                
                // Log communication
                await receiptDb.collection('communications').add({
                    memberId: memberId,
                    type: 'receipt',
                    details: `Receipt emailed to ${memberEmail}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    sentBy: 'Admin User',
                    method: 'Email (HTML)',
                    metadata: {
                        receiptUrl: receiptURL,
                        recipientEmail: memberEmail,
                        receiptNumber: receiptNumber
                    }
                });
                
                // Auto-check the emailed HTML checkbox
                if (document.getElementById('status-email-html')) {
                    document.getElementById('status-email-html').checked = true;
                    updateDeliveryStatus();
                }
                
                alert('‚úÖ Receipt email sent successfully!\n\nA copy has been sent to your Gmail for tracking.');
                
            } catch (error) {
                console.error('Error sending email:', error);
                alert('‚ùå Error sending email. Please try again.');
            }
        }

        async function loadReceipt() {
            try {
                if (!memberId) return;

                // Get member data
                const memberDoc = await receiptDb.collection('members').doc(memberId).get();
                
                if (!memberDoc.exists) {
                    document.getElementById('loading').innerHTML = 
                        '<p style="color: #c62828;">‚ùå Member not found</p>';
                    return;
                }

                const member = memberDoc.data();
                const payments = member.payments || [];
                
                // If timestamp provided, find specific payment
                let payment = null;
                if (paymentTimestamp) {
                    payment = payments.find(p => {
                        const pTimestamp = p.recordedDate?.toMillis ? p.recordedDate.toMillis() : null;
                        return pTimestamp && pTimestamp.toString() === paymentTimestamp;
                    });
                    
                    if (!payment) {
                        document.getElementById('loading').innerHTML = 
                            '<p style="color: #c62828;">‚ùå Payment not found</p>';
                        return;
                    }
                } else {
                    // No timestamp - show most recent payment or all payments
                    if (payments.length === 0) {
                        document.getElementById('loading').innerHTML = 
                            '<p style="color: #c62828;">‚ùå No payment records found</p>';
                        return;
                    }
                    // Use most recent payment
                    payment = payments[payments.length - 1];
                }

                // Generate receipt
                const receiptNumber = `REC-${new Date().getFullYear()}-${memberId.substring(0, 8).toUpperCase()}-${Date.now().toString().slice(-4)}`;
                
                const paymentDate = payment.date.toDate ? payment.date.toDate() : new Date(payment.date);
                const paymentDateStr = paymentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Fill in receipt details
                document.getElementById('receiptNumber').textContent = receiptNumber;
                document.getElementById('memberName').textContent = member.name;
                document.getElementById('memberId').textContent = memberId.substring(0, 12).toUpperCase();
                document.getElementById('paymentDate').textContent = paymentDateStr;
                document.getElementById('paymentMethod').textContent = payment.paymentMethod;
                
                const membershipType = member.membershipType || 'individual';
                const typeLabel = membershipType === 'family' ? 'Family Membership' : 'Individual Membership';
                document.getElementById('membershipType').textContent = typeLabel + (member.familyMemberName ? ` (${member.familyMemberName})` : '');
                
                // Build payment items table
                let paymentItemsHtml = '';
                let totalReceived = 0;
                
                // Determine payment type description
                let description = 'Membership Dues';
                if (payment.type === 'chapter') {
                    description = 'Chapter Donation';
                } else if (payment.type === 'scholarship') {
                    description = 'Scholarship Donation';
                }
                
                const fee = payment.expectedAmount - payment.actualReceived;
                
                paymentItemsHtml += `
                    <tr>
                        <td>${description}</td>
                        <td>$${payment.expectedAmount.toFixed(2)}</td>
                        <td class="amount">$${payment.actualReceived.toFixed(2)}</td>
                    </tr>
                `;
                
                if (fee > 0) {
                    paymentItemsHtml += `
                        <tr style="font-size: 13px; color: #666;">
                            <td colspan="2">Processing Fee</td>
                            <td class="amount">-$${fee.toFixed(2)}</td>
                        </tr>
                    `;
                }
                
                totalReceived = payment.actualReceived;
                
                document.getElementById('paymentItems').innerHTML = paymentItemsHtml;
                document.getElementById('totalReceived').textContent = `$${totalReceived.toFixed(2)}`;
                
                // Show notes if present
                if (payment.notes && payment.notes.trim()) {
                    document.getElementById('notesSection').style.display = 'block';
                    document.getElementById('paymentNotes').textContent = payment.notes;
                }
                
                // Set membership period text based on payment type
                if (payment.type === 'dues') {
                    const year = paymentDate.getFullYear();
                    const month = paymentDate.getMonth();
                    const membershipYear = month < 6 ? `${year - 1}-${year}` : `${year}-${year + 1}`;
                    const membershipPeriod = `July 1, ${membershipYear.split('-')[0]} - June 30, ${membershipYear.split('-')[1]}`;
                    document.getElementById('membershipPeriodText').textContent = `Membership Period: ${membershipPeriod}`;
                } else {
                    document.getElementById('membershipPeriodText').textContent = 'Thank you for your generous contribution!';
                }
                
                // Set generated date
                document.getElementById('generatedDate').textContent = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Show receipt
                document.getElementById('loading').style.display = 'none';
                document.getElementById('receipt').style.display = 'block';
                document.getElementById('deliveryStatus').style.display = 'block';
                
                // Load delivery status if exists in receipts collection
                await loadDeliveryStatus();
                
            } catch (error) {
                console.error('Error loading receipt:', error);
                document.getElementById('loading').innerHTML = 
                    `<p style="color: #c62828;">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        /**
         * Load delivery status from receipts collection
         */
        async function loadDeliveryStatus() {
            try {
                // Try to find receipt in receipts collection by memberId and timestamp
                const receiptsSnapshot = await receiptDb.collection('receipts')
                    .where('memberId', '==', memberId)
                    .where('paymentTimestamp', '==', paymentTimestamp)
                    .get();
                
                if (!receiptsSnapshot.empty) {
                    const receiptDoc = receiptsSnapshot.docs[0];
                    const receiptData = receiptDoc.data();
                    
                    if (receiptData.deliveryStatus) {
                        document.getElementById('status-print').checked = receiptData.deliveryStatus.printedMailed || false;
                        document.getElementById('status-email-link').checked = receiptData.deliveryStatus.emailedLink || false;
                        document.getElementById('status-email-html').checked = receiptData.deliveryStatus.emailedHTML || false;
                    }
                }
            } catch (error) {
                console.error('Error loading delivery status:', error);
            }
        }
        
        /**
         * Update delivery status in receipts collection
         */
        async function updateDeliveryStatus() {
            if (!memberId || !paymentTimestamp) {
                console.warn('Cannot update delivery status: missing memberId or timestamp');
                return;
            }
            
            const printedMailed = document.getElementById('status-print').checked;
            const emailedLink = document.getElementById('status-email-link').checked;
            const emailedHTML = document.getElementById('status-email-html').checked;
            
            const deliveryStatus = {
                printedMailed,
                emailedLink,
                emailedHTML,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // Find or create receipt document
                const receiptsSnapshot = await receiptDb.collection('receipts')
                    .where('memberId', '==', memberId)
                    .where('paymentTimestamp', '==', paymentTimestamp)
                    .get();
                
                if (!receiptsSnapshot.empty) {
                    // Update existing receipt
                    const receiptDoc = receiptsSnapshot.docs[0];
                    await receiptDoc.ref.update({ deliveryStatus });
                } else {
                    // Create new receipt entry (this shouldn't normally happen, but handle it)
                    await receiptDb.collection('receipts').add({
                        memberId,
                        paymentTimestamp,
                        deliveryStatus,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Show success message
                const message = document.getElementById('statusMessage');
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
                
                console.log('‚úÖ Delivery status updated:', deliveryStatus);
                
            } catch (error) {
                console.error('Error updating delivery status:', error);
                alert('Failed to save delivery status: ' + error.message);
            }
        }
        
        /**
         * Show HTML Email Code Modal
         */
        async function showHTMLEmail() {
            if (!memberId) {
                alert('Member ID not found');
                return;
            }
            
            try {
                const memberDoc = await receiptDb.collection('members').doc(memberId).get();
                if (!memberDoc.exists) {
                    alert('Member not found');
                    return;
                }
                
                const member = memberDoc.data();
                
                // Get receipt data from the DOM - use safe access
                const receiptNumber = document.getElementById('receiptNumber')?.textContent || 'N/A';
                const memberName = document.getElementById('memberName')?.textContent || member.name || 'Member';
                const paymentDate = document.getElementById('paymentDate')?.textContent || 'N/A';
                const paymentMethod = document.getElementById('paymentMethod')?.textContent || 'N/A';
                const membershipType = document.getElementById('membershipType')?.textContent || 'N/A';
                const totalReceived = document.getElementById('totalReceived')?.textContent || '$0.00';
                const paymentItems = document.getElementById('paymentItems')?.innerHTML || '';
                const paymentNotes = document.getElementById('paymentNotes')?.textContent || '';
                
                // Create HTML email code
                const htmlCode = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .receipt-container { max-width: 600px; margin: 0 auto; padding: 20px; background: #ffffff; }
        .header { text-align: center; background: linear-gradient(135deg, #003057, #0062a3); color: white; padding: 2rem; border-radius: 12px 12px 0 0; }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .receipt-body { padding: 2rem; background: #f8f9fa; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #003057; color: white; }
        .amount { text-align: right; }
        .total { font-size: 1.2rem; font-weight: bold; color: #003057; }
        .footer { text-align: center; padding: 1rem; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="receipt-container">
        <div class="header">
            <h1>Central Virginia Chapter<br>West Virginia University Alumni Association</h1>
            <p style="margin: 0.5rem 0 0;">Payment Receipt</p>
        </div>
        
        <div class="receipt-body">
            <p><strong>Receipt #:</strong> ${receiptNumber}</p>
            <p><strong>Date:</strong> ${paymentDate}</p>
            <p><strong>Member:</strong> ${memberName}</p>
            <p><strong>Payment Method:</strong> ${paymentMethod}</p>
            <p><strong>Membership Type:</strong> ${membershipType}</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Amount</th>
                        <th class="amount">Received</th>
                    </tr>
                </thead>
                <tbody>
                    ${paymentItems}
                </tbody>
            </table>
            
            <p class="total">TOTAL AMOUNT RECEIVED: ${totalReceived}</p>
            ${paymentNotes ? `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                <strong>Notes:</strong> ${paymentNotes}
            </div>` : ''}
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #2e7d32; margin-top: 0;">Thank You!</h3>
                <p>Your payment has been received and recorded.<br>
                Your continued support helps the Central Virginia Chapter thrive!</p>
            </div>
        </div>
        
        <div class="footer">
            <p>4701 Stoney Creek Pkwy, Chester, VA 23831<br>
            Email: info@cvawvuaa.org | Website: www.cvawvuaa.org</p>
            <p>This is an official receipt for tax purposes. Please retain for your records.</p>
        </div>
    </div>
</body>
</html>`;
                
                // Display in modal
                document.getElementById('htmlCodeTextarea').value = htmlCode;
                document.getElementById('htmlEmailModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating HTML email:', error);
                alert('Error generating HTML email code');
            }
        }
        
        /**
         * Copy HTML code to clipboard
         */
        function copyHTMLCode() {
            const textarea = document.getElementById('htmlCodeTextarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ HTML code copied to clipboard!\n\nYou can now paste it into your email client.');
                
                // Auto-check the emailed HTML checkbox
                if (document.getElementById('status-email-html')) {
                    document.getElementById('status-email-html').checked = true;
                    updateDeliveryStatus();
                }
            } catch (err) {
                alert('‚ùå Failed to copy. Please manually select and copy the code.');
            }
        }
        
        /**
         * Close HTML modal
         */
        function closeHTMLModal() {
            document.getElementById('htmlEmailModal').style.display = 'none';
        }
        
        // Override window.print to auto-check delivery status
        const originalPrint = window.print;
        window.print = function() {
            originalPrint.call(window);
            
            // Auto-check the printed/mailed checkbox after printing
            setTimeout(() => {
                if (document.getElementById('status-print')) {
                    document.getElementById('status-print').checked = true;
                    updateDeliveryStatus();
                }
            }, 1000);
        };
    </script>
    <!-- WVU Footer Component -->
    <div id="wvu-footer"></div>

    <!-- Load WVU Components -->
    <script src="/includes/component-loader.min.js"></script>
</body>
</html>
