<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/css/wvu-components.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt - CVCWVUAA</title>
    <style>
        @media print {
            * {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body {
                margin: 0.25in !important;
                padding: 0 !important;
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .receipt-container {
                box-shadow: none;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100%;
            }
            
            .receipt-header {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .receipt-header h1 {
                font-size: 1.3rem !important;
            }
            
            .receipt-header p {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
            }
            
            .receipt-info,
            .payment-details,
            .receipt-footer {
                font-size: 0.85rem !important;
                line-height: 1.3 !important;
                margin: 0.5rem 0 !important;
                padding: 0.5rem !important;
            }
            
            table {
                font-size: 0.85rem !important;
            }
            
            td, th {
                padding: 0.2rem !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .controls {
            max-width: 800px;
            margin: 0 auto 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-print {
            background: #2e7d32;
            color: white;
        }

        .btn-print:hover {
            background: #1b5e20;
        }

        .btn-back {
            background: #666;
            color: white;
        }

        .btn-back:hover {
            background: #444;
        }

        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 3px solid #2e7d32;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #2e7d32;
        }

        .receipt-stamp {
            display: inline-block;
            background: #2e7d32;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 3px;
            margin-bottom: 20px;
            transform: rotate(-5deg);
        }

        .org-info h1 {
            color: #002855;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .org-info p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .receipt-number {
            font-size: 18px;
            color: #666;
            margin-top: 15px;
        }

        .receipt-details {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .detail-value {
            color: #333;
            font-size: 16px;
            text-align: right;
        }

        .payment-breakdown {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 30px 0;
        }

        .payment-breakdown table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-breakdown th {
            background: #002855;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .payment-breakdown td {
            padding: 20px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .payment-breakdown .amount {
            text-align: right;
            font-weight: 600;
            font-size: 16px;
        }

        .total-paid {
            background: #2e7d32;
            color: white;
            padding: 25px 30px;
            border-radius: 8px;
            margin: 30px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-paid .label {
            font-size: 18px;
            font-weight: 600;
        }

        .total-paid .amount {
            font-size: 32px;
            font-weight: 700;
        }

        .thank-you {
            text-align: center;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 30px 0;
        }

        .thank-you h2 {
            color: #2e7d32;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .thank-you p {
            color: #666;
            line-height: 1.8;
            font-size: 15px;
        }

        .footer-note {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- WVU Masthead Component -->
    <div id="wvu-masthead"></div>

    <!-- WVU Primary Navigation Component -->
    <div id="wvu-navigation"></div>

    <div class="controls no-print">
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print Receipt</button>
        <button class="btn btn-primary" onclick="emailReceipt()" style="background: #ea4335;">üìß Email Receipt</button>
        <button class="btn btn-back" onclick="window.close()">‚Üê Close</button>
    </div>

    <div id="loading" class="loading">
        Loading receipt...
    </div>

    <div id="receipt" class="receipt-container" style="display: none;">
        <div class="receipt-header">
            <div class="receipt-stamp">PAID</div>
            <div class="org-info">
                <h1>Central Virginia Chapter<br>West Virginia University Alumni Association</h1>
                <p>
                    4701 Stoney Creek Pkwy, Chester, VA 23831<br>
                    Email: info@cvawvuaa.org | Website: www.cvawvuaa.org
                </p>
                <p class="receipt-number">Receipt #<span id="receiptNumber"></span></p>
            </div>
        </div>

        <div class="receipt-details">
            <div class="detail-row">
                <span class="detail-label">Received From:</span>
                <span class="detail-value" id="memberName"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Member ID:</span>
                <span class="detail-value" id="memberId"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Date:</span>
                <span class="detail-value" id="paymentDate"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Method:</span>
                <span class="detail-value" id="paymentMethod"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Membership Type:</span>
                <span class="detail-value" id="membershipType"></span>
            </div>
        </div>

        <div class="payment-breakdown">
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Amount</th>
                        <th class="amount">Received</th>
                    </tr>
                </thead>
                <tbody id="paymentItems">
                    <!-- Payment items will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="total-paid">
            <span class="label">TOTAL AMOUNT RECEIVED:</span>
            <span class="amount" id="totalReceived"></span>
        </div>

        <div id="notesSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
            <strong>Notes:</strong> <span id="paymentNotes"></span>
        </div>

        <div class="thank-you">
            <h2>Thank You!</h2>
            <p>
                Your payment has been received and recorded.<br>
                Your continued support helps the Central Virginia Chapter thrive!<br>
                <strong><span id="membershipPeriodText"></span></strong>
            </p>
        </div>

        <div class="footer-note">
            <p>This is an official receipt for tax purposes. Please retain for your records.</p>
            <p>Questions? Contact us at info@cvawvuaa.org</p>
            <p>Generated: <span id="generatedDate"></span></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="/admin/js/firebase-config.js?v=20251020-1538"></script>
    <script>
        let receiptDb = null;

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('memberId');
        const paymentTimestamp = urlParams.get('timestamp');

        if (!memberId) {
            document.getElementById('loading').innerHTML = 
                '<p style="color: #c62828;">‚ùå No member ID provided</p>';
        }

        // Initialize and load receipt
        window.addEventListener('load', async () => {
            setTimeout(async () => {
                receiptDb = firebase.firestore();
                await loadReceipt();
            }, 500);
        });

        /**
         * Email receipt to member
         */
        function emailReceipt() {
            if (!memberId) {
                alert('Member ID not found');
                return;
            }

            // Get current receipt URL
            const receiptURL = window.location.href;
            
            // Get member info if available
            receiptDb.collection('members').doc(memberId).get().then(doc => {
                if (!doc.exists) {
                    alert('Member not found');
                    return;
                }
                
                const member = doc.data();
                const memberEmail = member.email || '';
                const memberName = member.name || 'Member';
                const firstName = memberName.split(' ')[0];
                
                // Create email content
                const subject = encodeURIComponent('Your CVCWVUAA Payment Receipt');
                const body = encodeURIComponent(`Dear ${firstName},

Thank you for your payment to the Central Virginia Chapter of the WVU Alumni Association!

Your payment receipt is available at the link below:
${receiptURL}

You can print or save this receipt for your records.

If you have any questions about this payment, please don't hesitate to contact us.

Let's Go! Mountaineers!!!!

Central Virginia Chapter WVU Alumni Association
cvcwvuaa@gmail.com
https://cvawvuaa.org`);

                // Create mailto link
                const mailtoLink = `mailto:${memberEmail}?subject=${subject}&body=${body}`;
                
                // Log communication
                receiptDb.collection('communications').add({
                    memberId: memberId,
                    type: 'receipt',
                    details: `Receipt emailed to ${memberEmail}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    sentBy: 'Admin User',
                    method: 'Email',
                    metadata: {
                        receiptUrl: receiptURL,
                        recipientEmail: memberEmail
                    }
                }).then(() => {
                    console.log('Logged receipt email communication');
                }).catch(err => {
                    console.error('Error logging communication:', err);
                });
                
                // Open email client
                window.location.href = mailtoLink;
            }).catch(error => {
                console.error('Error getting member info:', error);
                alert('Error loading member information');
            });
        }

        async function loadReceipt() {
            try {
                if (!memberId) return;

                // Get member data
                const memberDoc = await receiptDb.collection('members').doc(memberId).get();
                
                if (!memberDoc.exists) {
                    document.getElementById('loading').innerHTML = 
                        '<p style="color: #c62828;">‚ùå Member not found</p>';
                    return;
                }

                const member = memberDoc.data();
                const payments = member.payments || [];
                
                // If timestamp provided, find specific payment
                let payment = null;
                if (paymentTimestamp) {
                    payment = payments.find(p => {
                        const pTimestamp = p.recordedDate?.toMillis ? p.recordedDate.toMillis() : null;
                        return pTimestamp && pTimestamp.toString() === paymentTimestamp;
                    });
                    
                    if (!payment) {
                        document.getElementById('loading').innerHTML = 
                            '<p style="color: #c62828;">‚ùå Payment not found</p>';
                        return;
                    }
                } else {
                    // No timestamp - show most recent payment or all payments
                    if (payments.length === 0) {
                        document.getElementById('loading').innerHTML = 
                            '<p style="color: #c62828;">‚ùå No payment records found</p>';
                        return;
                    }
                    // Use most recent payment
                    payment = payments[payments.length - 1];
                }

                // Generate receipt
                const receiptNumber = `REC-${new Date().getFullYear()}-${memberId.substring(0, 8).toUpperCase()}-${Date.now().toString().slice(-4)}`;
                
                const paymentDate = payment.date.toDate ? payment.date.toDate() : new Date(payment.date);
                const paymentDateStr = paymentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Fill in receipt details
                document.getElementById('receiptNumber').textContent = receiptNumber;
                document.getElementById('memberName').textContent = member.name;
                document.getElementById('memberId').textContent = memberId.substring(0, 12).toUpperCase();
                document.getElementById('paymentDate').textContent = paymentDateStr;
                document.getElementById('paymentMethod').textContent = payment.paymentMethod;
                
                const membershipType = member.membershipType || 'individual';
                const typeLabel = membershipType === 'family' ? 'Family Membership' : 'Individual Membership';
                document.getElementById('membershipType').textContent = typeLabel + (member.familyMemberName ? ` (${member.familyMemberName})` : '');
                
                // Build payment items table
                let paymentItemsHtml = '';
                let totalReceived = 0;
                
                // Determine payment type description
                let description = 'Membership Dues';
                if (payment.type === 'chapter') {
                    description = 'Chapter Donation';
                } else if (payment.type === 'scholarship') {
                    description = 'Scholarship Donation';
                }
                
                const fee = payment.expectedAmount - payment.actualReceived;
                
                paymentItemsHtml += `
                    <tr>
                        <td>${description}</td>
                        <td>$${payment.expectedAmount.toFixed(2)}</td>
                        <td class="amount">$${payment.actualReceived.toFixed(2)}</td>
                    </tr>
                `;
                
                if (fee > 0) {
                    paymentItemsHtml += `
                        <tr style="font-size: 13px; color: #666;">
                            <td colspan="2">Processing Fee</td>
                            <td class="amount">-$${fee.toFixed(2)}</td>
                        </tr>
                    `;
                }
                
                totalReceived = payment.actualReceived;
                
                document.getElementById('paymentItems').innerHTML = paymentItemsHtml;
                document.getElementById('totalReceived').textContent = `$${totalReceived.toFixed(2)}`;
                
                // Show notes if present
                if (payment.notes && payment.notes.trim()) {
                    document.getElementById('notesSection').style.display = 'block';
                    document.getElementById('paymentNotes').textContent = payment.notes;
                }
                
                // Set membership period text based on payment type
                if (payment.type === 'dues') {
                    const year = paymentDate.getFullYear();
                    const month = paymentDate.getMonth();
                    const membershipYear = month < 6 ? `${year - 1}-${year}` : `${year}-${year + 1}`;
                    const membershipPeriod = `July 1, ${membershipYear.split('-')[0]} - June 30, ${membershipYear.split('-')[1]}`;
                    document.getElementById('membershipPeriodText').textContent = `Membership Period: ${membershipPeriod}`;
                } else {
                    document.getElementById('membershipPeriodText').textContent = 'Thank you for your generous contribution!';
                }
                
                // Set generated date
                document.getElementById('generatedDate').textContent = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Show receipt
                document.getElementById('loading').style.display = 'none';
                document.getElementById('receipt').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading receipt:', error);
                document.getElementById('loading').innerHTML = 
                    `<p style="color: #c62828;">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
    <!-- WVU Footer Component -->
    <div id="wvu-footer"></div>

    <!-- Load WVU Components -->
    <script src="/includes/component-loader.min.js"></script>
</body>
</html>
