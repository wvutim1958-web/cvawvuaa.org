<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVCWVUAA Complete Management Hub</title>
<link rel="stylesheet" href="/css/styles.css">
<script src="/admin/js/export-to-csv.js" defer></script>
<style>
  .member-manager-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 2rem;
  }

  .manager-header {
    background: linear-gradient(135deg, var(--wvu-blue), #1e40af);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    text-align: center;
  }

  .main-hub-notice {
    background: #28a745;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    text-align: center;
    font-weight: bold;
  }

  .controls-panel {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }

  .control-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .member-table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .member-table {
    width: 100%;
    border-collapse: collapse;
  }

  .member-table th {
    background: var(--wvu-blue);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .member-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
  }

  .member-table tr:hover {
    background: #f8fafc;
  }

  .member-row.dues-current {
    background: #f0fdf4;
    border-left: 4px solid #10b981;
  }

  .member-row.dues-overdue {
    background: #fef2f2;
    border-left: 4px solid #ef4444;
  }

  .member-row.dues-pending {
    background: #fffbeb;
    border-left: 4px solid #f59e0b;
  }

  .dues-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .dues-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #10b981;
  }

  .dues-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-current {
    background: #d1fae5;
    color: #065f46;
  }

  .badge-overdue {
    background: #fee2e2;
    color: #991b1b;
  }

  .badge-pending {
    background: #fef3c7;
    color: #92400e;
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .btn-edit {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn-delete {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn-contact {
    background: #10b981;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn-receipt {
    background: #7c3aed;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .btn-receipt:hover {
    background: #6d28d9;
    transform: translateY(-1px);
  }

  .bulk-actions {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
  }

  .bulk-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .stat-current { color: #10b981; }
  .stat-overdue { color: #ef4444; }
  .stat-pending { color: #f59e0b; }
  .stat-total { color: var(--wvu-blue); }

  .search-input {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    width: 100%;
  }

  .filter-select {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .form-group input, .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }
</style>
</head>
<body>

<div class="member-manager-container">
  
  <!-- Header -->
  <div class="manager-header">
    <h1>üè¢ CVCWVUAA Complete Management Hub</h1>
    <p>Your One-Stop Solution: Member Management ‚Ä¢ Receipt Generation ‚Ä¢ Financial Tracking</p>
  </div>

  <div class="main-hub-notice">
    ‚úÖ This is your MAIN TOOL - Everything you need in one place! No more switching between different tools.
  </div>

  <!-- Statistics Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-number stat-total" id="totalMembers">0</div>
      <div>Total Members</div>
    </div>
    <div class="stat-item">
      <div class="stat-number stat-current" id="currentMembers">0</div>
      <div>Current on Dues</div>
    </div>
    <div class="stat-item">
      <div class="stat-number stat-overdue" id="overdueMembers">0</div>
      <div>Overdue Dues</div>
    </div>
    <div class="stat-item">
      <div class="stat-number stat-pending" id="pendingMembers">0</div>
      <div>Pending Payment</div>
    </div>
  </div>

  <!-- Controls Panel -->
  <div class="controls-panel">
    <div class="control-grid">
      <input type="text" class="search-input" id="memberSearch" placeholder="üîç Search members..." onkeyup="filterMembers()">
      <select class="filter-select" id="duesFilter" onchange="filterMembers()">
        <option value="">All Dues Status</option>
        <option value="current">Current</option>
        <option value="overdue">Overdue</option>
        <option value="pending">Pending</option>
      </select>
      <select class="filter-select" id="typeFilter" onchange="filterMembers()">
        <option value="">All Types</option>
        <option value="individual">Individual</option>
        <option value="family">Family</option>
        <option value="student">Student</option>
        <option value="lifetime">Lifetime</option>
      </select>
      <input type="number" class="filter-select" id="yearFilter" placeholder="2025" min="2020" max="2030" onchange="filterMembers()">
      <button class="action-btn" onclick="openAddMemberModal()">‚ûï Add Member</button>
      <button class="action-btn" onclick="console.log('Import button clicked'); importFromCSV()" style="background: #10b981; margin-left: 10px;">üìÅ Import CSV</button>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
      <strong>üõ†Ô∏è Bulk Actions:</strong>
      <div class="bulk-actions-grid" style="margin-top: 0.5rem;">
        <button class="action-btn success" onclick="markAllCurrentDues()">‚úÖ Mark All Current</button>
        <button class="action-btn warning" onclick="sendDuesReminders()">üìß Send Dues Reminders</button>
        <button class="action-btn" onclick="exportDuesReport()">üìä Export Dues Report</button>
        <button class="action-btn" onclick="openReceiptGenerator()" style="background: #7c3aed;">üßæ Generate Receipts</button>
        <button class="action-btn" onclick="exportMembersToCSV()" style="background: #3b82f6;">üíæ Export to CSV</button>
        <button class="action-btn" onclick="downloadMasterCSV()" style="background: #10b981;">üì• Master CSV</button>
        <button class="action-btn" onclick="quickAddMember()" style="background: #28a745;">‚ûï Add New Member</button>
        <button class="action-btn secondary" onclick="bulkDeleteOverdue()">üóëÔ∏è Remove Overdue (90+ days)</button>
      </div>
    </div>
  </div>

  <!-- Member Table -->
  <div class="member-table-container">
    <table class="member-table">
      <thead>
        <tr>
          <th>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> 
            Member Name
          </th>
          <th>Email & Phone</th>
          <th>Address</th>
          <th>Membership Type</th>
          <th>Dues Status 2025</th>
          <th>Last Payment</th>
          <th>Financial</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="memberTableBody">
        <!-- Members will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Member Modal -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Add New Member</h3>
    
    <div class="form-group">
      <label>Full Name:</label>
      <input type="text" id="memberName" placeholder="John Smith">
    </div>
    
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="memberEmail" placeholder="john@email.com">
    </div>
    
    <div class="form-group">
      <label>Phone:</label>
      <input type="tel" id="memberPhone" placeholder="(555) 123-4567">
    </div>
    
    <div class="form-group">
      <label>Membership Type:</label>
      <select id="memberType">
        <option value="individual">Individual ($25/year)</option>
        <option value="family">Family ($40/year)</option>
        <option value="student">Student ($15/year)</option>
        <option value="lifetime">Lifetime ($500)</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Dues Status for 2025:</label>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <label><input type="radio" name="duesStatus" value="current"> ‚úÖ Current</label>
        <label><input type="radio" name="duesStatus" value="pending"> ‚è≥ Pending</label>
        <label><input type="radio" name="duesStatus" value="overdue" checked> ‚ùå Overdue</label>
      </div>
    </div>
    
    <div class="form-group">
      <label>Last Payment Date:</label>
      <input type="date" id="lastPayment">
    </div>

    <div class="form-group">
      <label>Financial Information:</label>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
        <div>
          <label>Total Amount Paid ($):</label>
          <input type="number" id="totalAmountPaid" step="0.01" min="0" value="0">
        </div>
        <div>
          <label>Dues Amount ($):</label>
          <input type="number" id="duesAmount" step="0.01" min="0" value="0">
        </div>
        <div>
          <label>Scholarship Contribution ($):</label>
          <input type="number" id="scholarshipAmount" step="0.01" min="0" value="0">
        </div>
        <div>
          <label>General Fund ($):</label>
          <input type="number" id="generalFundAmount" step="0.01" min="0" value="0">
        </div>
      </div>
    </div>
    
    <div style="text-align: right; margin-top: 2rem;">
      <button class="action-btn secondary" onclick="closeMemberModal()">Cancel</button>
      <button class="action-btn" onclick="saveMember()" id="saveBtn">Save Member</button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>‚ö†Ô∏è Confirm Action</h3>
    <p id="confirmMessage">Are you sure?</p>
    <div style="text-align: right; margin-top: 2rem;">
      <button class="action-btn secondary" onclick="closeConfirmModal()">Cancel</button>
      <button class="action-btn btn-delete" onclick="confirmAction()" id="confirmBtn">Confirm</button>
    </div>
  </div>
</div>

<script>
let members = [];
let currentEditingId = null;
let pendingAction = null;

// Initialize with real member data from CSV or show empty state
function initializeMembers() {
  // Check if we have saved member data from CSV upload
  const savedMembers = localStorage.getItem('cvcwvuaa-members');
  if (savedMembers) {
    try {
      members = JSON.parse(savedMembers);
      updateDisplay();
      return;
    } catch (e) {
      console.error('Error loading saved members:', e);
    }
  }
  
  // No sample data - start empty until real CSV is imported
  members = [];
  showEmptyState();
}

function showEmptyState() {
  const container = document.querySelector('.members-container');
  if (container) {
    container.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 12px; margin: 2rem 0;">
        <h3>üìã No Members Loaded</h3>
        <p>Import your CVCWVUAA membership database CSV to see all real members here.</p>
        <button onclick="importFromCSV()" class="btn-primary" style="padding: 12px 24px; font-size: 16px;">
          üìÅ Import Member Database CSV
        </button>
      </div>
    `;
  }
  
  // Update stats to show zero
  updateDisplay();
}

// Save members to localStorage whenever data changes
function saveMembers() {
  localStorage.setItem('cvcwvuaa-members', JSON.stringify(members));
}

// Sync data to other admin interfaces
function syncToOtherInterfaces() {
  // Sync to member directory interface
  localStorage.setItem('cvcwvuaa-directory-members', JSON.stringify(members.map(member => ({
    ...member,
    // Convert for directory display format if needed
    major: member.major || "Alumni",
    graduationYear: member.classYear || "Unknown",
    location: member.fullAddress || `${member.city || ''}, ${member.state || 'VA'}`.trim().replace(/^,\s*/, '')
  }))));
  
  // Set sync timestamp
  localStorage.setItem('cvcwvuaa-last-sync', new Date().toISOString());
  
  // Auto-generate updated CSV data in localStorage for easy access
  generateMasterCSV();
}

// Generate master CSV data that's always up-to-date
function generateMasterCSV() {
  if (members.length === 0) return;
  
  const headers = [
    'First Name(s)',
    'Last Name',
    'E-mail Address (Primary)',
    'Primary Phone',
    'Home Address',
    'City',
    'State',
    'Zip Code',
    'Type of Membership',
    'Membership Last Paid',
    'Dues',
    'Total Amount Paid',
    'Scholarship',
    'General Fund'
  ];
  
  let csvContent = headers.join(',') + '\n';
  
  members.forEach(member => {
    const nameParts = (member.name || '').split(' ');
    const lastName = nameParts.pop() || '';
    const firstName = nameParts.join(' ');
    
    const membershipType = getFullMembershipTypeForCSV(member.type);
    const lastPayment = member.lastPayment ? formatDateForCSVExport(member.lastPayment) : '';
    
    const row = [
      escapeCSVFieldForMaster(firstName),
      escapeCSVFieldForMaster(lastName),
      escapeCSVFieldForMaster(member.email || ''),
      escapeCSVFieldForMaster(member.phone || ''),
      escapeCSVFieldForMaster(member.streetAddress || ''),
      escapeCSVFieldForMaster(member.city || ''),
      escapeCSVFieldForMaster(member.state || ''),
      escapeCSVFieldForMaster(member.zip || ''),
      escapeCSVFieldForMaster(membershipType),
      escapeCSVFieldForMaster(lastPayment),
      escapeCSVFieldForMaster((member.duesAmount || 0).toString()),
      escapeCSVFieldForMaster((member.totalAmountPaid || 0).toString()),
      escapeCSVFieldForMaster((member.scholarshipAmount || 0).toString()),
      escapeCSVFieldForMaster((member.generalFundAmount || 0).toString())
    ];
    
    csvContent += row.join(',') + '\n';
  });
  
  // Store the current CSV content in localStorage
  localStorage.setItem('cvcwvuaa-master-csv', csvContent);
  localStorage.setItem('cvcwvuaa-csv-last-updated', new Date().toISOString());
  
  console.log('Master CSV updated with', members.length, 'members');
}

function getFullMembershipTypeForCSV(type) {
  const types = {
    'individual': 'Individual Membership',
    'family': 'Family Membership', 
    'student': 'Student Membership',
    'lifetime': 'Lifetime Membership'
  };
  return types[type] || (type || 'Individual Membership');
}

function escapeCSVFieldForMaster(field) {
  if (field === null || field === undefined) field = '';
  field = field.toString();
  
  if (field.includes(',') || field.includes('"') || field.includes('\n')) {
    return '"' + field.replace(/"/g, '""') + '"';
  }
  return field;
}

function formatDateForCSVExport(dateString) {
  if (!dateString) return '';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    return (date.getMonth() + 1).toString().padStart(2, '0') + '/' +
           date.getDate().toString().padStart(2, '0') + '/' +
           date.getFullYear();
  } catch (e) {
    return dateString;
  }
}

// Function to download the current master CSV
function downloadMasterCSV() {
  const csvContent = localStorage.getItem('cvcwvuaa-master-csv');
  if (!csvContent) {
    alert('‚ö†Ô∏è No master CSV data available. Please add or import members first.');
    return;
  }
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', `CVCWVUAA-Master-Database-${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  const lastUpdated = localStorage.getItem('cvcwvuaa-csv-last-updated');
  alert(`‚úÖ Master CSV downloaded!\n\nLast updated: ${lastUpdated ? new Date(lastUpdated).toLocaleString() : 'Unknown'}\nMembers: ${members.length}`);
}

// CSV Import functionality
function importFromCSV() {
  try {
    console.log('üîç Starting CSV import process...');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(event) {
      try {
        console.log('üìÅ File selected:', event.target.files[0]?.name);
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              console.log('üìñ File read successfully, parsing CSV...');
              const csvText = e.target.result;
              parseCSVToMembers(csvText);
            } catch (parseError) {
              console.error('‚ùå Error parsing CSV:', parseError);
              alert('Error parsing CSV file: ' + parseError.message);
            }
          };
          reader.onerror = function(e) {
            console.error('‚ùå Error reading file:', e);
            alert('Error reading file. Please try again.');
          };
          reader.readAsText(file);
        } else {
          console.log('‚ùå No file selected');
        }
      } catch (fileError) {
        console.error('‚ùå Error handling file selection:', fileError);
        alert('Error selecting file: ' + fileError.message);
      }
    };
    input.click();
    console.log('‚úÖ File dialog opened');
  } catch (error) {
    console.error('‚ùå Error in importFromCSV:', error);
    alert('Import function error: ' + error.message);
  }
}

function smartMergeMembers(csvMembers) {
  // Get deleted members list (so they don't come back)
  const deletedMembers = JSON.parse(localStorage.getItem('cvcwvuaa-deleted-members') || '[]');
  
  let added = 0;
  let updated = 0;
  let preserved = 0;
  let deletedStayDeleted = 0;
  
  csvMembers.forEach(csvMember => {
    // Check if this member was previously deleted (by email or name)
    const wasDeleted = deletedMembers.some(deleted => 
      deleted.email === csvMember.email || 
      deleted.name === csvMember.name
    );
    
    if (wasDeleted) {
      deletedStayDeleted++;
      return; // Skip - this member was intentionally deleted
    }
    
    // Look for existing member by email (most reliable) or name
    const existingIndex = members.findIndex(m => 
      m.email === csvMember.email || 
      (m.name === csvMember.name && csvMember.email)
    );
    
    if (existingIndex === -1) {
      // New member - add them
      const newId = Math.max(...members.map(m => m.id), 0) + 1;
      csvMember.id = newId;
      members.push(csvMember);
      added++;
    } else {
      // Existing member - carefully merge data preserving admin changes
      const existing = members[existingIndex];
      
      let hasChanges = false;
      
      // Update contact info if CSV has newer/better data
      if (csvMember.phone && csvMember.phone !== existing.phone) {
        existing.phone = csvMember.phone;
        hasChanges = true;
      }
      
      // Update address info from CSV
      if (csvMember.fullAddress && csvMember.fullAddress !== existing.fullAddress) {
        existing.streetAddress = csvMember.streetAddress;
        existing.city = csvMember.city;
        existing.state = csvMember.state;
        existing.zip = csvMember.zip;
        existing.fullAddress = csvMember.fullAddress;
        hasChanges = true;
      }
      
      // Update class year if provided
      if (csvMember.classYear && csvMember.classYear !== existing.classYear) {
        existing.classYear = csvMember.classYear;
        hasChanges = true;
      }
      
      // Update financial fields from CSV ONLY if admin hasn't manually changed them
      // Check if existing member has admin-modified financial data
      if (!existing.hasAdminFinancialChanges) {
        if (csvMember.totalAmountPaid !== undefined && csvMember.totalAmountPaid !== existing.totalAmountPaid) {
          existing.totalAmountPaid = csvMember.totalAmountPaid;
          hasChanges = true;
        }
        
        if (csvMember.scholarshipAmount !== undefined && csvMember.scholarshipAmount !== existing.scholarshipAmount) {
          existing.scholarshipAmount = csvMember.scholarshipAmount;
          hasChanges = true;
        }
        
        if (csvMember.duesAmount !== undefined && csvMember.duesAmount !== existing.duesAmount) {
          existing.duesAmount = csvMember.duesAmount;
          hasChanges = true;
        }
        
        if (csvMember.generalFundAmount !== undefined && csvMember.generalFundAmount !== existing.generalFundAmount) {
          existing.generalFundAmount = csvMember.generalFundAmount;
          hasChanges = true;
        }
        
        // Update membership type from CSV if not manually changed
        if (csvMember.type && csvMember.type !== existing.type) {
          existing.type = csvMember.type;
          hasChanges = true;
        }
        
        // Update last payment date from CSV if not manually changed by admin
        if (csvMember.lastPayment && csvMember.lastPayment !== existing.lastPayment && !existing.hasAdminPaymentChanges) {
          existing.lastPayment = csvMember.lastPayment;
          hasChanges = true;
        }
      }
      
      // NEVER overwrite admin-managed fields:
      // - duesStatus (admin manages this through the interface)
      // - Any field marked as hasAdminFinancialChanges or hasAdminPaymentChanges
      
      if (hasChanges) {
        updated++;
      } else {
        preserved++;
      }
    }
  });
  
  return {
    added,
    updated, 
    preserved,
    deletedStayDeleted,
    changes: added + updated
  };
}

// Helper function to find field value with flexible matching
function findFieldValue(record, possibleNames) {
  for (const name of possibleNames) {
    // Try exact match first
    if (record[name]) return record[name];
    
    // Try case-insensitive partial match
    const found = Object.keys(record).find(key => 
      key.toLowerCase().includes(name.toLowerCase())
    );
    if (found && record[found]) return record[found];
  }
  return '';
}

function parseCSVToMembers(csvText) {
  const lines = csvText.split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  
  // More flexible CSV validation - accept whatever columns exist
  console.log('üîç CSV Headers found:', headers);
  
  // Look for name fields with flexible matching
  const hasNames = headers.some(h => 
    h.toLowerCase().includes('first') || 
    h.toLowerCase().includes('last') ||
    h.toLowerCase().includes('name')
  );
  
  if (!hasNames) {
    alert(`‚ùå CSV Import Error\n\nNo name fields detected.\nHeaders found: ${headers.join(', ')}\n\nPlease ensure your CSV has name columns.`);
    return;
  }
  
  // Backup existing data before import
  const backupKey = 'cvcwvuaa-members-backup-' + Date.now();
  localStorage.setItem(backupKey, JSON.stringify(members));
  console.log(`üíæ Created backup: ${backupKey}`);
  
  // Show import preview
  const proceed = confirm(`üìã CSV Import Preview\n\nFound ${lines.length - 1} member records\nHeaders: ${headers.slice(0, 6).join(', ')}${headers.length > 6 ? '...' : ''}\n\nThis will MERGE with existing data (preserving payments).\nBackup created: ${backupKey}\n\nContinue import?`);
  if (!proceed) return;
  
  console.log('CSV Headers found:', headers);
  console.log('Starting CSV processing...');
  
  const newMembers = [];
  let id = Math.max(...members.map(m => m.id), 0) + 1;
  
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim()) {
      const values = parseCSVLine(lines[i]);
      const record = {};
      
      headers.forEach((header, index) => {
        record[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
      });
      
      // Flexible field extraction - find fields regardless of exact names
      const firstName = findFieldValue(record, ['first name', 'first', 'fname']) || '';
      const lastName = findFieldValue(record, ['last name', 'last', 'lname', 'surname']) || '';
      const name = `${firstName} ${lastName}`.trim();
      
      if (name) {
        const email = findFieldValue(record, ['email', 'e-mail', 'mail']) || '';
        const phone = findFieldValue(record, ['phone', 'telephone', 'tel']) || '';
        
        // Determine membership type
        let type = 'individual';
        const membershipType = findFieldValue(record, ['membership', 'type']) || '';
        if (membershipType.toLowerCase().includes('joint') || membershipType.toLowerCase().includes('family')) {
          type = 'family';
        } else if (membershipType.toLowerCase().includes('student')) {
          type = 'student';
        } else if (membershipType.toLowerCase().includes('lifetime')) {
          type = 'lifetime';
        }
        
        // Determine dues status
        let duesStatus = 'overdue';
        const lastPaid = findFieldValue(record, ['last paid', 'paid', 'payment']) || '';
        if (lastPaid && new Date(lastPaid).getFullYear() === 2025) {
          duesStatus = 'current';
        } else if (findFieldValue(record, ['dues']) && findFieldValue(record, ['dues']) !== '0') {
          duesStatus = 'pending';
        }
        
        // Get financial data fields (flexible matching)
        const totalAmountPaid = parseFloat(findFieldValue(record, ['total amount paid', 'total paid', 'amount paid']) || '0') || 0;
        const scholarshipAmount = parseFloat(findFieldValue(record, ['scholarship']) || '0') || 0;
        const duesAmount = parseFloat(findFieldValue(record, ['dues', 'dues amount']) || '0') || 0;
        const generalFundAmount = parseFloat(findFieldValue(record, ['general fund', 'fund']) || '0') || 0;
        
        // Get address fields (flexible matching)
        const streetAddress = findFieldValue(record, ['home address', 'address', 'street']) || '';
        const city = findFieldValue(record, ['city', 'town']) || '';
        const state = findFieldValue(record, ['state', 'st']) || '';
        const zip = findFieldValue(record, ['zip', 'zip code', 'postal']) || '';
        
        // Create full address from components
        const fullAddress = [streetAddress, city, state, zip].filter(part => part && part.trim()).join(', ');
        
        // Check if member already exists
        const existingMember = members.find(m => m.name === name || m.email === email);
        
        const memberData = {
          id: existingMember ? existingMember.id : id++,
          name: name,
          email: email,
          phone: phone,
          type: type,
          duesStatus: duesStatus,
          lastPayment: lastPaid || null,
          year: 2025,
          streetAddress: streetAddress,
          city: city,
          state: state,
          zip: zip,
          fullAddress: fullAddress,
          // Financial fields - preserve existing data if it exists and is higher
          totalAmountPaid: existingMember ? Math.max(existingMember.totalAmountPaid || 0, totalAmountPaid) : totalAmountPaid,
          scholarshipAmount: existingMember ? Math.max(existingMember.scholarshipAmount || 0, scholarshipAmount) : scholarshipAmount,
          duesAmount: existingMember ? Math.max(existingMember.duesAmount || 0, duesAmount) : duesAmount,
          generalFundAmount: existingMember ? Math.max(existingMember.generalFundAmount || 0, generalFundAmount) : generalFundAmount,
          // Preserve admin change flags
          hasAdminFinancialChanges: existingMember ? existingMember.hasAdminFinancialChanges : false,
          hasAdminPaymentChanges: existingMember ? existingMember.hasAdminPaymentChanges : false
        };
        
        newMembers.push(memberData);
      }
    }
  }
  
  if (newMembers.length > 0) {
    // Smart merge: preserve existing data, only add/update carefully
    const result = smartMergeMembers(newMembers);
    
    if (result.changes > 0) {
      const message = `Smart CSV Import Results:
      
‚úÖ New members added: ${result.added}
üìù Members updated: ${result.updated} 
üîí Existing members preserved: ${result.preserved}
üö´ Deleted members stayed deleted: ${result.deletedStayDeleted}

Your manual changes (payments, dues status) have been preserved!`;
      
      alert(message);
      saveMembers();
      updateDisplay();
    } else {
      alert('No new members found in CSV. All existing data preserved.');
    }
  } else {
    alert('No valid member records found in CSV file');
  }
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

// Update statistics and table
function updateDisplay() {
  updateStatistics();
  updateMemberTable();
}

function updateStatistics() {
  const total = members.length;
  const current = members.filter(m => m.duesStatus === 'current').length;
  const overdue = members.filter(m => m.duesStatus === 'overdue').length;
  const pending = members.filter(m => m.duesStatus === 'pending').length;
  
  document.getElementById('totalMembers').textContent = total;
  document.getElementById('currentMembers').textContent = current;
  document.getElementById('overdueMembers').textContent = overdue;
  document.getElementById('pendingMembers').textContent = pending;
}

function updateMemberTable() {
  const tbody = document.getElementById('memberTableBody');
  tbody.innerHTML = '';
  
  const filteredMembers = getFilteredMembers();
  
  filteredMembers.forEach(member => {
    const row = document.createElement('tr');
    row.className = `member-row dues-${member.duesStatus}`;
    row.dataset.memberId = member.id;
    
    const statusBadge = getStatusBadge(member.duesStatus);
    const typeDisplay = getTypeDisplay(member.type);
    
    row.innerHTML = `
      <td>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" class="member-checkbox" value="${member.id}">
          <strong>${member.name}</strong>
        </div>
      </td>
      <td>
        <div>${member.email}</div>
        <div style="color: #64748b; font-size: 0.9rem;">${member.phone}</div>
      </td>
      <td>
        <div style="font-size: 0.85rem;">
          ${getCleanAddress(member)}
        </div>
      </td>
      <td>${typeDisplay}</td>
      <td>
        <div class="dues-status">
          <input type="checkbox" class="dues-checkbox" ${member.duesStatus === 'current' ? 'checked' : ''} 
                 onchange="toggleDuesStatus(${member.id})">
          <span class="dues-badge badge-${member.duesStatus}">${statusBadge}</span>
        </div>
      </td>
      <td>${formatDate(member.lastPayment)}</td>
      <td>
        <div style="font-size: 0.85rem;">
          <div><strong>Total:</strong> $${(member.totalAmountPaid || 0).toFixed(2)}</div>
          <div><strong>Dues:</strong> $${(member.duesAmount || 0).toFixed(2)}</div>
          <div><strong>Scholarship:</strong> $${(member.scholarshipAmount || 0).toFixed(2)}</div>
          <div><strong>Fund:</strong> $${(member.generalFundAmount || 0).toFixed(2)}</div>
        </div>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-contact" onclick="contactMember('${member.email}')">üìß</button>
          <button class="btn-receipt" onclick="createMemberReceipt(${member.id})" title="Generate Receipt">üßæ</button>
          <button class="btn-edit" onclick="editMember('${member.id}')">‚úèÔ∏è</button>
          <button class="btn-delete" onclick="deleteMember(${member.id})">üóëÔ∏è</button>
        </div>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

function getStatusBadge(status) {
  const badges = {
    current: '‚úÖ Current',
    overdue: '‚ùå Overdue', 
    pending: '‚è≥ Pending'
  };
  return badges[status] || status;
}

function getTypeDisplay(type) {
  const types = {
    individual: 'Individual',
    family: 'Family',
    student: 'Student', 
    lifetime: 'Lifetime'
  };
  return types[type] || type;
}

function getCleanAddress(member) {
  // Validate address components and filter out potential names
  const isValidAddressComponent = (component) => {
    if (!component || !component.trim()) return false;
    const trimmed = component.trim();
    
    // Skip if it looks like a single last name (common issue)
    if (/^[A-Z][a-z]+$/.test(trimmed) && trimmed.length < 15 && 
        !['Richmond', 'Norfolk', 'Virginia', 'Hampton', 'Newport', 'Glen Allen'].includes(trimmed)) {
      return false;
    }
    
    return true;
  };
  
  const cleanStreet = isValidAddressComponent(member.streetAddress) ? member.streetAddress : '';
  const cleanCity = isValidAddressComponent(member.city) ? member.city : '';
  const cleanState = isValidAddressComponent(member.state) ? member.state : '';
  const cleanZip = member.zip && /^\d{5}(-\d{4})?$/.test(member.zip.trim()) ? member.zip : '';
  
  let addressHTML = '';
  
  if (cleanStreet) {
    addressHTML += `<div><strong>${cleanStreet}</strong></div>`;
  }
  
  const cityStateZip = [cleanCity, cleanState, cleanZip].filter(x => x).join(', ');
  if (cityStateZip) {
    addressHTML += `<div>${cityStateZip}</div>`;
  }
  
  // If we have a full address field that looks valid, use that instead
  if (!addressHTML && member.fullAddress && member.fullAddress.includes(',')) {
    addressHTML = `<div>${member.fullAddress}</div>`;
  }
  
  return addressHTML || '<div style="color: #999;">No address</div>';
}

function formatDate(dateString) {
  if (!dateString) return 'No payment';
  const date = new Date(dateString);
  return date.toLocaleDateString();
}

// Filtering functions
function getFilteredMembers() {
  const search = document.getElementById('memberSearch').value.toLowerCase();
  const duesFilter = document.getElementById('duesFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const yearFilter = document.getElementById('yearFilter').value;
  
  return members.filter(member => {
    let matches = true;
    
    if (search && !member.name.toLowerCase().includes(search) && 
        !member.email.toLowerCase().includes(search)) {
      matches = false;
    }
    
    if (duesFilter && member.duesStatus !== duesFilter) {
      matches = false;
    }
    
    if (typeFilter && member.type !== typeFilter) {
      matches = false;
    }
    
    if (yearFilter && member.year.toString() !== yearFilter) {
      matches = false;
    }
    
    return matches;
  });
}

function filterMembers() {
  updateMemberTable();
}

// Dues management functions
function toggleDuesStatus(memberId) {
  const member = members.find(m => m.id === memberId);
  if (member) {
    if (member.duesStatus === 'current') {
      member.duesStatus = 'overdue';
      member.lastPayment = null;
    } else {
      member.duesStatus = 'current';
      member.lastPayment = new Date().toISOString().split('T')[0];
    }
    saveMembers();
    updateDisplay();
  }
}

// Quick Add Member Function
function quickAddMember() {
  const name = prompt('Enter member name:');
  if (!name) return;
  
  const email = prompt('Enter email address:');
  if (!email) return;
  
  const phone = prompt('Enter phone number (optional):') || '';
  const address = prompt('Enter street address (optional):') || '';
  const city = prompt('Enter city (optional):') || '';
  const state = prompt('Enter state (default: VA):') || 'VA';
  const zipCode = prompt('Enter ZIP code (optional):') || '';
  
  const newMember = {
    id: Date.now(), // Simple unique ID
    name: name,
    email: email,
    phone: phone,
    address: address,
    streetAddress: address,
    city: city,
    state: state,
    zipCode: zipCode,
    fullAddress: [address, city, state, zipCode].filter(x => x).join(', '),
    membershipType: 'Individual Membership',
    duesStatus: 'unpaid',
    paidThrough: '',
    duesAmount: 0,
    totalAmountPaid: 0,
    scholarshipAmount: 0,
    generalFundAmount: 0
  };
  
  members.push(newMember);
  saveMembersData();
  renderMemberTable();
  alert('‚úÖ Member added successfully!');
}

function markAllCurrentDues() {
  const selected = getSelectedMembers();
  if (selected.length === 0) {
    alert('Please select members to mark as current');
    return;
  }
  
  selected.forEach(id => {
    const member = members.find(m => m.id === parseInt(id));
    if (member) {
      member.duesStatus = 'current';
      member.lastPayment = new Date().toISOString().split('T')[0];
    }
  });
  
  updateDisplay();
  alert(`‚úÖ Marked ${selected.length} members as current on dues`);
}

// Member CRUD operations
function openAddMemberModal() {
  currentEditingId = null;
  document.getElementById('modalTitle').textContent = 'Add New Member';
  document.getElementById('saveBtn').textContent = 'Add Member';
  clearMemberForm();
  document.getElementById('memberModal').style.display = 'block';
}

function editMember(id) {
  console.log('Edit member called with ID:', id);
  console.log('Available members:', members.map(m => ({id: m.id, name: m.name})));
  
  const member = members.find(m => m.id == id || m.id === id);
  if (member) {
    console.log('Found member:', member);
    currentEditingId = id;
    document.getElementById('modalTitle').textContent = 'Edit Member';
    document.getElementById('saveBtn').textContent = 'Update Member';
    
    document.getElementById('memberName').value = member.name;
    document.getElementById('memberEmail').value = member.email;
    document.getElementById('memberPhone').value = member.phone;
    document.getElementById('memberType').value = member.type;
    document.querySelector(`input[name="duesStatus"][value="${member.duesStatus}"]`).checked = true;
    document.getElementById('lastPayment').value = member.lastPayment || '';
    
    // Set financial fields if they exist in the member object
    document.getElementById('totalAmountPaid').value = member.totalAmountPaid || '0';
    document.getElementById('duesAmount').value = member.duesAmount || '0';
    document.getElementById('scholarshipAmount').value = member.scholarshipAmount || '0';
    document.getElementById('generalFundAmount').value = member.generalFundAmount || '0';
    
    document.getElementById('memberModal').style.display = 'block';
  } else {
    console.error('Member not found with ID:', id);
    console.error('Available IDs:', members.map(m => m.id));
    alert('Member not found. Check console for details.');
  }
}

function deleteMember(id) {
  const member = members.find(m => m.id === id);
  if (member) {
    showConfirmation(
      `Delete member "${member.name}"?`,
      `This will permanently remove ${member.name} from your database. This action cannot be undone.`,
      () => {
        members = members.filter(m => m.id !== id);
        saveMembers();
        updateDisplay();
        alert(`üóëÔ∏è Deleted member: ${member.name}`);
      }
    );
  }
}

function saveMember() {
  const name = document.getElementById('memberName').value.trim();
  const email = document.getElementById('memberEmail').value.trim();
  const phone = document.getElementById('memberPhone').value.trim();
  const type = document.getElementById('memberType').value;
  const duesStatus = document.querySelector('input[name="duesStatus"]:checked').value;
  const lastPayment = document.getElementById('lastPayment').value;
  
  // Get financial data
  const totalAmountPaid = parseFloat(document.getElementById('totalAmountPaid').value) || 0;
  const duesAmount = parseFloat(document.getElementById('duesAmount').value) || 0;
  const scholarshipAmount = parseFloat(document.getElementById('scholarshipAmount').value) || 0;
  const generalFundAmount = parseFloat(document.getElementById('generalFundAmount').value) || 0;
  
  if (!name || !email) {
    alert('Name and email are required');
    return;
  }
  
  const memberData = {
    name,
    email,
    phone,
    type,
    duesStatus,
    lastPayment: lastPayment || null,
    year: 2025,
    // Financial fields
    totalAmountPaid,
    duesAmount,
    scholarshipAmount,
    generalFundAmount,
    // Mark that admin has made financial changes (prevents CSV overwrites)
    hasAdminFinancialChanges: true,
    hasAdminPaymentChanges: lastPayment ? true : false
  };
  
  if (currentEditingId) {
    // Update existing member
    const index = members.findIndex(m => m.id === currentEditingId);
    if (index !== -1) {
      const existingMember = members[index];
      
      // Check if financial fields actually changed
      const financialFieldsChanged = 
        existingMember.totalAmountPaid !== totalAmountPaid ||
        existingMember.duesAmount !== duesAmount ||
        existingMember.scholarshipAmount !== scholarshipAmount ||
        existingMember.generalFundAmount !== generalFundAmount;
      
      const paymentChanged = existingMember.lastPayment !== (lastPayment || null);
      
      // Only mark as admin-changed if values actually changed
      memberData.hasAdminFinancialChanges = financialFieldsChanged || existingMember.hasAdminFinancialChanges;
      memberData.hasAdminPaymentChanges = paymentChanged || existingMember.hasAdminPaymentChanges;
      
      members[index] = { ...members[index], ...memberData };
      saveMembers();
      alert(`‚úÖ Updated member: ${name}`);
      
      // Trigger sync to other admin interfaces
      syncToOtherInterfaces();
    }
  } else {
    // Add new member
    const newId = Math.max(...members.map(m => m.id), 0) + 1;
    members.push({ id: newId, ...memberData });
    alert(`‚úÖ Added new member: ${name}`);
    
    // Trigger sync to other admin interfaces
    syncToOtherInterfaces();
  }
  
  saveMembers();
  closeMemberModal();
  updateDisplay();
}

function clearMemberForm() {
  document.getElementById('memberName').value = '';
  document.getElementById('memberEmail').value = '';
  document.getElementById('memberPhone').value = '';
  document.getElementById('memberType').value = 'individual';
  document.querySelector('input[name="duesStatus"][value="overdue"]').checked = true;
  document.getElementById('lastPayment').value = '';
  
  // Clear financial fields
  document.getElementById('totalAmountPaid').value = '0';
  document.getElementById('duesAmount').value = '0';
  document.getElementById('scholarshipAmount').value = '0';
  document.getElementById('generalFundAmount').value = '0';
}

// Modal functions
function closeMemberModal() {
  document.getElementById('memberModal').style.display = 'none';
}

function showConfirmation(title, message, callback) {
  document.getElementById('confirmModal').querySelector('h3').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  pendingAction = callback;
  document.getElementById('confirmModal').style.display = 'block';
}

function closeConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
  pendingAction = null;
}

function confirmAction() {
  if (pendingAction) {
    pendingAction();
  }
  closeConfirmModal();
}

// Bulk operations
function getSelectedMembers() {
  const checkboxes = document.querySelectorAll('.member-checkbox:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.member-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function sendDuesReminders() {
  const overdueMembers = members.filter(m => m.duesStatus === 'overdue' && m.email);
  
  if (overdueMembers.length === 0) {
    alert('No overdue members found');
    return;
  }
  
  // Show email preview modal instead of trying to open email client directly
  showEmailPreview(overdueMembers);
}

function showEmailPreview(overdueMembers) {
  const emails = overdueMembers.map(m => m.email).join('; ');
  const subject = 'CVCWVUAA - 2025 Membership Dues Reminder';
  
  // HTML formatted email body with actual payment links from pay.html
  const htmlBody = `
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .header { background: #002855; color: #ffd100; padding: 20px; text-align: center; }
    .content { padding: 20px; }
    .payment-options { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 8px; }
    .btn { display: inline-block; background: #002855; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px; }
    .btn:hover { background: #ffd100; color: #002855; }
    .footer { background: #f1f1f1; padding: 15px; text-align: center; font-size: 12px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>üèîÔ∏è Central Virginia Chapter WVU Alumni Association</h2>
    <p>Let's Go Mountaineers!</p>
  </div>
  
  <div class="content">
    <p>Dear Fellow Mountaineer,</p>
    
    <p>This is a friendly reminder that your <strong>2025 membership dues</strong> are overdue for the Central Virginia Chapter of West Virginia University Alumni Association.</p>
    
    <p>Your membership helps support our organization, provide scholarships to local deserving students, and provide resources to new and existing students attending WVU.</p>
    
    <div class="payment-options">
      <h3>üí≥ Pay Your Dues Online:</h3>
      <p><strong>Single Membership:</strong> $25/year</p>
      <p><a href="https://www.paypal.com/donate/?hosted_button_id=P2MJTS44SXS4U" class="btn" target="_blank">Pay Single Membership - $25</a></p>
      
      <p><strong>Family Member Addition:</strong> $15/year</p>
      <p><a href="https://www.paypal.com/donate/?hosted_button_id=H6L88M4VBJS8W" class="btn" target="_blank">Pay Family Addition - $15</a></p>
      
      <h3>üìÆ Pay by Mail:</h3>
      <p>Make checks payable to <strong>CVCWVUAA</strong><br>
      Mail to: <strong>4701 Stoney Creek Parkway, Chester, VA 23831</strong></p>
    </div>
    
    <p>As a <strong>501(c)(3)</strong> all-volunteer organization, membership fees support our goals and mission with the primary focus to continue providing annual scholarships through our <strong>WVU Alumni Central Virginia Chapter Scholarship</strong> (endowed).</p>
    
    <p>Members receive first opportunities to participate in sporting events and special guest appearances from the University.</p>
    
    <p>Please renew at your earliest convenience to maintain your membership benefits and support our chapter activities.</p>
    
    <p>Thank you for your continued support!</p>
    
    <p><strong>Let's Go Mountaineers! üî•üèîÔ∏è</strong></p>
    
    <p>Central Virginia Chapter WVU Alumni Association<br>
    <a href="https://cvawvuaa.org">cvawvuaa.org</a></p>
  </div>
  
  <div class="footer">
    <p>¬© 2025 CVCWVUAA ‚Äî Central Virginia Chapter of the WVU Alumni Association. All rights reserved.<br>
    WVU and West Virginia University are trademarks of West Virginia University.</p>
  </div>
</body>
</html>`;

  // Plain text version for email clients that don't support HTML
  const textBody = `Dear Fellow Mountaineer,

This is a friendly reminder that your 2025 membership dues are overdue for the Central Virginia Chapter of West Virginia University Alumni Association.

PAYMENT OPTIONS:

Online Payment:
‚Ä¢ Single Membership ($25): https://www.paypal.com/donate/?hosted_button_id=P2MJTS44SXS4U
‚Ä¢ Family Addition ($15): https://www.paypal.com/donate/?hosted_button_id=H6L88M4VBJS8W

Mail Payment:
Make checks payable to CVCWVUAA
Mail to: 4701 Stoney Creek Parkway, Chester, VA 23831

Your membership helps support scholarships and chapter activities.

Thank you for your continued support!

Let's Go Mountaineers! üî•üèîÔ∏è

Central Virginia Chapter WVU Alumni Association
https://cvawvuaa.org`;

  // Create modal for email preview
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px; height: 80vh;">
      <h2>üìß Dues Reminder Email Preview</h2>
      <p><strong>Recipients (${overdueMembers.length} members):</strong></p>
      <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; max-height: 80px; overflow-y: auto; font-size: 12px;">
        ${emails}
      </div>
      
      <p><strong>Subject:</strong></p>
      <input type="text" id="emailSubject" value="${subject}" style="width: 100%; margin-bottom: 15px;">
      
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button onclick="showHtmlPreview()" class="btn-primary" style="padding: 5px 15px;">üìÑ HTML Preview</button>
        <button onclick="showTextVersion()" class="btn-secondary" style="padding: 5px 15px;">üìù Text Version</button>
      </div>
      
      <div id="emailPreview" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; margin-bottom: 15px;">
        ${htmlBody}
      </div>
      
      <textarea id="emailBody" style="display: none; width: 100%; height: 300px; margin-bottom: 15px;">${textBody}</textarea>
      
      <div style="text-align: right;">
        <button onclick="closeEmailModal()" class="btn-secondary" style="margin-right: 10px;">Cancel</button>
        <button onclick="openEmailClient()" class="btn-primary">üìß Open Email Client</button>
        <button onclick="copyEmailInfo()" class="btn-success" style="margin-left: 10px;">üìã Copy Email Info</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.style.display = 'flex';
  
  // Store the HTML body for later use
  modal.htmlBody = htmlBody;
  modal.textBody = textBody;
}

function showHtmlPreview() {
  const modal = document.querySelector('.modal');
  const preview = document.getElementById('emailPreview');
  const textarea = document.getElementById('emailBody');
  
  preview.style.display = 'block';
  textarea.style.display = 'none';
  preview.innerHTML = modal.htmlBody;
}

function showTextVersion() {
  const modal = document.querySelector('.modal');
  const preview = document.getElementById('emailPreview');
  const textarea = document.getElementById('emailBody');
  
  preview.style.display = 'none';
  textarea.style.display = 'block';
  textarea.value = modal.textBody;
}

function openEmailClient() {
  const subject = document.getElementById('emailSubject').value;
  const overdueMembers = members.filter(m => m.duesStatus === 'overdue' && m.email);
  const emails = overdueMembers.map(m => m.email).join(';');
  
  // Use text version for mailto links (HTML not supported in mailto)
  const modal = document.querySelector('.modal');
  const textBody = modal.textBody;
  
  const mailtoLink = `mailto:${emails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textBody)}`;
  
  // Try multiple methods to open email
  try {
    // Method 1: Direct window.open
    const emailWindow = window.open(mailtoLink);
    
    // Method 2: If popup blocked, try location.href
    setTimeout(() => {
      if (!emailWindow || emailWindow.closed) {
        window.location.href = mailtoLink;
      }
    }, 100);
    
    closeEmailModal();
    alert(`‚úÖ Email client should open with ${overdueMembers.length} recipients.\n\nNote: The email will open in text format (HTML formatting not supported in mailto links).\n\nFor HTML email, use "Copy Email Info" and paste into your email program, then switch to HTML mode.`);
  } catch (error) {
    alert('‚ùå Could not open email client automatically. Please use the "Copy Email Info" button to copy the details and paste them manually into your email program.');
  }
}

function copyEmailInfo() {
  const subject = document.getElementById('emailSubject').value;
  const overdueMembers = members.filter(m => m.duesStatus === 'overdue' && m.email);
  const emails = overdueMembers.map(m => m.email).join('; ');
  const modal = document.querySelector('.modal');
  
  // Create comprehensive email info with both versions
  const emailInfo = `TO: ${emails}

SUBJECT: ${subject}

=================== HTML VERSION (Recommended) ===================
${modal.htmlBody}

=================== TEXT VERSION (Fallback) ===================
${modal.textBody}

INSTRUCTIONS:
1. Copy the HTML version above
2. Paste into your email program
3. Switch your email to HTML/Rich Text mode
4. The formatting and clickable links will appear
5. If HTML doesn't work, use the text version instead`;
  
  navigator.clipboard.writeText(emailInfo).then(() => {
    closeEmailModal();
    alert(`üìã Complete email information copied to clipboard!\n\nRecipients: ${overdueMembers.length} members\n\nIncludes both HTML (with clickable links) and text versions.\n\nPaste into your email program and use HTML mode for best results.`);
  }).catch(() => {
    // Fallback for browsers that don't support clipboard API
    const textArea = document.createElement('textarea');
    textArea.value = emailInfo;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    closeEmailModal();
    alert(`üìã Email information copied to clipboard!\n\nRecipients: ${overdueMembers.length} members\n\nIncludes HTML and text versions.`);
  });
}

function closeEmailModal() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => modal.remove());
}

function exportDuesReport() {
  const report = members.map(m => 
    `${m.name}\t${m.email}\t${m.type}\t${m.duesStatus}\t${formatDate(m.lastPayment)}`
  ).join('\n');
  
  const csvContent = `Name\tEmail\tType\tDues Status\tLast Payment\n${report}`;
  const blob = new Blob([csvContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `CVCWVUAA-Dues-Report-${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('üìä Dues report exported!');
}

function bulkDeleteOverdue() {
  const overdueMembers = members.filter(m => m.duesStatus === 'overdue');
  if (overdueMembers.length === 0) {
    alert('No overdue members found');
    return;
  }
  
  showConfirmation(
    `Delete ${overdueMembers.length} overdue members?`,
    `This will permanently remove all members marked as overdue. This action cannot be undone.`,
    () => {
      members = members.filter(m => m.duesStatus !== 'overdue');
      updateDisplay();
      alert(`üóëÔ∏è Deleted ${overdueMembers.length} overdue members`);
    }
  );
}

function contactMember(email) {
  window.open(`mailto:${email}?subject=From CVCWVUAA President`);
}

// Receipt Generation Functions
function openReceiptGenerator() {
  window.open('receipt-generator.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

function createMemberReceipt(memberId) {
  const member = members.find(m => m.id === memberId);
  if (!member) {
    alert('Member not found');
    return;
  }

  // Open receipt generator with pre-filled member data
  const receiptWindow = window.open('receipt-generator.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
  
  // Wait for the receipt generator to load, then populate with member data
  receiptWindow.onload = function() {
    setTimeout(() => {
      // Pre-populate the receipt generator form
      if (receiptWindow.document.getElementById('memberName')) {
        receiptWindow.document.getElementById('memberName').value = member.name || '';
        receiptWindow.document.getElementById('memberEmail').value = member.email || '';
        receiptWindow.document.getElementById('memberPhone').value = member.phone || '';
        
        // Format address
        const addressParts = [member.streetAddress, member.city, member.state, member.zip].filter(x => x);
        receiptWindow.document.getElementById('memberAddress').value = addressParts.join(', ');
        
        receiptWindow.document.getElementById('memberSince').value = member.memberSince || member.joinDate || 'Not available';
        
        // Pre-populate payment amounts if available
        if (member.duesAmount && member.duesAmount > 0) {
          receiptWindow.document.getElementById('membershipAmount').value = member.duesAmount.toFixed(2);
        }
        if (member.scholarshipAmount && member.scholarshipAmount > 0) {
          receiptWindow.document.getElementById('donationAmount').value = member.scholarshipAmount.toFixed(2);
        }
        if (member.generalFundAmount && member.generalFundAmount > 0) {
          receiptWindow.document.getElementById('otherAmount').value = member.generalFundAmount.toFixed(2);
        }
        
        // Set last payment date if available
        if (member.lastPayment) {
          const paymentDate = new Date(member.lastPayment);
          if (!isNaN(paymentDate.getTime())) {
            receiptWindow.document.getElementById('paymentDate').value = paymentDate.toISOString().split('T')[0];
          }
        }
        
        // Trigger total calculation
        if (receiptWindow.calculateTotal) {
          receiptWindow.calculateTotal();
        }
      }
    }, 500); // Give the window time to fully load
  };
}

function generateReceiptForPayment(memberId, paymentData) {
  const member = members.find(m => m.id === memberId);
  if (!member) {
    alert('Member not found');
    return;
  }

  // Prepare receipt data
  const memberData = {
    name: member.name,
    email: member.email,
    phone: member.phone,
    address: [member.streetAddress, member.city, member.state, member.zip].filter(x => x).join(', '),
    memberSince: member.memberSince || member.joinDate
  };

  // Generate receipt number
  const now = new Date();
  const year = now.getFullYear();
  const timestamp = Date.now().toString().slice(-6);
  const receiptNumber = `CVCWV-${year}-${timestamp}`;

  const receiptData = {
    receiptNumber: receiptNumber,
    date: paymentData.date || new Date().toLocaleDateString(),
    method: paymentData.method || 'Not specified',
    transactionId: paymentData.transactionId || 'N/A',
    processedBy: 'CVCWVUAA Admin',
    membershipAmount: paymentData.membershipAmount || '0.00',
    eventAmount: paymentData.eventAmount || '0.00',
    donationAmount: paymentData.donationAmount || '0.00',
    otherAmount: paymentData.otherAmount || '0.00'
  };

  // Open receipt template with populated data
  const receiptWindow = window.open('receipt-template.html', '_blank');
  receiptWindow.onload = function() {
    receiptWindow.receiptData = {
      member: memberData,
      payment: receiptData
    };
    receiptWindow.populateReceipt(memberData, receiptData);
  };

  // Save payment record to member
  if (!member.payments) {
    member.payments = [];
  }
  
  const totalAmount = parseFloat(paymentData.membershipAmount || 0) + 
                     parseFloat(paymentData.eventAmount || 0) + 
                     parseFloat(paymentData.donationAmount || 0) + 
                     parseFloat(paymentData.otherAmount || 0);

  member.payments.push({
    date: paymentData.date,
    amount: totalAmount,
    method: paymentData.method,
    receiptNumber: receiptNumber,
    breakdown: {
      membership: parseFloat(paymentData.membershipAmount || 0),
      event: parseFloat(paymentData.eventAmount || 0),
      donation: parseFloat(paymentData.donationAmount || 0),
      other: parseFloat(paymentData.otherAmount || 0)
    }
  });

  // Update member totals
  member.totalAmountPaid = (member.totalAmountPaid || 0) + totalAmount;
  member.lastPaymentDate = paymentData.date;
  member.lastPaymentAmount = totalAmount;
  
  // Mark as admin modified to preserve data
  member.hasAdminPaymentChanges = true;

  // Save to localStorage
  localStorage.setItem('cvcwvuaa-members', JSON.stringify(members));
  
  return receiptNumber;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  initializeMembers();
});
</script>

</body>
</html>