<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Media Uploader (Local Admin)</title>
<link rel="stylesheet" href="/css/styles.css" />
<style>
  body{background:#f7f9fc}
  main{padding:24px 0}
  .muted{color:#5b6777}
  .grid{display:grid;gap:16px}
  .grid-2{grid-template-columns:1fr}
  @media(min-width:960px){.grid-2{grid-template-columns:1fr 1fr}}
  input[type=file]{padding:10px;border:1px solid #cfd6e6;border-radius:10px;background:#fff}
  .ok{color:#0a6c2f;font-weight:700}
  .warn{color:#8a5300;font-weight:700}
  .small{font-size:14px}
</style>
</head>
<body>
    <!-- WVU Masthead Component -->
    <div id="wvu-masthead"></div>

    <!-- WVU Primary Navigation Component -->
    <div id="wvu-navigation"></div>

<header class="site">
  <div class="wrapper topbar">
    <a class="brand" href="/index.html"><img class="site-logo" src="/assets/logo.png" alt="logo"></a>
    <nav><strong style="color:#ffd100">Local Admin</strong></nav>
  </div>
</header>

<main>
  <div class="wrapper">
    <h1 style="margin:0 0 6px 0">Media Uploader</h1>
    <p class="muted">Pick your local <strong>repo folder</strong>, select photos/videos, enter details, then <em>Upload & Save</em>. Commit & push in GitHub Desktop when finished.</p>

    <p>
      <button class="btn" id="pick">Open repo folder…</button>
      <span id="status" class="muted"></span>
    </p>

    <div class="grid grid-2">
      <section class="card">
        <h2>1) Select files</h2>
        <p class="small">Images: JPG/PNG/WEBP • Videos: MP4 (H.264). Files will be copied to <code>/assets/gallery/YYYY/MM/</code>.</p>
        <input type="file" id="files" accept=".jpg,.jpeg,.png,.webp,.avif,.mp4" multiple />
        <div style="margin-top:8px" class="small">
          <label><input type="checkbox" id="per-file-toggle"> Per-file details</label>
          <label style="margin-left:12px"><input type="checkbox" id="auto-caption" checked> Auto-caption from filename</label>
        </div>
        <div id="file-review" class="grid" style="margin-top:10px;display:none"></div>
        <div class="small muted" style="margin-top:6px">
          Tip: For faster pages and better quality, keep photos under ~1600px wide and ~300–600 KB. Use JPEG at 75–82% quality, or WebP. You can also convert large phone images before upload.
        </div>
      </section>

        <!-- Scholarship Recipients JSON editor -->
        <section class="card" style="margin-top:16px">
          <h2>Scholarship Recipients</h2>
          <p class="small">Edit <code>content/scholarship-recipients.json</code>.</p>
          <div style="margin:8px 0">
            <button class="btn" id="rec-add">Add Recipient</button>
            <button class="btn" id="rec-save">Save Recipients</button>
            <span id="rec-msg" class="muted"></span>
          </div>
          <div id="rec-list" class="grid"></div>
        </section>

        <!-- Newsletter posts JSON editor -->
        <section class="card" style="margin-top:16px">
          <h2>Newsletter Posts</h2>
          <p class="small">Edit <code>newsletters/posts.json</code>.</p>
          <div style="margin:8px 0">
            <button class="btn" id="nl-add">Add Post</button>
            <button class="btn" id="nl-save">Save Posts</button>
            <span id="nl-msg" class="muted"></span>
          </div>
          <div id="nl-list" class="grid"></div>
        </section>

      <section class="card">
        <h2>2) Details</h2>
        <div class="grid grid-2">
          <label>Caption <input id="caption" placeholder="e.g., Watch Party"></label>
          <label>Credit <input id="credit" placeholder="e.g., CVCWVUAA"></label>
          <label>Date <input id="date" type="date"></label>
          <label>Tags (comma-separated) <input id="tags" placeholder="events,football"></label>
        </div>
        <p class="small">These apply to all selected files (you can edit JSON later for per-file differences).</p>
        <p><button class="btn" id="upload">Upload & Save</button></p>
        <p id="msg" class="muted"></p>
      </section>
    </div>

    <!-- Minutes (PDF) management -->
    <section class="card" style="margin-top:16px">
      <h2>Minutes (PDF)</h2>
      <p class="small">Copies PDFs to <code>/assets/minutes/</code> and updates <code>assets/minutes/minutes.json</code> for the Minutes page.</p>
      <div class="grid grid-2">
        <label>Default Title <input id="min-title" placeholder="e.g., Board Meeting"></label>
        <label>Fallback Date <input id="min-date" type="date"></label>
        <label>Note <input id="min-note" placeholder="Optional note shown under date"></label>
        <div>
          <input type="file" id="min-files" accept=".pdf" multiple />
          <p style="margin-top:10px">
            <button class="btn" id="min-upload">Upload & Update JSON</button>
            <button class="btn outline" id="min-regenerate">Regenerate from folder</button>
          </p>
          <p id="min-msg" class="muted"></p>
        </div>
      </div>
    </section>

    <!-- Alumni Spotlight JSON editor -->
    <section class="card" style="margin-top:16px">
      <h2>Alumni Spotlight</h2>
      <p class="small">Edit <code>content/spotlight.json</code>. Add, update, or remove entries. Save writes back to your repo.</p>
      <div id="spot-controls" style="margin:8px 0">
        <button class="btn" id="spot-add">Add Entry</button>
        <button class="btn" id="spot-save">Save Spotlight</button>
        <span id="spot-msg" class="muted"></span>
      </div>
      <div id="spot-list" class="grid"></div>
    </section>

    <!-- News Posts JSON editor -->
    <section class="card" style="margin-top:16px">
      <h2>News Posts</h2>
      <p class="small">Edit <code>news/posts.json</code> and create markdown files in <code>news/posts/</code>.</p>
      <div style="margin:8px 0">
        <button class="btn" id="news-add">Add Post</button>
        <button class="btn" id="news-save">Save posts.json</button>
        <span id="news-msg" class="muted"></span>
      </div>
      <div id="news-list" class="grid"></div>
    </section>

    <!-- Events management -->
    <section class="card" style="margin-top:16px">
      <h2>Events</h2>
      <p class="small">Manage <code>events/events.json</code>. Use the RSVP link for each event to track responses on the RSVP page.</p>
      <div style="margin:8px 0">
        <button class="btn" id="ev-add">Add Event</button>
        <button class="btn" id="ev-save">Save events.json</button>
        <span id="ev-msg" class="muted"></span>
      </div>
      <div id="ev-list" class="grid"></div>
    </section>

    <!-- Board Members management -->
    <section class="card" style="margin-top:16px">
      <h2>Board Members</h2>
      <p class="small">Manage <code>content/board-members.json</code>. Add, edit, or remove board member positions and information.</p>
      <div style="margin:8px 0">
        <button class="btn" id="board-add">Add Position</button>
        <button class="btn" id="board-save">Save Board</button>
        <span id="board-msg" class="muted"></span>
      </div>
      <div id="board-list" class="grid"></div>
    </section>
  </div>
</main>

<script>
  // Not security—just avoids accidental access if you place it on a host.
  if(location.protocol.startsWith('http')){
    alert('Open this file locally (file://) for write access.');
  }

  let dir = null;
  const $ = s => document.querySelector(s);
  const todayISO = () => new Date().toISOString().slice(0,10);

  $('#date').value = todayISO();
  $('#min-date').value = todayISO();

  $('#pick').addEventListener('click', async () => {
    try{
      dir = await window.showDirectoryPicker();
      $('#status').textContent = 'Repo folder opened.';
    }catch(e){ console.warn(e); }
  });

  async function ensureDir(root, pathParts){
    let h = root;
    for(const part of pathParts){
      h = await h.getDirectoryHandle(part, {create:true});
    }
    return h;
  }

  async function readText(root, path){
    const parts = path.split('/').filter(Boolean);
    let h = root;
    for(let i=0;i<parts.length-1;i++){ h = await h.getDirectoryHandle(parts[i], {create:false}); }
    const fh = await h.getFileHandle(parts.at(-1), {create:true});
    const f = await fh.getFile();
    return await f.text();
  }

  async function writeText(root, path, text){
    const parts = path.split('/').filter(Boolean);
    let h = root;
    for(let i=0;i<parts.length-1;i++){ h = await h.getDirectoryHandle(parts[i], {create:true}); }
    const fh = await h.getFileHandle(parts.at(-1), {create:true});
    const w = await fh.createWritable();
    await w.write(text);
    await w.close();
  }

  function sanitizeName(name){
    return name.toLowerCase().replace(/[^a-z0-9._-]+/g,'-').replace(/-+/g,'-').replace(/(^-|-$)/g,'');
  }

  async function fileExists(root, path){
    const parts = path.split('/').filter(Boolean);
    let h = root;
    try{
      for(let i=0;i<parts.length-1;i++){
        h = await h.getDirectoryHandle(parts[i], {create:false});
      }
      await h.getFileHandle(parts.at(-1), {create:false});
      return true;
    }catch(e){ return false; }
  }

  async function uniqueName(dirHandle, baseName){
    const base = baseName.replace(/\s+/g,'-');
    const ext = (base.match(/\.[^.]+$/) || [''])[0];
    const stem = ext ? base.slice(0, -ext.length) : base;
    let n = 0;
    while(true){
      const name = n ? `${stem}-${n}${ext}` : base;
      try { await dirHandle.getFileHandle(name, {create:false}); n++; }
      catch { return name; }
    }
  }

  function pad(n){ return String(n).padStart(2,'0'); }
  function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function parseDateFromName(name){
    const s = name.toLowerCase();
    let m = s.match(/(20\d{2})[-_.\s]?(\d{2})[-_.\s]?(\d{2})/); // YYYY-MM-DD, YYYYMMDD, with separators
    if(m){ return `${m[1]}-${m[2]}-${m[3]}`; }
    m = s.match(/(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*[-_.\s]?(20\d{2})/i);
    if(m){
      const monthMap = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
      const mm = pad(monthMap[m[1].slice(0,3).toLowerCase()]);
      return `${m[2]}-${mm}-01`;
    }
    return null;
  }
  function monthYearLabel(iso){
    try{
      const d = new Date(iso);
      const fmt = new Intl.DateTimeFormat('en', {month:'long', year:'numeric'});
      return fmt.format(d);
    }catch{ return iso; }
  }

  $('#upload').addEventListener('click', async () => {
    if(!dir){ alert('Open your repo folder first.'); return; }
    const files = $('#files').files;
    if(!files || !files.length){ alert('Choose at least one file.'); return; }

    const y = $('#date').value?.slice(0,4) || new Date().getFullYear().toString();
    const m = ($('#date').value?.slice(5,7) || String(new Date().getMonth()+1).padStart(2,'0'));
    const galleryDir = await ensureDir(dir, ['assets','gallery', y, m]);

    // load gallery.json (or create)
    let json = "[]";
    try{ json = await readText(dir, 'content/gallery.json'); }catch(e){}
    let items = [];
    try{ items = JSON.parse(json); }catch(e){ items = []; }

    const caption = $('#caption').value.trim();
    const credit  = $('#credit').value.trim() || 'CVCWVUAA';
    const date    = $('#date').value || todayISO();
    const tags    = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);

    let added = 0;
    // Build per-file overrides if review is visible
    const usePerFile = document.getElementById('per-file-toggle')?.checked;
    const reviewRows = Array.from(document.querySelectorAll('#file-review [data-file-idx]'));
    const overrides = new Map();
    reviewRows.forEach(row => {
      const i = +row.getAttribute('data-file-idx');
      const ocap = row.querySelector('[data-k="caption"]').value.trim();
      const odate = row.querySelector('[data-k="date"]').value.trim();
      const otags = row.querySelector('[data-k="tags"]').value.split(',').map(s=>s.trim()).filter(Boolean);
      const ocredit = row.querySelector('[data-k="credit"]').value.trim();
      overrides.set(i, {caption: ocap, date: odate, tags: otags, credit: ocredit});
    });

    let idx = -1;
    for(const f of files){ idx++;
      const fname = sanitizeName(f.name);
      const isVideo = /\.mp4$/i.test(fname);
      const isImage = /\.(jpe?g|png|webp|avif)$/i.test(fname);
      if(!isImage && !isVideo){ continue; }

      const destPath = `assets/gallery/${y}/${m}/${fname}`;
      // copy file
      const fh = await galleryDir.getFileHandle(fname, {create:true});
      const w = await fh.createWritable();
      await w.write(await f.arrayBuffer()); await w.close();

      const ov = usePerFile ? (overrides.get(idx) || {}) : {};
      const item = {
        type: isVideo ? 'video' : 'image',
        src: '/' + destPath,
        caption: ov.caption || caption,
        credit: ov.credit || credit,
        date: ov.date || date,
        tags: (ov.tags && ov.tags.length) ? ov.tags : tags
      };
      if(isVideo){
        // Optional: if you also add a poster manually later, include poster path here
        // item.poster = `/${destPath.replace(/\.[^.]+$/, '-poster.jpg')}`;
      }else{
        item.alt = caption || fname;
      }
      items.push(item);
      added++;
    }

    await writeText(dir, 'content/gallery.json', JSON.stringify(items, null, 2));
    $('#msg').textContent = added ? `Uploaded ${added} file(s) and updated content/gallery.json` : 'No supported files were added.';
    $('#msg').className = added ? 'ok' : 'warn';
    alert('Done. Commit & push in GitHub Desktop to publish.');
  });

  // Per-file review rendering
  let selectedFiles = [];
  function renderFileReview(){
    const wrap = document.getElementById('file-review');
    const perToggle = document.getElementById('per-file-toggle');
    if(!wrap || !perToggle) return;
    wrap.style.display = perToggle.checked ? '' : 'none';
    wrap.innerHTML = '';
    if(!perToggle.checked) return;
    const autoCap = document.getElementById('auto-caption')?.checked;
    selectedFiles.forEach((f,i)=>{
      const url = URL.createObjectURL(f);
      const cap = autoCap ? f.name.replace(/\.[^.]+$/, '').replace(/[-_]+/g,' ').replace(/\s+/g,' ').trim() : '';
      const row = document.createElement('div'); row.className='card'; row.style.padding='12px'; row.setAttribute('data-file-idx', String(i));
      row.innerHTML = `
        <div class="grid grid-2">
          <div>
            ${/\.(mp4)$/i.test(f.name) ? '<div class="small">Video</div>' : `<img src="${url}" alt="preview" style="max-width:100%;max-height:140px;border-radius:8px">`}
          </div>
          <div>
            <label>Caption <input data-k="caption" value="${cap.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
            <label>Credit <input data-k="credit" value="CVCWVUAA"></label>
            <label>Date <input data-k="date" type="date" value="${todayISO()}"></label>
            <label>Tags <input data-k="tags" placeholder="events,football"></label>
          </div>
        </div>`;
      wrap.appendChild(row);
    });
  }
  document.getElementById('files').addEventListener('change', (e)=>{
    selectedFiles = Array.from(e.target.files || []);
    renderFileReview();
  });
  document.getElementById('per-file-toggle').addEventListener('change', renderFileReview);
  document.getElementById('auto-caption').addEventListener('change', renderFileReview);

  // =====================
  // Minutes (PDF) section
  // =====================
  $('#min-upload').addEventListener('click', async () => {
    if(!dir){ alert('Open your repo folder first.'); return; }
    const files = $('#min-files').files;
    if(!files || !files.length){ alert('Choose at least one PDF.'); return; }

    const minutesDir = await ensureDir(dir, ['assets','minutes']);

    // Load existing minutes.json
    let items = [];
    try {
      const json = await readText(dir, 'assets/minutes/minutes.json');
      items = JSON.parse(json || '[]');
      if(!Array.isArray(items)) items = [];
    } catch { items = []; }

    const defTitle = $('#min-title').value.trim();
    const defDate  = $('#min-date').value || todayISO();
    const note     = $('#min-note').value.trim();

    let added = 0;
    for(const f of files){
      if(!/\.pdf$/i.test(f.name)) continue;
      const raw = sanitizeName(f.name).replace(/\s+/g,'-').replace(/\.PDF$/,'\.pdf');
      const destName = await uniqueName(minutesDir, /\.pdf$/i.test(raw) ? raw : `${raw}.pdf`);
      const fh = await minutesDir.getFileHandle(destName, {create:true});
      const w = await fh.createWritable();
      await w.write(await f.arrayBuffer());
      await w.close();

      // Compute date
      let date = parseDateFromName(destName);
      if(!date){ try{ const fileObj = await fh.getFile(); date = toISODate(new Date(fileObj.lastModified)); }catch{} }
      if(!date){ date = defDate; }

      // Title default: "Meeting Minutes — Month YYYY"
      const title = defTitle || (date ? `Meeting Minutes — ${monthYearLabel(date)}` : 'Meeting Minutes');

      const rec = { title, date, file: destName };
      if(note) rec.note = note;

      // De-dup by file name
      const idx = items.findIndex(x => x && (x.file === destName || x.url === `/assets/minutes/${destName}`));
      if(idx >= 0){ items[idx] = rec; } else { items.push(rec); }
      added++;
    }

    // Sort newest first by date
    items.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    await writeText(dir, 'assets/minutes/minutes.json', JSON.stringify(items, null, 2));

    $('#min-msg').textContent = added ? `Added/updated ${added} item(s) and wrote assets/minutes/minutes.json` : 'No PDFs were added.';
    $('#min-msg').className = added ? 'ok' : 'warn';
    alert('Minutes updated. Commit & push in GitHub Desktop to publish.');
  });

  $('#min-regenerate').addEventListener('click', async () => {
    if(!dir){ alert('Open your repo folder first.'); return; }
    const minutesDir = await ensureDir(dir, ['assets','minutes']);
    const out = [];
    for await (const [name, handle] of minutesDir.entries()){
      if(handle.kind !== 'file' || !/\.pdf$/i.test(name)) continue;
      const f = await handle.getFile();
      let date = parseDateFromName(name) || toISODate(new Date(f.lastModified));
      const title = `Meeting Minutes — ${monthYearLabel(date)}`;
      out.push({ title, date, file: name });
    }
    out.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    await writeText(dir, 'assets/minutes/minutes.json', JSON.stringify(out, null, 2));
    $('#min-msg').textContent = `Regenerated ${out.length} item(s) from /assets/minutes`;
    $('#min-msg').className = 'ok';
    alert('Regenerated minutes.json. Commit & push to publish.');
  });

  // ========================
  // Alumni Spotlight section
  // ========================
  let spotData = [];
  const spotList = document.getElementById('spot-list');

  function renderSpotlight(){
    spotList.innerHTML = '';
    spotData.forEach((item, i) => {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.style.padding = '12px';
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Title <input data-k="title" data-i="${i}" value="${(item.title||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Meta <input data-k="meta" data-i="${i}" value="${(item.meta||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Image URL <input data-k="image" data-i="${i}" value="${(item.image||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Alt Text <input data-k="alt" data-i="${i}" value="${(item.alt||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label style="grid-column:1/-1">Text <textarea data-k="text" data-i="${i}" rows="3">${(item.text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</textarea></label>
        </div>
        <div style="margin-top:8px"><button class="btn outline" data-remove="${i}">Remove</button></div>
      `;
      wrap.addEventListener('input', (e) => {
        const t = e.target; if(!t.dataset || !('i' in t.dataset)) return;
        const idx = +t.dataset.i, k = t.dataset.k; if(!k) return;
        spotData[idx] = spotData[idx] || {};
        spotData[idx][k] = t.tagName === 'TEXTAREA' ? t.value : t.value;
      });
      wrap.querySelector('[data-remove]')?.addEventListener('click', () => {
        spotData.splice(i,1); renderSpotlight();
      });
      spotList.appendChild(wrap);
    });
  }

  async function loadSpotlight(){
    try{
      const txt = await readText(dir, 'content/spotlight.json');
      const arr = JSON.parse(txt || '[]');
      spotData = Array.isArray(arr) ? arr : [];
    }catch{ spotData = []; }
    renderSpotlight();
  }

  document.getElementById('spot-add').addEventListener('click', () => {
    spotData.push({ title:'', meta:'', text:'', image:'', alt:'' });
    renderSpotlight();
  });
  document.getElementById('spot-save').addEventListener('click', async () => {
    if(!dir){ alert('Open your repo folder first.'); return; }
    // prune empty entries (no title and no text)
    const cleaned = spotData.filter(x => (x.title||'').trim() || (x.text||'').trim());
    await writeText(dir, 'content/spotlight.json', JSON.stringify(cleaned, null, 2));
    document.getElementById('spot-msg').textContent = `Saved ${cleaned.length} entrie(s) to content/spotlight.json`;
    document.getElementById('spot-msg').className = 'ok';
    alert('Spotlight saved. Commit & push in GitHub Desktop to publish.');
  });

  // Auto-load spotlight after picking directory
  $('#pick').addEventListener('click', () => {
    const iv = setInterval(() => { if(dir){ clearInterval(iv); loadSpotlight(); } }, 300);
  });

  // ================================
  // Scholarship Recipients editor
  // ================================
  let recData = [];
  const recList = document.getElementById('rec-list');
  function renderRecipients(){
    recList.innerHTML='';
    recData.forEach((r,i)=>{
      const wrap = document.createElement('div'); wrap.className='card'; wrap.style.padding='12px';
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Name <input data-k="name" data-i="${i}" value="${(r.name||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Year <input data-k="year" data-i="${i}" value="${r.year||''}"></label>
          <label>Program <input data-k="program" data-i="${i}" value="${(r.program||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Hometown <input data-k="hometown" data-i="${i}" value="${(r.hometown||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Photo URL <input data-k="photo" data-i="${i}" value="${(r.photo||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label style="grid-column:1/-1">Blurb <textarea data-k="blurb" data-i="${i}" rows="3">${(r.blurb||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</textarea></label>
        </div>
        <div style="margin-top:8px"><button class="btn outline" data-remove="${i}">Remove</button></div>
      `;
      wrap.addEventListener('input', (e)=>{
        const t=e.target; if(!t.dataset||!('i' in t.dataset)) return;
        const idx=+t.dataset.i, k=t.dataset.k; if(!k) return;
        recData[idx]=recData[idx]||{}; recData[idx][k] = t.tagName==='TEXTAREA'? t.value : t.value;
      });
      wrap.querySelector('[data-remove]')?.addEventListener('click',()=>{ recData.splice(i,1); renderRecipients(); });
      recList.appendChild(wrap);
    });
  }
  async function loadRecipients(){
    try{ const txt = await readText(dir, 'content/scholarship-recipients.json'); const arr = JSON.parse(txt||'[]'); recData = Array.isArray(arr)? arr: []; }
    catch{ recData=[]; }
    renderRecipients();
  }
  document.getElementById('rec-add').addEventListener('click',()=>{ recData.push({year:new Date().getFullYear(), name:'', program:'', hometown:'', blurb:'', photo:''}); renderRecipients(); });
  document.getElementById('rec-save').addEventListener('click', async()=>{
    if(!dir){ alert('Open your repo folder first.'); return; }
    const cleaned = recData.filter(x => (x.name||'').trim());
    await writeText(dir, 'content/scholarship-recipients.json', JSON.stringify(cleaned,null,2));
    document.getElementById('rec-msg').textContent = `Saved ${cleaned.length} recipient(s)`;
    document.getElementById('rec-msg').className = 'ok';
    alert('Recipients saved. Commit & push in GitHub Desktop to publish.');
  });

  // Load recipients after picking directory
  $('#pick').addEventListener('click', () => {
    const iv = setInterval(() => { if(dir){ clearInterval(iv); loadRecipients(); } }, 300);
  });

  // ================================
  // Newsletter posts editor
  // ================================
  let nlData = [];
  const nlList = document.getElementById('nl-list');
  function renderNewsletters(){
    nlList.innerHTML='';
    nlData.forEach((p,i)=>{
      const wrap = document.createElement('div'); wrap.className='card'; wrap.style.padding='12px';
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Title <input data-k="title" data-i="${i}" value="${(p.title||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Date <input type="date" data-k="date" data-i="${i}" value="${(p.date||'').slice(0,10)}"></label>
          <label>URL <input data-k="url" data-i="${i}" value="${(p.url||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Attachment <input data-k="attachment" data-i="${i}" value="${(p.attachment||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label style="grid-column:1/-1">Summary <textarea data-k="summary" data-i="${i}" rows="3">${(p.summary||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</textarea></label>
        </div>
        <div style="margin-top:8px"><button class="btn outline" data-remove="${i}">Remove</button></div>
      `;
      wrap.addEventListener('input',(e)=>{
        const t=e.target; if(!t.dataset||!('i' in t.dataset)) return;
        const idx=+t.dataset.i, k=t.dataset.k; if(!k) return;
        nlData[idx]=nlData[idx]||{}; nlData[idx][k] = t.tagName==='TEXTAREA'? t.value : t.value;
      });
      wrap.querySelector('[data-remove]')?.addEventListener('click',()=>{ nlData.splice(i,1); renderNewsletters(); });
      nlList.appendChild(wrap);
    });
  }
  async function loadNewsletters(){
    try{ const txt = await readText(dir, 'newsletters/posts.json'); const arr = JSON.parse(txt||'[]'); nlData = Array.isArray(arr)? arr: []; }
    catch{ nlData=[]; }
    renderNewsletters();
  }
  document.getElementById('nl-add').addEventListener('click',()=>{ nlData.push({date:new Date().toISOString().slice(0,10), title:'', url:'', attachment:'', summary:''}); renderNewsletters(); });
  document.getElementById('nl-save').addEventListener('click', async()=>{
    if(!dir){ alert('Open your repo folder first.'); return; }
    const cleaned = nlData.filter(x => (x.title||'').trim());
    await writeText(dir, 'newsletters/posts.json', JSON.stringify(cleaned,null,2));
    document.getElementById('nl-msg').textContent = `Saved ${cleaned.length} post(s)`;
    document.getElementById('nl-msg').className = 'ok';
    alert('Newsletter posts saved. Commit & push in GitHub Desktop to publish.');
  });

  // Load newsletter posts after picking directory
  $('#pick').addEventListener('click', () => {
    const iv = setInterval(() => { if(dir){ clearInterval(iv); loadNewsletters(); } }, 300);
  });

  // =============================
  // News posts editor (news/posts.json)
  // =============================
  let newsData = [];
  const newsList = document.getElementById('news-list');
  function renderNews(){
    newsList.innerHTML='';
    newsData.forEach((p,i)=>{
      const wrap = document.createElement('div'); wrap.className='card'; wrap.style.padding='12px';
      const fileSafe = (p.file||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;');
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Slug <input data-k="slug" data-i="${i}" value="${(p.slug||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Title <input data-k="title" data-i="${i}" value="${(p.title||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Date <input type="date" data-k="date" data-i="${i}" value="${(p.date||'').slice(0,10)}"></label>
          <label>Author <input data-k="author" data-i="${i}" value="${(p.author||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label style="grid-column:1/-1">File <input data-k="file" data-i="${i}" value="${fileSafe}" placeholder="/news/posts/{slug}.md"></label>
          <label><input type="checkbox" data-k="published" data-i="${i}" ${p.published? 'checked':''}> Published</label>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" data-newmd="${i}">New Markdown</button>
          <a class="btn outline" href="/news/index.html?p=${encodeURIComponent(p.slug||'')}" target="_blank">Preview</a>
          <button class="btn outline" data-remove="${i}">Remove</button>
        </div>
      `;
      wrap.addEventListener('input',(e)=>{
        const t=e.target; if(!t.dataset||!('i' in t.dataset)) return; const idx=+t.dataset.i; const k=t.dataset.k; if(!k) return;
        newsData[idx]=newsData[idx]||{}; newsData[idx][k] = t.value;
      });
      wrap.querySelector('[data-newmd]')?.addEventListener('click', async ()=>{
        if(!dir){ alert('Open your repo folder first.'); return; }
        const rec = newsData[i] || {}; const slug = (rec.slug||'').trim(); if(!slug){ alert('Enter a slug first.'); return; }
        const postsDir = await ensureDir(dir, ['news','posts']);
        const name = `${slug}.md`;
        const fh = await postsDir.getFileHandle(name, {create:true});
        const w = await fh.createWritable();
        const md = `# ${rec.title||slug}\n\n_Date: ${rec.date||todayISO()} • Author: ${rec.author||'CVCWVUAA'}_\n\nWrite your post here.\n`;
        await w.write(md); await w.close();
        rec.file = `/news/posts/${name}`; renderNews(); alert(`Created /news/posts/${name}`);
      });
      wrap.querySelector('[data-remove]')?.addEventListener('click',()=>{ newsData.splice(i,1); renderNews(); });
      newsList.appendChild(wrap);
    });
  }
  async function loadNews(){
    try { const txt = await readText(dir, 'news/posts.json'); const arr = JSON.parse(txt||'[]'); newsData = Array.isArray(arr)? arr: []; }
    catch { newsData = []; }
    renderNews();
  }
  document.getElementById('news-add').addEventListener('click',()=>{ newsData.push({slug:'', title:'', date: todayISO(), author:'CVCWVUAA', file:'', published:false}); renderNews(); });
  document.getElementById('news-save').addEventListener('click', async ()=>{
    if(!dir){ alert('Open your repo folder first.'); return; }
    const cleaned = newsData.filter(x => (x.slug||'').trim() && (x.title||'').trim());
    await writeText(dir, 'news/posts.json', JSON.stringify(cleaned, null, 2));
    document.getElementById('news-msg').textContent = `Saved ${cleaned.length} post(s)`;
    document.getElementById('news-msg').className = 'ok';
    alert('News posts saved. Commit & push to publish.');
  });
  $('#pick').addEventListener('click', () => { const iv=setInterval(()=>{ if(dir){ clearInterval(iv); loadNews(); } }, 300); });

  // =============================
  // Events editor (events/events.json)
  // =============================
  let evData = [];
  const evList = document.getElementById('ev-list');
  function rsvpLinkFor(ev){ const title = encodeURIComponent(ev.title||''); const id = encodeURIComponent(ev.slug||''); return `/events/rsvp.html?game=${title}&eventId=${id}`; }
  function renderEvents(){
    evList.innerHTML='';
    evData.forEach((e,i)=>{
      const wrap = document.createElement('div'); wrap.className='card'; wrap.style.padding='12px';
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Slug <input data-k="slug" data-i="${i}" value="${(e.slug||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Title <input data-k="title" data-i="${i}" value="${(e.title||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Date <input type="date" data-k="date" data-i="${i}" value="${(e.date||'').slice(0,10)}"></label>
          <label>Time <input data-k="time" data-i="${i}" value="${(e.time||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label>Location <input data-k="location" data-i="${i}" value="${(e.location||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"></label>
          <label style="grid-column:1/-1">Description <textarea data-k="description" data-i="${i}" rows="3">${(e.description||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</textarea></label>
          <label><input type="checkbox" data-k="published" data-i="${i}" ${e.published? 'checked':''}> Published</label>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span class="small">RSVP Link:</span>
          <input readonly value="${rsvpLinkFor(e)}" style="flex:1;min-width:260px">
          <button class="btn" data-copy="${i}">Copy</button>
          <button class="btn outline" data-remove="${i}">Remove</button>
        </div>
      `;
      wrap.addEventListener('input',(evt)=>{
        const t=evt.target; if(!t.dataset||!('i' in t.dataset)) return; const idx=+t.dataset.i; const k=t.dataset.k; if(!k) return;
        evData[idx]=evData[idx]||{}; evData[idx][k] = t.tagName==='TEXTAREA'? t.value : t.value;
      });
      wrap.querySelector('[data-copy]')?.addEventListener('click',()=>{
        const link = rsvpLinkFor(evData[i]); navigator.clipboard.writeText(link).then(()=>alert('RSVP link copied to clipboard'));
      });
      wrap.querySelector('[data-remove]')?.addEventListener('click',()=>{ evData.splice(i,1); renderEvents(); });
      evList.appendChild(wrap);
    });
  }
  async function loadEvents(){
    try { const txt = await readText(dir, 'events/events.json'); const arr = JSON.parse(txt||'[]'); evData = Array.isArray(arr)? arr: []; }
    catch { evData = []; }
    renderEvents();
  }
  document.getElementById('ev-add').addEventListener('click',()=>{ evData.push({slug:'', title:'', date: todayISO(), time:'', location:'', description:'', published:false}); renderEvents(); });
  document.getElementById('ev-save').addEventListener('click', async ()=>{
    if(!dir){ alert('Open your repo folder first.'); return; }
    const cleaned = evData.filter(x => (x.slug||'').trim() && (x.title||'').trim());
    await writeText(dir, 'events/events.json', JSON.stringify(cleaned, null, 2));
    document.getElementById('ev-msg').textContent = `Saved ${cleaned.length} event(s)`;
    document.getElementById('ev-msg').className = 'ok';
    alert('Events saved. Commit & push to publish.');
  });
  $('#pick').addEventListener('click', () => { const iv=setInterval(()=>{ if(dir){ clearInterval(iv); loadEvents(); } }, 300); });

  // =============================
  // Board Members editor (content/board-members.json)
  // =============================
  let boardData = [];
  const boardList = document.getElementById('board-list');
  
  function renderBoard(){
    boardList.innerHTML='';
    boardData.forEach((member,i)=>{
      const wrap = document.createElement('div'); 
      wrap.className='card'; 
      wrap.style.padding='12px';
      wrap.innerHTML = `
        <div class="grid grid-2">
          <label>Position <input data-k="position" data-i="${i}" value="${(member.position||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="e.g., President"></label>
          <label>Name <input data-k="name" data-i="${i}" value="${(member.name||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="e.g., John Smith"></label>
          <label>Phone <input data-k="phone" data-i="${i}" type="tel" value="${(member.phone||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="e.g., (555) 123-4567"></label>
          <label>Email <input data-k="email" data-i="${i}" type="email" value="${(member.email||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="e.g., president@cvcwvuaa.org"></label>
          <label style="grid-column:1/-1">Degree <input data-k="degree" data-i="${i}" value="${(member.degree||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="e.g., BS Computer Science '95, MBA '98"></label>
        </div>
        <div style="margin-top:8px;">
          <button class="btn outline" data-remove="${i}">Remove Position</button>
        </div>
      `;
      
      wrap.addEventListener('input',(evt)=>{
        const t=evt.target; 
        if(!t.dataset||!('i' in t.dataset)) return; 
        const idx=+t.dataset.i; 
        const k=t.dataset.k; 
        if(!k) return;
        boardData[idx]=boardData[idx]||{}; 
        if(t.type==='checkbox') {
          boardData[idx][k] = t.checked;
        } else {
          boardData[idx][k] = t.value;
        }
      });
      
      wrap.querySelector('[data-remove]')?.addEventListener('click',()=>{ 
        if(confirm('Remove this board position?')) {
          boardData.splice(i,1); 
          renderBoard(); 
        }
      });
      
      boardList.appendChild(wrap);
    });
  }
  
  async function loadBoard(){
    try { 
      const txt = await readText(dir, 'content/board-members.json'); 
      const arr = JSON.parse(txt||'[]'); 
      boardData = Array.isArray(arr)? arr: []; 
    }
    catch { 
      boardData = [
        {position: 'President', name: '', phone: '', email: '', degree: ''},
        {position: 'Vice President', name: '', phone: '', email: '', degree: ''},
        {position: 'Secretary', name: '', phone: '', email: '', degree: ''},
        {position: 'Treasurer', name: '', phone: '', email: '', degree: ''},
        {position: 'Activities', name: '', phone: '', email: '', degree: ''},
        {position: 'Communications', name: '', phone: '', email: '', degree: ''},
        {position: 'Member At Large', name: '', phone: '', email: '', degree: ''},
        {position: 'Past President', name: '', phone: '', email: '', degree: ''}
      ]; 
    }
    renderBoard();
  }
  
  document.getElementById('board-add').addEventListener('click',()=>{ 
    boardData.push({position: 'Member At Large', name: '', phone: '', email: '', degree: ''}); 
    renderBoard(); 
  });
  
  document.getElementById('board-save').addEventListener('click', async ()=>{
    if(!dir){ alert('Open your repo folder first.'); return; }
    await writeText(dir, 'content/board-members.json', JSON.stringify(boardData, null, 2));
    document.getElementById('board-msg').textContent = `Saved ${boardData.length} board position(s)`;
    document.getElementById('board-msg').className = 'ok';
    alert('Board members saved. Commit & push to publish.');
  });
  
  $('#pick').addEventListener('click', () => { 
    const iv=setInterval(()=>{ 
      if(dir){ 
        clearInterval(iv); 
        loadBoard(); 
      } 
    }, 300); 
  });
</script>
    <!-- WVU Footer Component -->
    <div id="wvu-footer"></div>

    <!-- Load WVU Components -->
    <script src="/includes/component-loader.min.js"></script>
</body>
</html>
