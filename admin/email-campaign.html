<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Campaigns | Admin Panel</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/wvu-components.min.css">
    <style>
        .manager-container { max-width: 1200px; margin: 2rem auto; padding: 2rem; }
        .manager-header { background: linear-gradient(135deg, #002855, #1e40af); color: white; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 2rem; }
        .campaign-builder { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; color: #002855; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; }
        textarea.form-control { min-height: 250px; font-family: monospace; }
        .template-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .template-btn { padding: 8px 16px; background: #EAAA00; color: #002855; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .template-btn:hover { background: #d49a00; }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn { padding: 12px 30px; background: #002855; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
        .btn:hover { background: #1e40af; }
        .btn-send { background: #28a745; }
        .btn-send:hover { background: #218838; }
        .btn-test { background: #EAAA00; color: #002855; }
        .btn-test:hover { background: #d49a00; }
        .stats-box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .stat-item { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
        .recipient-count { font-size: 13px; color: #666; font-weight: normal; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px; }
        .quick-action-btn { padding: 20px; background: white; border: 2px solid #002855; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .quick-action-btn:hover { background: #002855; color: white; }
        .loading { display: none; text-align: center; padding: 20px; color: #666; }
        .loading.active { display: block; }
        .back-link { display: inline-block; margin-bottom: 2rem; color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <!-- WVU Masthead Component -->
    <div id="wvu-masthead"></div>

    <!-- WVU Primary Navigation Component -->
    <div id="wvu-navigation"></div>

    <!-- Back to Dashboard Button -->
    <div class="back-to-dashboard" style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
        <a href="/admin/dashboard.html" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #002855, #1e40af); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <span style="font-size: 1.2rem;">‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>

    <div class="manager-container">
        <a href="index.html" class="back-link">‚Üê Back to Admin Hub</a>
        
        <div class="manager-header">
            <h1>üìß Quick Campaigns</h1>
            <p>Send targeted emails to specific member groups</p>
        </div>

        <!-- Member Stats -->
        <div class="stats-box">
            <h3>Current Membership Stats</h3>
            <div class="stat-item">
                <strong>Total Members:</strong> <span id="stat-total">Loading...</span>
            </div>
            <div class="stat-item">
                <strong>Current 2025 Members:</strong> <span id="stat-current">Loading...</span>
            </div>
            <div class="stat-item">
                <strong>Unpaid 2025 Dues:</strong> <span id="stat-unpaid">Loading...</span>
            </div>
            <div class="stat-item">
                <strong>Board Members:</strong> <span id="stat-board">Loading...</span>
            </div>
        </div>

        <!-- Campaign Builder -->
        <div class="campaign-builder">
            <h2>Create Campaign</h2>
            
            <div class="form-group">
                <label>Quick Templates:</label>
                <div class="template-buttons">
                    <button class="template-btn" onclick="useTemplate('dues')">Dues Reminder</button>
                    <button class="template-btn" onclick="useTemplate('event')">Event Invitation</button>
                    <button class="template-btn" onclick="useTemplate('newsletter')">Newsletter</button>
                    <button class="template-btn" onclick="useTemplate('welcome')">Welcome Email</button>
                    <button class="template-btn" onclick="useTemplate('board')">Board Recruitment</button>
                </div>
            </div>

            <div class="form-group">
                <label for="campaign-subject">Subject Line:</label>
                <input type="text" id="campaign-subject" class="form-control" placeholder="Enter email subject">
            </div>

            <div class="form-group">
                <label for="campaign-recipients">Send To: <span class="recipient-count" id="recipient-count"></span></label>
                <select id="campaign-recipients" class="form-control" onchange="updateRecipientCount()">
                    <option value="">-- Select Recipient Group --</option>
                    <option value="all">All Members</option>
                    <option value="current">Current 2025 Members Only</option>
                    <option value="unpaid">Unpaid 2025 Dues Only</option>
                    <option value="board">Board Members Only</option>
                </select>
            </div>

            <div class="form-group">
                <label for="campaign-content">Email Content (Plain Text):</label>
                <textarea id="campaign-content" class="form-control" placeholder="Enter email message"></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn btn-test" onclick="sendTestEmail()">Send Test to Admin</button>
                <button class="btn btn-send" onclick="sendCampaign()">Send Campaign</button>
            </div>

            <div class="loading" id="loading">
                Sending emails... Please wait.
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" onclick="quickDuesReminder()">
                <h4>üìã Dues Reminder</h4>
                <p>Send to unpaid members</p>
            </div>
            <div class="quick-action-btn" onclick="window.location.href='newsletter-manager.html'">
                <h4>üì∞ Newsletter Manager</h4>
                <p>Full newsletter builder</p>
            </div>
            <div class="quick-action-btn" onclick="window.location.href='member-manager.html'">
                <h4>üë• Member Manager</h4>
                <p>View all members</p>
            </div>
            <div class="quick-action-btn" onclick="window.location.href='email-config.html'">
                <h4>‚öôÔ∏è Email Settings</h4>
                <p>Configure email system</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        let memberStats = {
            total: 0,
            current: 0,
            unpaid: 0,
            board: 0
        };

        // Load member statistics
        function loadStats() {
            db.collection('members').get().then(snapshot => {
                const members = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                memberStats.total = members.length;
                
                // Count current members (paid 2025)
                memberStats.current = members.filter(m => 
                    m.payments && m.payments.some(p => 
                        p.year === '2025' && p.amount >= 25
                    )
                ).length;
                
                // Count unpaid (all members minus current)
                memberStats.unpaid = memberStats.total - memberStats.current;
                
                // Count board members (you can adjust this logic)
                memberStats.board = members.filter(m => m.role === 'board' || m.isBoard === true).length;
                
                // Update UI
                document.getElementById('stat-total').textContent = memberStats.total;
                document.getElementById('stat-current').textContent = memberStats.current;
                document.getElementById('stat-unpaid').textContent = memberStats.unpaid;
                document.getElementById('stat-board').textContent = memberStats.board;
            }).catch(error => {
                console.error('Error loading stats:', error);
                alert('Error loading member stats. Please refresh.');
            });
        }

        // Update recipient count when selection changes
        function updateRecipientCount() {
            const type = document.getElementById('campaign-recipients').value;
            const countSpan = document.getElementById('recipient-count');
            
            if (!type) {
                countSpan.textContent = '';
                return;
            }
            
            const count = type === 'all' ? memberStats.total :
                         type === 'current' ? memberStats.current :
                         type === 'unpaid' ? memberStats.unpaid :
                         type === 'board' ? memberStats.board : 0;
            
            countSpan.textContent = `(${count} recipients)`;
        }

        // Load email templates
        function useTemplate(type) {
            const templates = {
                dues: {
                    subject: '2025 Chapter Membership Dues - Payment Due',
                    content: `Dear Fellow Mountaineer,

Your 2025 Central Virginia Chapter membership dues of $25 are now due.

Your continued support helps us:
‚Ä¢ Host exciting chapter events
‚Ä¢ Support local WVU students
‚Ä¢ Maintain our strong alumni network

Pay online at: https://cvawvuaa.org/pay.html
Or mail check to: CVCWVUAA, P.O. Box 5628, Midlothian, VA 23112

Thank you for your continued support!

Go Mountaineers!
Timothy Casten, President`
                },
                event: {
                    subject: 'You\'re Invited: [Event Name]',
                    content: `Dear Chapter Members,

You're invited to our upcoming event:

[Event Details]
Date: [Date]
Time: [Time]
Location: [Location]

Join fellow Mountaineers for an evening of fun and fellowship!

RSVP at: https://cvawvuaa.org/events.html

Hope to see you there!

Go Mountaineers!`
                },
                newsletter: {
                    subject: 'CVCWVUAA Monthly Newsletter',
                    content: `Dear Fellow Mountaineers,

[Newsletter Content Here]

Upcoming Events:
[List events]

Chapter News:
[Chapter updates]

Go Mountaineers!

--
For a full HTML newsletter, use the Newsletter Manager.`
                },
                welcome: {
                    subject: 'Welcome to the Central Virginia WVU Alumni Chapter!',
                    content: `Dear New Member,

Welcome to the Central Virginia Chapter of the WVU Alumni Association!

We're excited to have you join our community of proud Mountaineers in the Richmond area.

What's Next:
‚Ä¢ Visit our website: https://cvawvuaa.org
‚Ä¢ Check out upcoming events: https://cvawvuaa.org/events.html
‚Ä¢ Follow us on social media

Questions? Email us at cvcwvuaa@gmail.com

Go Mountaineers!
Timothy Casten, President`
                },
                board: {
                    subject: 'Help Lead Your Chapter - Board Positions Available',
                    content: `Dear Fellow Mountaineers,

Our chapter needs YOU! We have several board positions available and are looking for dedicated alumni to help lead our chapter.

Available Positions:
‚Ä¢ Vice President
‚Ä¢ Secretary
‚Ä¢ Board Members at Large

Why join the board?
‚Ä¢ Make a real difference in your local WVU community
‚Ä¢ Network with fellow alumni leaders
‚Ä¢ Help shape chapter activities and direction

Time commitment: ~2-3 hours per month

Interested? Reply to this email or contact us at cvcwvuaa@gmail.com

Go Mountaineers!`
                }
            };
            
            const template = templates[type];
            if (template) {
                document.getElementById('campaign-subject').value = template.subject;
                document.getElementById('campaign-content').value = template.content;
            }
        }

        // Get recipients based on selection
        async function getRecipients(type) {
            const snapshot = await db.collection('members').get();
            const members = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            
            if (type === 'all') {
                return members;
            } else if (type === 'current') {
                return members.filter(m => 
                    m.payments && m.payments.some(p => p.year === '2025' && p.amount >= 25)
                );
            } else if (type === 'unpaid') {
                return members.filter(m => 
                    !m.payments || !m.payments.some(p => p.year === '2025' && p.amount >= 25)
                );
            } else if (type === 'board') {
                return members.filter(m => m.role === 'board' || m.isBoard === true);
            }
            return [];
        }

        // Send test email to admin
        async function sendTestEmail() {
            const subject = document.getElementById('campaign-subject').value;
            const content = document.getElementById('campaign-content').value;
            
            if (!subject || !content) {
                alert('Please fill in subject and content first.');
                return;
            }
            
            try {
                await db.collection('mail').add({
                    to: 'cvcwvuaa@gmail.com',
                    message: {
                        subject: '[TEST] ' + subject,
                        text: content
                    }
                });
                
                alert('Test email sent to cvcwvuaa@gmail.com');
            } catch (error) {
                console.error('Error sending test:', error);
                alert('Error sending test email: ' + error.message);
            }
        }

        // Send campaign
        async function sendCampaign() {
            const subject = document.getElementById('campaign-subject').value;
            const content = document.getElementById('campaign-content').value;
            const recipientType = document.getElementById('campaign-recipients').value;
            
            if (!subject || !content || !recipientType) {
                alert('Please fill in all fields and select recipient group.');
                return;
            }
            
            const recipients = await getRecipients(recipientType);
            
            if (recipients.length === 0) {
                alert('No recipients found for selected group.');
                return;
            }
            
            const confirmed = confirm(`Send email to ${recipients.length} recipients?\n\nSubject: ${subject}\n\nThis cannot be undone.`);
            if (!confirmed) return;
            
            document.getElementById('loading').classList.add('active');
            
            try {
                // Send in batches of 50 via BCC
                const batchSize = 50;
                for (let i = 0; i < recipients.length; i += batchSize) {
                    const batch = recipients.slice(i, i + batchSize);
                    const bccList = batch.map(m => m.email).filter(e => e);
                    
                    if (bccList.length > 0) {
                        await db.collection('mail').add({
                            to: 'cvcwvuaa@gmail.com',
                            bcc: bccList,
                            message: {
                                subject: subject,
                                text: content
                            }
                        });
                    }
                }
                
                document.getElementById('loading').classList.remove('active');
                alert(`Campaign sent successfully to ${recipients.length} recipients!`);
                
                // Clear form
                document.getElementById('campaign-subject').value = '';
                document.getElementById('campaign-content').value = '';
                document.getElementById('campaign-recipients').value = '';
                updateRecipientCount();
                
            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                console.error('Error sending campaign:', error);
                alert('Error sending campaign: ' + error.message);
            }
        }

        // Quick action: Dues reminder
        function quickDuesReminder() {
            document.getElementById('campaign-recipients').value = 'unpaid';
            updateRecipientCount();
            useTemplate('dues');
            window.scrollTo(0, 0);
        }

        // Initialize
        loadStats();
    </script>

    <!-- WVU Footer Component -->
    <div id="wvu-footer"></div>

    <!-- Load WVU Components -->
    <script src="/includes/component-loader.min.js"></script>
</body>
</html>
