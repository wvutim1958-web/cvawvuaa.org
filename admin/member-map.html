<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Location Map - CVCWVUAA</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }
        .header h1 {
            margin: 0 0 0.5rem;
            color: #002855;
            font-size: 1.5rem;
        }
        .header p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .stats h3 {
            margin: 0 0 0.5rem;
            color: #002855;
            font-size: 1rem;
        }
        .stats p {
            margin: 0.25rem 0;
            color: #666;
            font-size: 0.85rem;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }
        .loading.hide {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Member Map</h1>
        <p>Central Virginia Chapter Members</p>
    </div>
    
    <div class="stats">
        <h3>üìä Statistics</h3>
        <p><strong>Total Members:</strong> <span id="totalMembers">0</span></p>
        <p><strong>Mapped:</strong> <span id="mappedMembers">0</span></p>
        <p><strong>Richmond Area:</strong> <span id="richmondCount">0</span></p>
        <p><strong>Other Areas:</strong> <span id="otherCount">0</span></p>
    </div>
    
    <div id="loading" class="loading">
        <h2 style="color: #002855; margin: 0 0 1rem;">Loading Members...</h2>
        <p style="color: #666;">Geocoding addresses...</p>
    </div>
    
    <div id="map"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/admin/js/firebase-config.js"></script>
    
    <!-- Leaflet (OpenStreetMap) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map centered on Richmond, VA
        const map = L.map('map').setView([37.5407, -77.4360], 10);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        let totalMembers = 0;
        let mappedMembers = 0;
        let richmondCount = 0;
        let otherCount = 0;
        
        // Custom small pin-shaped marker
        const wvuIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <svg width="16" height="22" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                    <!-- Pin shape -->
                    <path d="M15,0 C6.716,0 0,6.716 0,15 C0,25 15,40 15,40 C15,40 30,25 30,15 C30,6.716 23.284,0 15,0 Z" 
                          fill="#dc3545" stroke="#8b0000" stroke-width="1"/>
                    <!-- Inner circle -->
                    <circle cx="15" cy="15" r="6" fill="white" opacity="0.9"/>
                </svg>
            `,
            iconSize: [16, 22],
            iconAnchor: [8, 22],
            popupAnchor: [0, -22]
        });
        
        async function geocodeAddress(address, city, state, zip) {
            // Build full address
            const fullAddress = `${address}, ${city}, ${state} ${zip}`;
            
            try {
                // Use Nominatim (OpenStreetMap) geocoding service
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` + 
                    `q=${encodeURIComponent(fullAddress)}&format=json&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'CVCWVUAA Member Map'
                        }
                    }
                );
                
                // Check for rate limiting
                if (response.status === 429) {
                    console.warn('Rate limited, waiting 5 seconds...');
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    return await geocodeAddress(address, city, state, zip); // Retry
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                console.warn(`No coordinates found for: ${fullAddress}`);
                return null;
            } catch (error) {
                console.error('Geocoding error for', fullAddress, ':', error);
                return null;
            }
        }
        
        async function loadMembers() {
            try {
                const membersSnapshot = await db.collection('members').get();
                totalMembers = membersSnapshot.size;
                
                const members = [];
                membersSnapshot.forEach(doc => {
                    const memberData = doc.data();
                    
                    // Skip test accounts
                    const email = (memberData.email || '').toLowerCase();
                    const name = (memberData.name || '').toLowerCase();
                    const isTest = email.includes('test') || name.includes('test') || name === 'santa claus';
                    
                    if (!isTest && memberData.address && memberData.city && memberData.state) {
                        console.log(`Adding member: ${memberData.name}, State: ${memberData.state}, City: ${memberData.city}`);
                        members.push({
                            id: doc.id,
                            name: memberData.name,
                            address: memberData.address,
                            city: memberData.city,
                            state: memberData.state,
                            zip: memberData.zip || '',
                            status: memberData.status || 'unknown'
                        });
                    }
                });
                
                console.log(`Found ${members.length} members with addresses`);
                
                // Geocode and add markers
                const markers = [];
                let processed = 0;
                
                for (const member of members) {
                    processed++;
                    console.log(`Processing ${processed}/${members.length}: ${member.name} - ${member.city}, ${member.state}`);
                    
                    try {
                        const coords = await geocodeAddress(
                            member.address, 
                            member.city, 
                            member.state, 
                            member.zip
                        );
                        
                        if (coords) {
                            // Add marker
                            const marker = L.marker([coords.lat, coords.lng], { icon: wvuIcon })
                                .addTo(map);
                            
                            markers.push(marker);
                            
                            // Add popup
                            marker.bindPopup(`
                                <div style="font-family: sans-serif;">
                                    <h3 style="margin: 0 0 0.5rem; color: #002855;">${member.name}</h3>
                                    <p style="margin: 0.25rem 0; font-size: 0.9rem;">
                                        üìç ${member.city}, ${member.state}
                                    </p>
                                    <p style="margin: 0.25rem 0; font-size: 0.85rem; color: #666;">
                                        Status: ${member.status}
                                    </p>
                                </div>
                            `);
                            
                            mappedMembers++;
                            
                            // Count Richmond area vs others
                            const richmondCities = ['richmond', 'henrico', 'glen allen', 'mechanicsville', 'midlothian', 'chesterfield'];
                            if (richmondCities.some(city => member.city.toLowerCase().includes(city))) {
                                richmondCount++;
                            } else {
                                otherCount++;
                            }
                            
                            updateStats();
                        } else {
                            console.log(`Failed to geocode: ${member.name} - ${member.address}, ${member.city}, ${member.state}`);
                        }
                        
                        // Longer delay to avoid rate limiting (2 seconds between requests)
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                    } catch (error) {
                        console.error(`Error processing ${member.name}:`, error);
                        // Continue with next member even if this one fails
                        continue;
                    }
                }
                
                // Hide loading
                document.getElementById('loading').classList.add('hide');
                
                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                console.log(`Mapped ${mappedMembers} out of ${members.length} members`);
                
            } catch (error) {
                console.error('Error loading members:', error);
                alert('Error loading member data. Check console for details.');
            }
        }
        
        function updateStats() {
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('mappedMembers').textContent = mappedMembers;
            document.getElementById('richmondCount').textContent = richmondCount;
            document.getElementById('otherCount').textContent = otherCount;
        }
        
        // Load members on page load
        loadMembers();
    </script>
</body>
</html>
