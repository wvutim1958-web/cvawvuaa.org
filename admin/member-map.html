<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; background: #003366; font-family: sans-serif; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        h1 { color: #003366; margin: 0; }
        #map { height: 600px; width: 100%; border: 2px solid #003366; }
        .stats { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 20px; justify-content: space-around; }
        .stat { text-align: center; }
        .stat-num { font-size: 32px; font-weight: bold; color: #EAAA00; }
        .stat-label { font-size: 14px; color: #666; }
        .back { display: inline-block; color: white; text-decoration: none; padding: 10px 15px; background: #EAAA00; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin/member-database.html" class="back">‚Üê Back</a>
        <div class="header">
            <h1>üìç Member Map</h1>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-num" id="total">0</div><div class="stat-label">Total</div></div>
            <div class="stat"><div class="stat-num" id="active">0</div><div class="stat-label">Active</div></div>
            <div class="stat"><div class="stat-num" id="mapped">0</div><div class="stat-label">Mapped</div></div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px;">
            <div id="map"></div>
            <div id="progress" style="margin-top: 15px; text-align: center;">
                <div id="text" style="color: #666;">Loading members...</div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const members = [
            {name: "Aaron & Kristin Rife", status: "inactive", city: "Chester", state: "VA", zip: "23831"},
            {name: "Abigail Roberts", status: "inactive", city: "Charlottesville", state: "VA", zip: "22902"},
            {name: "Addison Bradley", status: "inactive", city: "Powhatan", state: "VA", zip: "23139"},
            {name: "Al & Marsha Dietz", status: "inactive", city: "Richmond", state: "VA", zip: "23229"},
            {name: "Alecia Daves-Johnson", status: "inactive", city: "Prospect", state: "VA", zip: "23960"},
            {name: "Amy & Blake Boschen", status: "inactive", city: "Henrico", state: "VA", zip: "23238"},
            {name: "Andrew Chambers", status: "inactive", city: "Ashland", state: "VA", zip: "23005"},
            {name: "Anmarie & Rich Volta Collins", status: "inactive", city: "Wilsons", state: "VA", zip: "23894"},
            {name: "Annetta Reed & Thomas Riekel", status: "active", city: "Midlothian", state: "VA", zip: "23113"},
            {name: "Beth Rogers", status: "inactive", city: "Richmond", state: "VA", zip: "23227"},
            {name: "Bill & Karen Poole", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Bill & Sharon Gouckenour", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Bill Wilson", status: "inactive", city: "Chester", state: "VA", zip: "23831"},
            {name: "Bob & Martha Jones", status: "active", city: "Shenandoah", state: "VA", zip: "22849"},
            {name: "Bob & Sandy Whiteman", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Bob & Theresa Moffett, Jr.", status: "inactive", city: "Richmond", state: "VA", zip: "23225"},
            {name: "Bob Basham", status: "inactive", city: "Manakin-Sabot", state: "VA", zip: "23103"},
            {name: "Bowen & Lanetta Hyatt", status: "inactive", city: "Chester", state: "VA", zip: "23836"},
            {name: "Brian Jenkins", status: "active", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Carolyn Buletza", status: "inactive", city: "Richmond", state: "VA", zip: "23235"},
            {name: "Catherine Ziegler", status: "inactive", city: "Bel Air", state: "MD", zip: "21014"},
            {name: "Charles & Lisa Bradley", status: "inactive", city: "Richmond", state: "VA", zip: "23220"},
            {name: "Charles Chuck Riffee", status: "active", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Cherryll & Harry Jr. Ellis", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Christina Sullivan", status: "inactive", city: "North Chesterfield", state: "VA", zip: "23234"},
            {name: "Cindi Woody", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Cindy Lawson", status: "active", city: "Chester", state: "VA", zip: "23831"},
            {name: "Clifford Gillham", status: "inactive", city: "Prince George", state: "VA", zip: "23875"},
            {name: "Curtis Hise", status: "inactive", city: "Colonial Heights", state: "VA", zip: "23834"},
            {name: "DR. Gary Hartwell", status: "active", city: "Richmond", state: "VA", zip: "23221"},
            {name: "David & Kristie Haines", status: "inactive", city: "Richmond", state: "VA", zip: "23235"},
            {name: "David & Vallerie Conley", status: "inactive", city: "Henrico", state: "VA", zip: "23294"},
            {name: "Dennis & Pamala Pack", status: "inactive", city: "Manakin Sabot", state: "VA", zip: "23103"},
            {name: "Domenick Casuccio", status: "inactive", city: "Henrico", state: "VA", zip: "23228"},
            {name: "Donal & Amy Hall", status: "inactive", city: "Chesterfield", state: "VA", zip: "23803"},
            {name: "Doug & Dawn & Doug Jr. Blackburn", status: "inactive", city: "Richmond", state: "VA", zip: "23223"},
            {name: "Dr. Elaine Traynelis Yurek", status: "inactive", city: "Manakin-Sabot", state: "VA", zip: "23013"},
            {name: "Dr. Michael Spinelli", status: "active", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Ed Douglas", status: "inactive", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Frank & Pat Lawson, Jr.", status: "inactive", city: "Ashland", state: "VA", zip: "23005"},
            {name: "George Sutton", status: "active", city: "Mechancisville", state: "VA", zip: "23111"},
            {name: "Harry, III Ellis III", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Haskell Brown , III", status: "active", city: "Richmond", state: "VA", zip: "23226"},
            {name: "Ike & Vickie Pethtel", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "J David & Zoie Murdock, Jr.", status: "inactive", city: "Chester", state: "VA", zip: "23836"},
            {name: "Jack & Cindy Heyl", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Jane Himmelman Lanham", status: "inactive", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Jay & Tracy Poling", status: "inactive", city: "Manakin Sabot", state: "VA", zip: "23103"},
            {name: "Jeanne Chapman", status: "inactive", city: "Richmond", state: "VA", zip: "23224"},
            {name: "Jeff Carlson", status: "inactive", city: "Chesterfield", state: "VA", zip: "23838"},
            {name: "Jeff Rohr", status: "inactive", city: "Mechanicsville", state: "VA", zip: "23116"},
            {name: "Jeff Wilson", status: "active", city: "Midlothian", state: "VA", zip: "23113"},
            {name: "Jeffrey & Brandon Layne", status: "active", city: "North Chesterfield", state: "VA", zip: "23236"},
            {name: "Jeffrey Lepard", status: "inactive", city: "Miidlothian", state: "VA", zip: "23112"},
            {name: "Jen & Michael Condaras", status: "active", city: "Richmond", state: "VA", zip: "23228"},
            {name: "Jenny Alsop", status: "inactive", city: "Richmond", state: "VA", zip: "23223"},
            {name: "Jerry MacAulay", status: "inactive", city: "N. Chesterfield", state: "VA", zip: "23235"},
            {name: "Jim & Miriam Wickham, MD", status: "inactive", city: "Richmond", state: "VA", zip: "23235"},
            {name: "John & Annetta Murdock", status: "inactive", city: "S. Chesterfield", state: "VA", zip: "23834"},
            {name: "John Boston", status: "inactive", city: "North Chesterfield", state: "VA", zip: "61368"},
            {name: "John Radford", status: "inactive", city: "Chester", state: "VA", zip: "23831"},
            {name: "John Stolarik", status: "active", city: "Chester", state: "VA", zip: "23831"},
            {name: "John Toutsi", status: "inactive", city: "Richmond", state: "VA", zip: "23231"},
            {name: "Joseph & MaryAngela Morgan", status: "inactive", city: "Richmond", state: "VA", zip: "23227"},
            {name: "Joseph Klages", status: "inactive", city: "Galveston", state: "TX", zip: "77550"},
            {name: "Josh Dietz", status: "inactive", city: "Richmond", state: "VA", zip: "23229"},
            {name: "Julia Council", status: "inactive", city: "North Chesterfield", state: "VA", zip: "23234"},
            {name: "Justin & Tiffany Madron", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Lauren (Lo) Hill", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Lindy Hill", status: "inactive", city: "Highland Springs", state: "VA", zip: "23075"},
            {name: "Marc & Debbie Halbritter", status: "inactive", city: "Hilton Head Island", state: "SC", zip: "29926"},
            {name: "Marcia & Michael Vick", status: "inactive", city: "Midlothian", state: "VA", zip: "23113"},
            {name: "Marge Dwyer", status: "active", city: "Chesterfield", state: "VA", zip: "23832"},
            {name: "Marianne & Jim Mohn", status: "active", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Mark & Stephanie Mabry", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Mark & Vicki Allen", status: "active", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Mark George", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Mark McCoy", status: "inactive", city: "Colonial Heights", state: "VA", zip: "23834"},
            {name: "Matthew & Kelli Phillips", status: "inactive", city: "Ashland", state: "VA", zip: "23005"},
            {name: "Mel Fletcher", status: "active", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Melissa Phillips", status: "active", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Michael & Meghan Keogh", status: "inactive", city: "N Chesterfield", state: "VA", zip: "23235"},
            {name: "Monty & Valorie Bennett", status: "inactive", city: "Chesterfield", state: "VA", zip: "23832"},
            {name: "Nancy R. Nicholls", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Nelson & Carol Richards", status: "inactive", city: "Richmond", state: "VA", zip: "23238"},
            {name: "Patrick & Ross Simms", status: "active", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Philip & Melissa Berry", status: "inactive", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Rebecca & Chase Morehouse Schuetz", status: "inactive", city: "Richmond", state: "VA", zip: "23226"},
            {name: "Rob & Teresa Estep", status: "inactive", city: "Manakin-Sabot", state: "VA", zip: "23103"},
            {name: "Robert & Pandora Benton", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "Robert & Shonna Meadows", status: "active", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Robert Billcheck", status: "inactive", city: "Providence Forge", state: "VA", zip: "23140"},
            {name: "Robert Gitttleson", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "Roger & Nancy Lovejoy", status: "active", city: "Richmond", state: "VA", zip: "23233"},
            {name: "Rosemary Salcedo", status: "inactive", city: "Richmond", state: "VA", zip: "23233"},
            {name: "Ryan Keller", status: "inactive", city: "Moseley", state: "VA", zip: "23120"},
            {name: "Samantha Teets", status: "inactive", city: "Ashland", state: "VA", zip: "23005"},
            {name: "Samuel & Debra Teets", status: "inactive", city: "Ashland", state: "VA", zip: "23005"},
            {name: "Saundra Whitson", status: "inactive", city: "Moseley", state: "VA", zip: "23120"},
            {name: "Scott & Jennifer Phillips", status: "active", city: "Manakin Sabot", state: "VA", zip: "23103"},
            {name: "Scott & Tim Radford", status: "inactive", city: "Glen Allen", state: "VA", zip: "23060"},
            {name: "Seth Ball", status: "inactive", city: "Chesapeake", state: "VA", zip: "23320"},
            {name: "Sharon & Melinda Young Mitchell Hill", status: "inactive", city: "Glen Allen", state: "VA", zip: "23235"},
            {name: "Sharon Lind Charles", status: "inactive", city: "Richmond", state: "VA", zip: "23229"},
            {name: "Sharon Noble", status: "inactive", city: "Richmond", state: "VA", zip: "23112"},
            {name: "Sherri Ellis", status: "inactive", city: "Richmond", state: "VA", zip: "23228"},
            {name: "Stephen Finch", status: "active", city: "Richmond", state: "VA", zip: "23229"},
            {name: "Stephen Siegrist", status: "inactive", city: "Chester", state: "VA", zip: "23836"},
            {name: "Stuart & Carol Solan", status: "inactive", city: "Richmond", state: "VA", zip: "23229"},
            {name: "Suzette Hutchens", status: "active", city: "", state: "VA", zip: ""},
            {name: "Tara Tyler", status: "inactive", city: "Richmond", state: "VA", zip: "23225"},
            {name: "Thomas & Mar Zahler", status: "active", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Thomas Simyak", status: "inactive", city: "Richmond", state: "VA", zip: "23224"},
            {name: "Timothy Casten", status: "active", city: "Chester", state: "VA", zip: "23831"},
            {name: "Todd Furbee", status: "inactive", city: "Henrico", state: "VA", zip: "23233"},
            {name: "Todd Picklesimer", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Tony & Nancy Scrimizzi", status: "active", city: "Midlothian", state: "VA", zip: "23113"},
            {name: "Travis Milburn", status: "active", city: "Richmond", state: "VA", zip: "23235"},
            {name: "Wes & Terri Keck", status: "inactive", city: "Glen Allen", state: "VA", zip: "23059"},
            {name: "William & Kimberly Ross", status: "inactive", city: "Midlothian", state: "VA", zip: "23114"},
            {name: "William & Marybeth Adams Blackburn", status: "inactive", city: "Mechanicsville", state: "VA", zip: "23116"},
            {name: "William Kertsos", status: "inactive", city: "Fredericksburg", state: "VA", zip: "22401"},
            {name: "Zachary Bradley", status: "inactive", city: "Midlothian", state: "VA", zip: "23112"},
            {name: "Zachary Brant", status: "inactive", city: "Richmond", state: "VA", zip: "23225"}
        ];
        
        let map = L.map('map').setView([37.5407, -77.4360], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap', maxZoom: 18}).addTo(map);
        
        function updateStatus(msg) {
            document.getElementById('text').innerHTML = msg;
        }
        
        const geocodeCache = {};
        
        async function geocode(city, state, zip) {
            if (!city && !zip) return null;
            
            const cacheKey = `${city},${state},${zip}`;
            if (geocodeCache[cacheKey]) return geocodeCache[cacheKey];
            
            // Use Google's free geocoding via their maps embed API
            // Build full address for best results
            const address = zip ? `${zip}, ${state}, USA` : `${city}, ${state}, USA`;
            
            try {
                // Use Nominatim with longer timeout
                const q = encodeURIComponent(address);
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1&addressdetails=1`, {
                    headers: {'User-Agent': 'CVAWVUAA/1.0'}
                });
                const d = await r.json();
                
                if (d && d[0]) {
                    const result = {lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon)};
                    geocodeCache[cacheKey] = result;
                    return result;
                }
                
                // If zip fails, try city+state
                if (zip && city) {
                    await new Promise(r => setTimeout(r, 1000));
                    const q2 = encodeURIComponent(`${city}, ${state}, USA`);
                    const r2 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q2}&limit=1`, {
                        headers: {'User-Agent': 'CVAWVUAA/1.0'}
                    });
                    const d2 = await r2.json();
                    if (d2 && d2[0]) {
                        const result = {lat: parseFloat(d2[0].lat), lng: parseFloat(d2[0].lon)};
                        geocodeCache[cacheKey] = result;
                        return result;
                    }
                }
                
                return null;
            } catch(e) { 
                console.error('Geocode error:', e);
                return null; 
            }
        }
        
        async function load() {
            const failed = [];
            let mapped = 0;
            
            for (let i = 0; i < members.length; i++) {
                const m = members[i];
                updateStatus(`Mapping ${i+1}/${members.length}: ${m.name}...`);
                
                // Try multiple approaches for each member
                let loc = null;
                
                // Approach 1: ZIP code (most accurate)
                if (m.zip) {
                    loc = await geocode(m.city, m.state, m.zip);
                }
                
                // Approach 2: City + State
                if (!loc && m.city) {
                    await new Promise(r => setTimeout(r, 1000));
                    loc = await geocode(m.city, m.state, null);
                }
                
                // Approach 3: Just State
                if (!loc) {
                    await new Promise(r => setTimeout(r, 1000));
                    loc = await geocode(null, m.state, null);
                }
                
                if (loc) {
                    const color = m.status === 'active' ? 'green' : 'orange';
                    L.circleMarker([loc.lat, loc.lng], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup(`
                        <b>${m.name}</b><br>
                        Status: ${m.status}<br>
                        ${m.city ? m.city + ', ' : ''}${m.state} ${m.zip || ''}
                    `);
                    mapped++;
                } else {
                    failed.push(m.name);
                }
                
                // Reduced delay - 2 seconds between members
                await new Promise(r => setTimeout(r, 2000));
            }
            
            const active = members.filter(m => m.status === 'active').length;
            const states = [...new Set(members.map(m => m.state))].length;
            
            updateStatus(`
                <b>Complete!</b><br>
                Total Members: ${members.length}<br>
                Active Members: ${active}<br>
                Successfully Mapped: ${mapped}<br>
                States Represented: ${states}
                ${failed.length > 0 ? '<br><br><b>Failed to map:</b><br>' + failed.join(', ') : ''}
            `);
        }
        
        load();
    </script>
</body>
</html>
