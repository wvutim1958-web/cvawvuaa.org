<!DOCTYPE html><!DOCTYPE html><!DOCTYPE html><!DOCTYPE html>

<html lang="en">

<head><html lang="en">

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"><head><html lang="en"><html lang="en">

    <title>Member Map - CVAWVUAA</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />    <meta charset="UTF-8">

    <style>

        * {    <meta name="viewport" content="width=device-width, initial-scale=1.0"><head><head>

            margin: 0;

            padding: 0;    <title>Member Map - CVAWVUAA</title>

            box-sizing: border-box;

        }    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />    <meta charset="UTF-8">    <meta charset="UTF-8">



        body {    <style>

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            background: linear-gradient(135deg, #003366 0%, #0062B1 100%);        * {    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="viewport" content="width=device-width, initial-scale=1.0">

            min-height: 100vh;

            padding: 20px;            margin: 0;

        }

            padding: 0;    <title>Member Geographic Distribution - CVAWVUAA Admin</title>    <title>Member Location Map - CVCWVUAA</title>

        .container {

            max-width: 1400px;            box-sizing: border-box;

            margin: 0 auto;

        }        }    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />    <style>



        .header {

            background: white;

            padding: 20px 30px;        body {    <style>        body {

            border-radius: 10px;

            box-shadow: 0 4px 6px rgba(0,0,0,0.1);            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            margin-bottom: 20px;

        }            background: linear-gradient(135deg, #003366 0%, #0062B1 100%);        * {            margin: 0;



        h1 {            min-height: 100vh;

            color: #003366;

            font-size: 28px;            padding: 20px;            margin: 0;            padding: 0;

            margin-bottom: 5px;

        }        }



        .subtitle {            padding: 0;            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            color: #666;

            font-size: 14px;        .container {

        }

            max-width: 1400px;            box-sizing: border-box;        }

        .stats-bar {

            background: white;            margin: 0 auto;

            padding: 15px 30px;

            border-radius: 10px;        }        }        #map {

            box-shadow: 0 4px 6px rgba(0,0,0,0.1);

            margin-bottom: 20px;

            display: flex;

            justify-content: space-around;        .header {            height: 100vh;

            flex-wrap: wrap;

            gap: 20px;            background: white;

        }

            padding: 20px 30px;        body {            width: 100%;

        .stat-item {

            text-align: center;            border-radius: 10px;

        }

            box-shadow: 0 4px 6px rgba(0,0,0,0.1);            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;        }

        .stat-number {

            font-size: 32px;            margin-bottom: 20px;

            font-weight: bold;

            color: #EAAA00;        }            background: linear-gradient(135deg, #003366 0%, #0062B1 100%);        .header {

        }



        .stat-label {

            font-size: 14px;        h1 {            min-height: 100vh;            position: absolute;

            color: #666;

            margin-top: 5px;            color: #003366;

        }

            font-size: 28px;            padding: 20px;            top: 20px;

        .map-container {

            background: white;            margin-bottom: 5px;

            padding: 20px;

            border-radius: 10px;        }        }            left: 20px;

            box-shadow: 0 4px 6px rgba(0,0,0,0.1);

        }



        #map {        .subtitle {            background: white;

            height: 600px;

            width: 100%;            color: #666;

            border-radius: 8px;

            border: 2px solid #003366;            font-size: 14px;        .container {            padding: 1.5rem;

        }

        }

        .legend {

            background: white;            max-width: 1400px;            border-radius: 12px;

            padding: 15px;

            border-radius: 8px;        .stats-bar {

            margin-top: 15px;

        }            background: white;            margin: 0 auto;            box-shadow: 0 4px 15px rgba(0,0,0,0.2);



        .legend h3 {            padding: 15px 30px;

            color: #003366;

            font-size: 16px;            border-radius: 10px;        }            z-index: 1000;

            margin-bottom: 10px;

        }            box-shadow: 0 4px 6px rgba(0,0,0,0.1);



        .legend-item {            margin-bottom: 20px;            max-width: 300px;

            display: flex;

            align-items: center;            display: flex;

            margin-bottom: 8px;

        }            justify-content: space-around;        .header {        }



        .legend-color {            flex-wrap: wrap;

            width: 20px;

            height: 20px;            gap: 20px;            background: white;        .header h1 {

            border-radius: 50%;

            margin-right: 10px;        }

            border: 2px solid #333;

        }            padding: 20px 30px;            margin: 0 0 0.5rem;



        .back-link {        .stat-item {

            display: inline-block;

            color: #003366;            text-align: center;            border-radius: 10px;            color: #002855;

            text-decoration: none;

            font-weight: 600;        }

            margin-bottom: 10px;

            padding: 8px 15px;            box-shadow: 0 4px 6px rgba(0,0,0,0.1);            font-size: 1.5rem;

            background: white;

            border-radius: 5px;        .stat-number {

        }

            font-size: 32px;            margin-bottom: 20px;        }

        .back-link:hover {

            background: #f0f0f0;            font-weight: bold;

        }

            color: #EAAA00;        }        .header p {

        .progress {

            background: white;        }

            padding: 20px;

            border-radius: 8px;            margin: 0;

            margin-top: 15px;

            text-align: center;        .stat-label {

        }

            font-size: 14px;        h1 {            color: #666;

        .progress-bar {

            width: 100%;            color: #666;

            height: 30px;

            background: #f0f0f0;            margin-top: 5px;            color: #003366;            font-size: 0.9rem;

            border-radius: 15px;

            overflow: hidden;        }

            margin-bottom: 10px;

        }            font-size: 28px;        }



        .progress-fill {        .map-container {

            height: 100%;

            background: linear-gradient(90deg, #EAAA00, #003366);            background: white;            margin-bottom: 5px;        .stats {

            transition: width 0.3s;

            display: flex;            padding: 20px;

            align-items: center;

            justify-content: center;            border-radius: 10px;        }            position: absolute;

            color: white;

            font-weight: bold;            box-shadow: 0 4px 6px rgba(0,0,0,0.1);

        }

    </style>        }            bottom: 20px;

</head>

<body>

    <div class="container">

        <a href="/admin/member-database.html" class="back-link">‚Üê Back to Member Database</a>        #map {        .subtitle {            right: 20px;

        

        <div class="header">            height: 600px;

            <h1>üìç Member Geographic Distribution</h1>

            <p class="subtitle">Central Virginia Chapter - WVU Alumni Association</p>            width: 100%;            color: #666;            background: white;

        </div>

            border-radius: 8px;

        <div class="stats-bar">

            <div class="stat-item">            border: 2px solid #003366;            font-size: 14px;            padding: 1rem;

                <div class="stat-number" id="totalMembers">0</div>

                <div class="stat-label">Total Members</div>        }

            </div>

            <div class="stat-item">        }            border-radius: 12px;

                <div class="stat-number" id="activeMembers">0</div>

                <div class="stat-label">Active Members</div>        .legend {

            </div>

            <div class="stat-item">            background: white;            box-shadow: 0 4px 15px rgba(0,0,0,0.2);

                <div class="stat-number" id="mappedMembers">0</div>

                <div class="stat-label">Mapped Locations</div>            padding: 15px;

            </div>

            <div class="stat-item">            border-radius: 8px;        .stats-bar {            z-index: 1000;

                <div class="stat-number" id="statesCount">0</div>

                <div class="stat-label">States</div>            margin-top: 15px;

            </div>

        </div>        }            background: white;        }



        <div class="map-container">

            <div id="map"></div>

                    .legend h3 {            padding: 15px 30px;        .stats h3 {

            <div class="progress" id="progressBar" style="display: none;">

                <div class="progress-bar">            color: #003366;

                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>

                </div>            font-size: 16px;            border-radius: 10px;            margin: 0 0 0.5rem;

                <div id="progressText">Loading members...</div>

            </div>            margin-bottom: 10px;

            

            <div class="legend">        }            box-shadow: 0 4px 6px rgba(0,0,0,0.1);            color: #002855;

                <h3>Legend</h3>

                <div class="legend-item">

                    <div class="legend-color" style="background: #00cc00;"></div>

                    <span>Active Members</span>        .legend-item {            margin-bottom: 20px;            font-size: 1rem;

                </div>

                <div class="legend-item">            display: flex;

                    <div class="legend-color" style="background: #ff6600;"></div>

                    <span>Inactive Members</span>            align-items: center;            display: flex;        }

                </div>

            </div>            margin-bottom: 8px;

        </div>

    </div>        }            justify-content: space-around;        .stats p {



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="/js/firebase-config.js"></script>

    <script>        .legend-color {            flex-wrap: wrap;            margin: 0.25rem 0;

        let map;

        let markers = [];            width: 20px;

        let allMembers = [];

            height: 20px;            gap: 20px;            color: #666;

        function initMap() {

            map = L.map('map').setView([37.5407, -77.4360], 9);            border-radius: 50%;

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

                attribution: '¬© OpenStreetMap contributors',            margin-right: 10px;        }            font-size: 0.85rem;

                maxZoom: 18

            }).addTo(map);            border: 2px solid #333;

        }

        }        }

        function showProgress(show, percent, text) {

            const progressBar = document.getElementById('progressBar');

            const progressFill = document.getElementById('progressFill');

            const progressText = document.getElementById('progressText');        .back-link {        .stat-item {        .loading {

            

            if (show) {            display: inline-block;

                progressBar.style.display = 'block';

                progressFill.style.width = percent + '%';            color: #003366;            text-align: center;            position: absolute;

                progressFill.textContent = Math.round(percent) + '%';

                progressText.textContent = text;            text-decoration: none;

            } else {

                progressBar.style.display = 'none';            font-weight: 600;        }            top: 50%;

            }

        }            margin-bottom: 10px;



        async function geocodeAddress(city, state, zip) {            padding: 8px 15px;            left: 50%;

            try {

                let query = '';            background: white;

                if (city && state && zip) {

                    query = `${city}, ${state} ${zip}, USA`;            border-radius: 5px;        .stat-number {            transform: translate(-50%, -50%);

                } else if (city && state) {

                    query = `${city}, ${state}, USA`;        }

                } else if (zip) {

                    query = `${zip}, USA`;            font-size: 32px;            background: white;

                } else {

                    return null;        .back-link:hover {

                }

            background: #f0f0f0;            font-weight: bold;            padding: 2rem;

                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;

                const response = await fetch(url, {        }

                    headers: { 'User-Agent': 'CVAWVUAA-Member-Map/1.0' }

                });            color: #EAAA00;            border-radius: 12px;

                const data = await response.json();

                        .progress {

                if (data && data.length > 0) {

                    return {            background: white;        }            box-shadow: 0 4px 15px rgba(0,0,0,0.2);

                        lat: parseFloat(data[0].lat),

                        lng: parseFloat(data[0].lon)            padding: 20px;

                    };

                }            border-radius: 8px;            z-index: 2000;

                return null;

            } catch (error) {            margin-top: 15px;

                console.error('Geocoding error:', error);

                return null;            text-align: center;        .stat-label {            text-align: center;

            }

        }        }



        function createMarker(member, coords) {            font-size: 14px;        }

            const color = member.status === 'active' ? '#00cc00' : '#ff6600';

                    .progress-bar {

            const marker = L.circleMarker([coords.lat, coords.lng], {

                radius: 8,            width: 100%;            color: #666;        .loading.hide {

                fillColor: color,

                color: '#333',            height: 30px;

                weight: 2,

                opacity: 1,            background: #f0f0f0;            margin-top: 5px;            display: none;

                fillOpacity: 0.8

            });            border-radius: 15px;



            const popupContent = `            overflow: hidden;        }        }

                <div style="min-width: 200px;">

                    <h3 style="margin: 0 0 10px 0; color: #003366;">${member.name}</h3>            margin-bottom: 10px;

                    <p style="margin: 5px 0;"><strong>Status:</strong> ${member.status}</p>

                    <p style="margin: 5px 0;"><strong>Type:</strong> ${member.membershipType}</p>        }    </style>

                    <p style="margin: 5px 0;"><strong>Location:</strong> ${member.city}, ${member.state} ${member.zip}</p>

                    ${member.email ? `<p style="margin: 5px 0;"><strong>Email:</strong> ${member.email}</p>` : ''}

                </div>

            `;        .progress-fill {        .map-container {    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />



            marker.bindPopup(popupContent);            height: 100%;

            return marker;

        }            background: linear-gradient(90deg, #EAAA00, #003366);            background: white;</head>



        async function loadMembers() {            transition: width 0.3s;

            try {

                showProgress(true, 0, 'Loading members from database...');            display: flex;            padding: 20px;<body>

                

                const membersRef = db.collection('members');            align-items: center;

                const snapshot = await membersRef.get();

            justify-content: center;            border-radius: 10px;    <div class="header">

                allMembers = [];

                snapshot.forEach(doc => {            color: white;

                    const data = doc.data();

                    allMembers.push({            font-weight: bold;            box-shadow: 0 4px 6px rgba(0,0,0,0.1);        <h1>üó∫Ô∏è Member Map</h1>

                        id: doc.id,

                        name: data.name || 'Unknown',        }

                        status: data.status || 'inactive',

                        membershipType: data.membershipType || 'Individual - $25/yr',    </style>            margin-bottom: 20px;        <p>Central Virginia Chapter Members</p>

                        city: data.city || '',

                        state: data.state || 'VA',</head>

                        zip: data.zip || '',

                        email: data.email || ''<body>        }    </div>

                    });

                });    <div class="container">



                updateStats();        <a href="/admin/member-database.html" class="back-link">‚Üê Back to Member Database</a>    

                await mapMembers();

            } catch (error) {        

                console.error('Error loading members:', error);

                alert('Error loading member data: ' + error.message);        <div class="header">        #map {    <div class="stats">

            }

        }            <h1>üìç Member Geographic Distribution</h1>



        async function mapMembers() {            <p class="subtitle">Central Virginia Chapter - WVU Alumni Association</p>            height: 600px;        <h3>üìä Statistics</h3>

            markers.forEach(marker => marker.remove());

            markers = [];        </div>



            let mappedCount = 0;            width: 100%;        <p><strong>Total Members:</strong> <span id="totalMembers">0</span></p>

            const bounds = [];

            const total = allMembers.length;        <div class="stats-bar">



            for (let i = 0; i < total; i++) {            <div class="stat-item">            border-radius: 8px;        <p><strong>Mapped:</strong> <span id="mappedMembers">0</span></p>

                const member = allMembers[i];

                                <div class="stat-number" id="totalMembers">0</div>

                const coords = await geocodeAddress(member.city, member.state, member.zip);

                                <div class="stat-label">Total Members</div>            border: 2px solid #003366;        <p><strong>Richmond Area:</strong> <span id="richmondCount">0</span></p>

                if (coords) {

                    const marker = createMarker(member, coords);            </div>

                    marker.addTo(map);

                    markers.push(marker);            <div class="stat-item">        }        <p><strong>Other Areas:</strong> <span id="otherCount">0</span></p>

                    bounds.push([coords.lat, coords.lng]);

                    mappedCount++;                <div class="stat-number" id="activeMembers">0</div>

                }

                <div class="stat-label">Active Members</div>    </div>

                const percent = ((i + 1) / total) * 100;

                showProgress(true, percent, `Mapped ${mappedCount} of ${i + 1} members...`);            </div>



                if (i < total - 1) {            <div class="stat-item">        .legend {    

                    await new Promise(resolve => setTimeout(resolve, 1000));

                }                <div class="stat-number" id="mappedMembers">0</div>

            }

                <div class="stat-label">Mapped Locations</div>            background: white;    <div id="loading" class="loading">

            showProgress(false);

            </div>

            if (bounds.length > 0) {

                map.fitBounds(bounds, { padding: [50, 50] });            <div class="stat-item">            padding: 15px;        <h2 style="color: #002855; margin: 0 0 1rem;">Loading Members...</h2>

            }

                <div class="stat-number" id="statesCount">0</div>

            document.getElementById('mappedMembers').textContent = mappedCount;

        }                <div class="stat-label">States</div>            border-radius: 8px;        <p style="color: #666;">Geocoding addresses...</p>



        function updateStats() {            </div>

            const total = allMembers.length;

            const active = allMembers.filter(m => m.status === 'active').length;        </div>            box-shadow: 0 2px 4px rgba(0,0,0,0.1);    </div>

            const states = new Set(allMembers.map(m => m.state).filter(s => s));



            document.getElementById('totalMembers').textContent = total;

            document.getElementById('activeMembers').textContent = active;        <div class="map-container">            margin-top: 15px;    

            document.getElementById('statesCount').textContent = states.size;

        }            <div id="map"></div>



        initMap();                    }    <div id="map"></div>

        loadMembers();

    </script>            <div class="progress" id="progressBar" style="display: none;">

</body>

</html>                <div class="progress-bar">


                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>

                </div>        .legend h3 {    <!-- Firebase SDK -->

                <div id="progressText">Loading members...</div>

            </div>            color: #003366;    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>

            

            <div class="legend">            font-size: 16px;    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

                <h3>Legend</h3>

                <div class="legend-item">            margin-bottom: 10px;    <script src="/admin/js/firebase-config.js"></script>

                    <div class="legend-color" style="background: #00cc00;"></div>

                    <span>Active Members</span>        }    

                </div>

                <div class="legend-item">    <!-- Leaflet (OpenStreetMap) -->

                    <div class="legend-color" style="background: #ff6600;"></div>

                    <span>Inactive Members</span>        .legend-item {    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

                </div>

            </div>            display: flex;

        </div>

    </div>            align-items: center;    <script>



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>            margin-bottom: 8px;        // Initialize map centered on Richmond, VA

    <script src="/js/firebase-config.js"></script>

    <script>        }        const map = L.map('map').setView([37.5407, -77.4360], 10);

        let map;

        let markers = [];        

        let allMembers = [];

        .legend-color {        // Add OpenStreetMap tiles

        // Initialize map

        function initMap() {            width: 20px;        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

            map = L.map('map').setView([37.5407, -77.4360], 9);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {            height: 20px;            attribution: '¬© OpenStreetMap contributors',

                attribution: '¬© OpenStreetMap contributors',

                maxZoom: 18            border-radius: 50%;            maxZoom: 19

            }).addTo(map);

        }            margin-right: 10px;        }).addTo(map);



        // Show progress            border: 2px solid #333;        

        function showProgress(show, percent, text) {

            const progressBar = document.getElementById('progressBar');        }        let totalMembers = 0;

            const progressFill = document.getElementById('progressFill');

            const progressText = document.getElementById('progressText');        let mappedMembers = 0;

            

            if (show) {        .loading {        let richmondCount = 0;

                progressBar.style.display = 'block';

                progressFill.style.width = percent + '%';            text-align: center;        let otherCount = 0;

                progressFill.textContent = Math.round(percent) + '%';

                progressText.textContent = text;            padding: 40px;        

            } else {

                progressBar.style.display = 'none';            color: #666;        // Custom small pin-shaped marker

            }

        }        }        const wvuIcon = L.divIcon({



        // Geocode address            className: 'custom-marker',

        async function geocodeAddress(city, state, zip) {

            try {        .error {            html: `

                let query = '';

                if (city && state && zip) {            background: #fee;                <svg width="16" height="22" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">

                    query = `${city}, ${state} ${zip}, USA`;

                } else if (city && state) {            color: #c33;                    <!-- Pin shape -->

                    query = `${city}, ${state}, USA`;

                } else if (zip) {            padding: 15px;                    <path d="M15,0 C6.716,0 0,6.716 0,15 C0,25 15,40 15,40 C15,40 30,25 30,15 C30,6.716 23.284,0 15,0 Z" 

                    query = `${zip}, USA`;

                } else {            border-radius: 8px;                          fill="#dc3545" stroke="#8b0000" stroke-width="1"/>

                    return null;

                }            margin: 20px 0;                    <!-- Inner circle -->



                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;        }                    <circle cx="15" cy="15" r="6" fill="white" opacity="0.9"/>

                const response = await fetch(url, {

                    headers: { 'User-Agent': 'CVAWVUAA-Member-Map/1.0' }                </svg>

                });

                const data = await response.json();        .controls {            `,

                

                if (data && data.length > 0) {            background: white;            iconSize: [16, 22],

                    return {

                        lat: parseFloat(data[0].lat),            padding: 15px 30px;            iconAnchor: [8, 22],

                        lng: parseFloat(data[0].lon)

                    };            border-radius: 10px;            popupAnchor: [0, -22]

                }

                return null;            box-shadow: 0 4px 6px rgba(0,0,0,0.1);        });

            } catch (error) {

                console.error('Geocoding error:', error);            margin-bottom: 20px;        

                return null;

            }        }        async function geocodeAddress(address, city, state, zip) {

        }

            // Build full address - use ZIP to help determine location

        // Create marker

        function createMarker(member, coords) {        .control-group {            const fullAddress = zip ? 

            const color = member.status === 'active' ? '#00cc00' : '#ff6600';

                        display: flex;                `${address}, ${city}, ${zip}` : 

            const marker = L.circleMarker([coords.lat, coords.lng], {

                radius: 8,            gap: 15px;                `${address}, ${city}`;

                fillColor: color,

                color: '#333',            flex-wrap: wrap;            

                weight: 2,

                opacity: 1,            align-items: center;            try {

                fillOpacity: 0.8

            });        }                // Use Nominatim (OpenStreetMap) geocoding service



            const popupContent = `                const response = await fetch(

                <div style="min-width: 200px;">

                    <h3 style="margin: 0 0 10px 0; color: #003366;">${member.name}</h3>        .control-group label {                    `https://nominatim.openstreetmap.org/search?` + 

                    <p style="margin: 5px 0;"><strong>Status:</strong> ${member.status}</p>

                    <p style="margin: 5px 0;"><strong>Type:</strong> ${member.membershipType}</p>            font-weight: 600;                    `q=${encodeURIComponent(fullAddress)}&format=json&limit=1&countrycodes=us`,

                    <p style="margin: 5px 0;"><strong>Location:</strong> ${member.city}, ${member.state} ${member.zip}</p>

                    ${member.email ? `<p style="margin: 5px 0;"><strong>Email:</strong> ${member.email}</p>` : ''}            color: #003366;                    {

                </div>

            `;        }                        headers: {



            marker.bindPopup(popupContent);                            'User-Agent': 'CVCWVUAA Member Map'

            return marker;

        }        .control-group select {                        }



        // Load members            padding: 8px 12px;                    }

        async function loadMembers() {

            try {            border: 2px solid #003366;                );

                showProgress(true, 0, 'Loading members from database...');

                            border-radius: 5px;                

                const membersRef = db.collection('members');

                const snapshot = await membersRef.get();            font-size: 14px;                // Check for rate limiting



                allMembers = [];            background: white;                if (response.status === 429) {

                snapshot.forEach(doc => {

                    const data = doc.data();            cursor: pointer;                    console.warn('Rate limited, waiting 5 seconds...');

                    allMembers.push({

                        id: doc.id,        }                    await new Promise(resolve => setTimeout(resolve, 5000));

                        name: data.name || 'Unknown',

                        status: data.status || 'inactive',                    return await geocodeAddress(address, city, state, zip); // Retry

                        membershipType: data.membershipType || 'Individual - $25/yr',

                        city: data.city || '',        .back-link {                }

                        state: data.state || 'VA',

                        zip: data.zip || '',            display: inline-block;                

                        email: data.email || ''

                    });            color: #003366;                const data = await response.json();

                });

            text-decoration: none;                

                updateStats();

                await mapMembers();            font-weight: 600;                if (data && data.length > 0) {

            } catch (error) {

                console.error('Error loading members:', error);            margin-bottom: 10px;                    return {

                alert('Error loading member data: ' + error.message);

            }            padding: 8px 15px;                        lat: parseFloat(data[0].lat),

        }

            background: white;                        lng: parseFloat(data[0].lon),

        // Map members

        async function mapMembers() {            border-radius: 5px;                        display_name: data[0].display_name // Full address from geocoder

            markers.forEach(marker => marker.remove());

            markers = [];            transition: background 0.3s;                    };



            let mappedCount = 0;        }                }

            const bounds = [];

            const total = allMembers.length;                



            for (let i = 0; i < total; i++) {        .back-link:hover {                console.warn(`No coordinates found for: ${fullAddress}`);

                const member = allMembers[i];

                            background: #f0f0f0;                return null;

                const coords = await geocodeAddress(member.city, member.state, member.zip);

                        }            } catch (error) {

                if (coords) {

                    const marker = createMarker(member, coords);                console.error('Geocoding error for', fullAddress, ':', error);

                    marker.addTo(map);

                    markers.push(marker);        .progress {                return null;

                    bounds.push([coords.lat, coords.lng]);

                    mappedCount++;            background: white;            }

                }

            padding: 20px;        }

                const percent = ((i + 1) / total) * 100;

                showProgress(true, percent, `Mapped ${mappedCount} of ${i + 1} members...`);            border-radius: 8px;        



                // Rate limiting            margin-top: 15px;        async function loadMembers() {

                if (i < total - 1) {

                    await new Promise(resolve => setTimeout(resolve, 1000));            display: none;            try {

                }

            }        }                const membersSnapshot = await db.collection('members').get();



            showProgress(false);                totalMembers = membersSnapshot.size;



            if (bounds.length > 0) {        .progress.active {                

                map.fitBounds(bounds, { padding: [50, 50] });

            }            display: block;                const members = [];



            document.getElementById('mappedMembers').textContent = mappedCount;        }                membersSnapshot.forEach(doc => {

        }

                    const memberData = doc.data();

        // Update stats

        function updateStats() {        .progress-bar {                    

            const total = allMembers.length;

            const active = allMembers.filter(m => m.status === 'active').length;            width: 100%;                    // Skip test accounts

            const states = new Set(allMembers.map(m => m.state).filter(s => s));

            height: 30px;                    const email = (memberData.email || '').toLowerCase();

            document.getElementById('totalMembers').textContent = total;

            document.getElementById('activeMembers').textContent = active;            background: #f0f0f0;                    const name = (memberData.name || '').toLowerCase();

            document.getElementById('statesCount').textContent = states.size;

        }            border-radius: 15px;                    const isTest = email.includes('test') || name.includes('test') || name === 'santa claus';



        // Initialize            overflow: hidden;                    

        initMap();

        loadMembers();            margin-bottom: 10px;                    if (!isTest && memberData.address && memberData.city) {

    </script>

</body>        }                        console.log(`Adding member: ${memberData.name}, City: ${memberData.city}, ZIP: ${memberData.zip}`);

</html>

                        members.push({

        .progress-fill {                            id: doc.id,

            height: 100%;                            name: memberData.name,

            background: linear-gradient(90deg, #EAAA00, #003366);                            address: memberData.address,

            transition: width 0.3s;                            city: memberData.city,

            display: flex;                            state: memberData.state || '', // May not exist

            align-items: center;                            zip: memberData.zip || '',

            justify-content: center;                            status: memberData.status || 'unknown'

            color: white;                        });

            font-weight: bold;                    }

        }                });

                

        .progress-text {                console.log(`Found ${members.length} members with addresses`);

            text-align: center;                

            color: #666;                // Geocode and add markers

            font-size: 14px;                const markers = [];

        }                let processed = 0;

    </style>                

</head>                for (const member of members) {

<body>                    processed++;

    <div class="container">                    console.log(`Processing ${processed}/${members.length}: ${member.name} - ${member.city}, ${member.state}`);

        <a href="/admin/member-database.html" class="back-link">‚Üê Back to Member Database</a>                    

                            try {

        <div class="header">                        const coords = await geocodeAddress(

            <h1>üìç Member Geographic Distribution</h1>                            member.address, 

            <p class="subtitle">Central Virginia Chapter - WVU Alumni Association</p>                            member.city, 

        </div>                            member.state, 

                            member.zip

        <div class="stats-bar">                        );

            <div class="stat-item">                        

                <div class="stat-number" id="totalMembers">0</div>                        if (coords) {

                <div class="stat-label">Total Members</div>                            // Add marker

            </div>                            const marker = L.marker([coords.lat, coords.lng], { icon: wvuIcon })

            <div class="stat-item">                                .addTo(map);

                <div class="stat-number" id="activeMembers">0</div>                            

                <div class="stat-label">Active Members</div>                            markers.push(marker);

            </div>                            

            <div class="stat-item">                            // Extract state from geocoded address

                <div class="stat-number" id="mappedMembers">0</div>                            const locationParts = coords.display_name ? coords.display_name.split(', ') : [];

                <div class="stat-label">Mapped Locations</div>                            const detectedState = locationParts.length > 2 ? locationParts[locationParts.length - 2] : 'Unknown';

            </div>                            

            <div class="stat-item">                            // Add popup

                <div class="stat-number" id="statesCount">0</div>                            marker.bindPopup(`

                <div class="stat-label">States Represented</div>                                <div style="font-family: sans-serif;">

            </div>                                    <h3 style="margin: 0 0 0.5rem; color: #002855;">${member.name}</h3>

        </div>                                    <p style="margin: 0.25rem 0; font-size: 0.9rem;">

                                        üìç ${member.city}, ${detectedState}

        <div class="controls">                                    </p>

            <div class="control-group">                                    <p style="margin: 0.25rem 0; font-size: 0.85rem; color: #666;">

                <label for="statusFilter">Filter by Status:</label>                                        Status: ${member.status}

                <select id="statusFilter">                                    </p>

                    <option value="all">All Members</option>                                </div>

                    <option value="active">Active Only</option>                            `);

                    <option value="inactive">Inactive Only</option>                            

                </select>                            mappedMembers++;

                                            

                <label for="membershipFilter">Filter by Type:</label>                            // Count Richmond area vs others

                <select id="membershipFilter">                            const richmondCities = ['richmond', 'henrico', 'glen allen', 'mechanicsville', 'midlothian', 'chesterfield'];

                    <option value="all">All Types</option>                            if (richmondCities.some(city => member.city.toLowerCase().includes(city))) {

                    <option value="Individual - $25/yr">Individual</option>                                richmondCount++;

                    <option value="Family - $40/yr">Family</option>                            } else {

                </select>                                otherCount++;

            </div>                            }

        </div>                            

                            updateStats();

        <div class="map-container">                        } else {

            <div id="map"></div>                            console.log(`Failed to geocode: ${member.name} - ${member.address}, ${member.city}, ${member.state}`);

                                    }

            <div class="progress" id="progressBar">                        

                <div class="progress-bar">                        // Longer delay to avoid rate limiting (2 seconds between requests)

                    <div class="progress-fill" id="progressFill">0%</div>                        await new Promise(resolve => setTimeout(resolve, 2000));

                </div>                        

                <div class="progress-text" id="progressText">Loading members...</div>                    } catch (error) {

            </div>                        console.error(`Error processing ${member.name}:`, error);

                                    // Continue with next member even if this one fails

            <div class="legend">                        continue;

                <h3>Legend</h3>                    }

                <div class="legend-item">                }

                    <div class="legend-color" style="background: #00cc00;"></div>                

                    <span>Active Members</span>                // Hide loading

                </div>                document.getElementById('loading').classList.add('hide');

                <div class="legend-item">                

                    <div class="legend-color" style="background: #ff6600;"></div>                // Fit map to show all markers

                    <span>Inactive Members</span>                if (markers.length > 0) {

                </div>                    const group = new L.featureGroup(markers);

                <div class="legend-item">                    map.fitBounds(group.getBounds().pad(0.1));

                    <div class="legend-color" style="background: #EAAA00;"></div>                }

                    <span>Multiple Members (Cluster)</span>                

                </div>                console.log(`Mapped ${mappedMembers} out of ${members.length} members`);

            </div>                

        </div>            } catch (error) {

    </div>                console.error('Error loading members:', error);

                alert('Error loading member data. Check console for details.');

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>            }

    <script src="/js/firebase-config.js"></script>        }

    <script>        

        let map;        function updateStats() {

        let markers = [];            document.getElementById('totalMembers').textContent = totalMembers;

        let allMembers = [];            document.getElementById('mappedMembers').textContent = mappedMembers;

            document.getElementById('richmondCount').textContent = richmondCount;

        // Initialize map centered on Richmond, VA            document.getElementById('otherCount').textContent = otherCount;

        function initMap() {        }

            map = L.map('map').setView([37.5407, -77.4360], 9);        

        // Load members on page load

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {        loadMembers();

                attribution: '¬© OpenStreetMap contributors',    </script>

                maxZoom: 18</body>

            }).addTo(map);</html>

        }

        // Show/hide progress bar
        function showProgress(show, percent = 0, text = '') {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (show) {
                progressBar.classList.add('active');
                progressFill.style.width = percent + '%';
                progressFill.textContent = Math.round(percent) + '%';
                progressText.textContent = text;
            } else {
                progressBar.classList.remove('active');
            }
        }

        // Geocode address using Nominatim (OpenStreetMap)
        async function geocodeAddress(address, city, state, zip) {
            try {
                // Build query string
                let query = '';
                if (city && state && zip) {
                    query = `${city}, ${state} ${zip}, USA`;
                } else if (city && state) {
                    query = `${city}, ${state}, USA`;
                } else if (zip) {
                    query = `${zip}, USA`;
                } else {
                    return null;
                }

                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'CVAWVUAA-Member-Map/1.0'
                    }
                });

                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }

                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Add delay to respect rate limiting
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Create marker for member
        function createMarker(member, coords) {
            const color = member.status === 'active' ? '#00cc00' : '#ff6600';
            
            const marker = L.circleMarker([coords.lat, coords.lng], {
                radius: 8,
                fillColor: color,
                color: '#333',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });

            const popupContent = `
                <div style="min-width: 200px;">
                    <h3 style="margin: 0 0 10px 0; color: #003366; font-size: 16px;">${member.name}</h3>
                    <p style="margin: 5px 0;"><strong>Status:</strong> ${member.status}</p>
                    <p style="margin: 5px 0;"><strong>Type:</strong> ${member.membershipType}</p>
                    <p style="margin: 5px 0;"><strong>Location:</strong> ${member.city}, ${member.state} ${member.zip}</p>
                    ${member.email ? `<p style="margin: 5px 0;"><strong>Email:</strong> ${member.email}</p>` : ''}
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.memberData = member;
            
            return marker;
        }

        // Load members from Firebase
        async function loadMembers() {
            try {
                const membersRef = db.collection('members');
                const snapshot = await membersRef.get();

                allMembers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allMembers.push({
                        id: doc.id,
                        name: data.name || 'Unknown',
                        status: data.status || 'inactive',
                        membershipType: data.membershipType || 'Individual - $25/yr',
                        address: data.address || '',
                        city: data.city || '',
                        state: data.state || 'VA',
                        zip: data.zip || '',
                        email: data.email || ''
                    });
                });

                updateStats();
                await mapMembers();
            } catch (error) {
                console.error('Error loading members:', error);
                alert('Error loading member data. Please refresh the page.');
            }
        }

        // Map all members
        async function mapMembers() {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            const statusFilter = document.getElementById('statusFilter').value;
            const membershipFilter = document.getElementById('membershipFilter').value;

            // Filter members
            let filteredMembers = allMembers.filter(member => {
                if (statusFilter !== 'all' && member.status !== statusFilter) return false;
                if (membershipFilter !== 'all' && member.membershipType !== membershipFilter) return false;
                return true;
            });

            let mappedCount = 0;
            const bounds = [];

            showProgress(true, 0, `Mapping 0 of ${filteredMembers.length} members...`);

            for (let i = 0; i < filteredMembers.length; i++) {
                const member = filteredMembers[i];
                
                // Try to geocode
                const coords = await geocodeAddress(member.address, member.city, member.state, member.zip);
                
                if (coords) {
                    const marker = createMarker(member, coords);
                    marker.addTo(map);
                    markers.push(marker);
                    bounds.push([coords.lat, coords.lng]);
                    mappedCount++;
                }

                // Update progress
                const percent = ((i + 1) / filteredMembers.length) * 100;
                showProgress(true, percent, `Mapped ${mappedCount} of ${i + 1} members...`);

                // Rate limiting: wait 1 second between requests
                if (i < filteredMembers.length - 1) {
                    await delay(1000);
                }
            }

            // Hide progress bar
            showProgress(false);

            // Fit map to show all markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            document.getElementById('mappedMembers').textContent = mappedCount;
        }

        // Update statistics
        function updateStats() {
            const total = allMembers.length;
            const active = allMembers.filter(m => m.status === 'active').length;
            const states = new Set(allMembers.map(m => m.state).filter(s => s));

            document.getElementById('totalMembers').textContent = total;
            document.getElementById('activeMembers').textContent = active;
            document.getElementById('statesCount').textContent = states.size;
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', mapMembers);
        document.getElementById('membershipFilter').addEventListener('change', mapMembers);

        // Initialize
        initMap();
        loadMembers();
    </script>
</body>
</html>
