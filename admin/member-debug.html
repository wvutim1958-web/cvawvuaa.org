<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/css/wvu-components.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVCWVUAA Member Data Debug Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #003366;
            margin-bottom: 30px;
            border-bottom: 3px solid #FFD700;
            padding-bottom: 20px;
        }
        
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .member-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #eee;
            background: white;
            border-radius: 3px;
        }
        
        .issue {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .btn {
            background: #003366;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #004080;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 3px;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- WVU Masthead Component -->
    <div id="wvu-masthead"></div>

    <!-- WVU Primary Navigation Component -->
    <div id="wvu-navigation"></div>

    <!-- Back to Dashboard Button -->
    <div class="back-to-dashboard" style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
        <a href="/admin/dashboard.html" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #002855, #1e40af); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <span style="font-size: 1.2rem;">‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>

    <div class="container">
        <div class="header">
            <h1>CVCWVUAA Member Data Debug Tool</h1>
            <p>Identify and fix data issues in the member database</p>
        </div>
        
        <div class="debug-section">
            <h3>Database Summary</h3>
            <div id="summary"></div>
            <button class="btn" onclick="analyzeMemberData()">Analyze Member Data</button>
            <button class="btn btn-success" onclick="fixAddressIssues()">Fix Address Issues</button>
        </div>
        
        <div class="debug-section">
            <h3>Members with Potential Address Issues</h3>
            <div id="addressIssues"></div>
        </div>
        
        <div class="debug-section">
            <h3>Members with Name Issues</h3>
            <div id="nameIssues"></div>
        </div>
        
        <div class="debug-section">
            <h3>Sample Member Data</h3>
            <div id="sampleData"></div>
        </div>
    </div>

    <script>
        function getMembers() {
            const memberKeys = ['cvcwvuaa-members', 'cvcwvuaa_members', 'members', 'memberData'];
            for (const key of memberKeys) {
                const members = JSON.parse(localStorage.getItem(key) || '[]');
                if (members.length > 0) {
                    console.log(`Found ${members.length} members in localStorage key: ${key}`);
                    return { members, key };
                }
            }
            return { members: [], key: null };
        }

        function analyzeMemberData() {
            const { members, key } = getMembers();
            
            if (members.length === 0) {
                document.getElementById('summary').innerHTML = '<div class="issue">No members found in database</div>';
                return;
            }
            
            // Summary
            document.getElementById('summary').innerHTML = `
                <div><strong>Total Members:</strong> ${members.length}</div>
                <div><strong>Database Key:</strong> ${key}</div>
                <div><strong>Last Updated:</strong> ${new Date().toLocaleString()}</div>
            `;
            
            // Find address issues
            const addressIssues = [];
            const nameIssues = [];
            
            members.forEach((member, index) => {
                // Check for names in address fields
                const addressFields = [member.streetAddress, member.city, member.state, member.address, member.fullAddress];
                const hasNameInAddress = addressFields.some(field => {
                    if (!field) return false;
                    const field_lower = field.toLowerCase();
                    // Look for typical last name patterns
                    return /^[A-Z][a-z]+$/.test(field.trim()) && field.length > 2 && field.length < 20;
                });
                
                if (hasNameInAddress) {
                    addressIssues.push({ index, member, issue: 'Possible name in address field' });
                }
                
                // Check for incomplete names
                if (!member.name || member.name.split(' ').length < 2) {
                    nameIssues.push({ index, member, issue: 'Incomplete or missing name' });
                }
            });
            
            // Display address issues
            if (addressIssues.length > 0) {
                document.getElementById('addressIssues').innerHTML = 
                    addressIssues.map(item => `
                        <div class="member-item issue">
                            <strong>Member ${item.index + 1}:</strong> ${item.member.name || 'No name'}<br>
                            <strong>Email:</strong> ${item.member.email || 'No email'}<br>
                            <strong>Street:</strong> ${item.member.streetAddress || 'None'}<br>
                            <strong>City:</strong> ${item.member.city || 'None'}<br>
                            <strong>State:</strong> ${item.member.state || 'None'}<br>
                            <strong>Address:</strong> ${item.member.address || 'None'}<br>
                            <strong>Issue:</strong> ${item.issue}
                        </div>
                    `).join('');
            } else {
                document.getElementById('addressIssues').innerHTML = '<div>No address issues found</div>';
            }
            
            // Display name issues
            if (nameIssues.length > 0) {
                document.getElementById('nameIssues').innerHTML = 
                    nameIssues.map(item => `
                        <div class="member-item issue">
                            <strong>Member ${item.index + 1}:</strong> ${item.member.name || 'No name'}<br>
                            <strong>Email:</strong> ${item.member.email || 'No email'}<br>
                            <strong>First Name:</strong> ${item.member.firstName || 'None'}<br>
                            <strong>Last Name:</strong> ${item.member.lastName || 'None'}<br>
                            <strong>Issue:</strong> ${item.issue}
                        </div>
                    `).join('');
            } else {
                document.getElementById('nameIssues').innerHTML = '<div>No name issues found</div>';
            }
            
            // Show sample data
            const sampleMembers = members.slice(0, 3);
            document.getElementById('sampleData').innerHTML = 
                sampleMembers.map((member, index) => `
                    <div class="member-item">
                        <strong>Sample Member ${index + 1}:</strong>
                        <pre>${JSON.stringify(member, null, 2)}</pre>
                    </div>
                `).join('');
        }
        
        function fixAddressIssues() {
            const { members, key } = getMembers();
            
            if (members.length === 0) {
                alert('No members found to fix');
                return;
            }
            
            let fixedCount = 0;
            
            members.forEach(member => {
                // Check if last name is in address field and move it back to name
                if (member.streetAddress && /^[A-Z][a-z]+$/.test(member.streetAddress.trim()) && member.streetAddress.length < 15) {
                    // This might be a last name
                    if (member.name && !member.name.includes(member.streetAddress)) {
                        // Add to name if not already there
                        member.name += ' ' + member.streetAddress;
                        member.streetAddress = '';
                        fixedCount++;
                    }
                }
                
                // Similar check for city field
                if (member.city && /^[A-Z][a-z]+$/.test(member.city.trim()) && member.city.length < 15) {
                    if (member.name && !member.name.includes(member.city)) {
                        member.name += ' ' + member.city;
                        member.city = '';
                        fixedCount++;
                    }
                }
                
                // Clean up empty address fields
                if (member.streetAddress === '') delete member.streetAddress;
                if (member.city === '') delete member.city;
                if (member.state === '') delete member.state;
                if (member.zip === '') delete member.zip;
                if (member.address === '') delete member.address;
            });
            
            if (fixedCount > 0) {
                // Save back to localStorage
                localStorage.setItem(key, JSON.stringify(members));
                alert(`Fixed ${fixedCount} address issues. Please refresh the member management system.`);
                
                // Re-analyze
                analyzeMemberData();
            } else {
                alert('No address issues found to fix');
            }
        }
        
        // Auto-analyze on load
        window.addEventListener('load', analyzeMemberData);
    </script>
    <!-- WVU Footer Component -->
    <div id="wvu-footer"></div>

    <!-- Load WVU Components -->
    <script src="/includes/component-loader.min.js"></script>
</body>
</html>